# Story 2.7: Text Diff Generation

## Status
Ready for Review

## Story
**As a** developer,  
**I want** text diff generation using Python difflib,  
**so that** I can show exactly what changed between policy versions.

## Acceptance Criteria

1. When change detected, generate diff using `difflib.unified_diff()` or `difflib.HtmlDiff()`
2. Diff compares: previous PolicyVersion.raw_text vs new PolicyVersion.raw_text
3. Diff output stored as text in PolicyChange.diff field
4. Diff includes context lines (configurable, default 3 lines)
5. Diff format is human-readable (unified diff or HTML diff)
6. Handles large documents efficiently (no memory issues)
7. Unit tests with sample text changes:
   - Added text
   - Removed text
   - Modified text
   - Multiple changes
8. Integration test: create PolicyChange record with diff when change detected
9. Helper function to retrieve PolicyChange with formatted diff for display

## Tasks / Subtasks

- [x] Task 1: Create diff generation service (AC: 1, 2, 3, 4, 5)
  - [x] Create `api/services/diff_generator.py`
  - [x] Implement `generate_diff(old_text: str, new_text: str, context_lines: int = 3) -> str` function
  - [x] Use `difflib.unified_diff()` for text diff:
    - [x] Compare old_text vs new_text
    - [x] Include context lines (configurable, default 3)
    - [x] Return unified diff format string
  - [x] Optionally support `difflib.HtmlDiff()` for HTML output (future use)
  - [x] Ensure diff is human-readable
- [x] Task 2: Optimize for large documents (AC: 6)
  - [x] Process text in chunks if very large
  - [x] Use efficient diff algorithm
  - [x] Limit diff size if extremely large (truncate with note)
  - [x] Test with large documents (100KB+)
  - [x] Ensure no memory issues
- [x] Task 3: Integrate with change detection (AC: 1, 2, 3)
  - [x] Call diff generation when change detected
  - [x] Retrieve old and new PolicyVersion text
  - [x] Generate diff
  - [x] Store diff in PolicyChange record (will be created in Story 2.8)
- [x] Task 4: Create unit tests (AC: 7)
  - [x] Create `tests/unit/test_services/test_diff_generator.py`
  - [x] Test added text:
    - [x] Generate diff for text addition
    - [x] Verify diff shows addition correctly
  - [x] Test removed text:
    - [x] Generate diff for text removal
    - [x] Verify diff shows removal correctly
  - [x] Test modified text:
    - [x] Generate diff for text modification
    - [x] Verify diff shows modification correctly
  - [x] Test multiple changes:
    - [x] Generate diff for multiple changes
    - [x] Verify all changes shown
  - [x] Test context lines:
    - [x] Verify context lines included
    - [x] Test with different context line counts
- [x] Task 5: Create integration test (AC: 8)
  - [x] Create `tests/integration/test_pipeline/test_diff_generation.py`
  - [x] Test: change detected → diff generated → PolicyChange created
  - [x] Verify diff is stored correctly
  - [x] Verify diff format is readable
- [x] Task 6: Add helper function for diff retrieval (AC: 9)
  - [x] Update `api/repositories/policy_change_repository.py` or create service method
  - [x] Implement `get_change_with_formatted_diff(change_id: UUID) -> PolicyChangeWithDiff`
  - [x] Return PolicyChange with formatted diff for display
  - [x] Optionally format diff for HTML display (future use)

## Dev Notes

### Previous Story Insights
- Story 2.6 created change detection service
- Story 1.3 created PolicyVersion repository with text retrieval
- Story 1.2 created PolicyChange database model (diff field exists)
- Change detection triggers diff generation when change detected

### Components Architecture
[Source: architecture/components.md]

**Diff Generator:**
- Generates text diffs showing what changed between policy versions
- Uses Python `difflib` for diff generation
- Stores diff in PolicyChange record

**Key Interfaces:**
- `generate_diff(old_text, new_text, context_lines)` - Generates text diff
  - Returns: diff string in unified diff format

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/diff_generator.py` - Diff generation logic
- `tests/unit/test_services/test_diff_generator.py` - Unit tests
- `tests/integration/test_pipeline/test_diff_generation.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Type Hints:** All Python functions must have type hints.

**Performance:** Diff generation must handle large documents efficiently.

**Error Handling:** Handle edge cases (empty text, very large diffs) gracefully.

### Tech Stack
[Source: architecture/tech-stack.md]

**Dependencies:**
- Python standard library `difflib` (no additional dependencies)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test diff generation with various text changes
- Test context lines
- Test large documents

**Integration Tests:**
- Test full flow: change detected → diff generated → stored

### Technical Constraints
- Must use Python `difflib` library
- Must handle large documents efficiently
- Must produce human-readable diff format
- Must include configurable context lines
- Diff stored as text in PolicyChange.diff field

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_diff_generator.py` and `tests/integration/test_pipeline/test_diff_generation.py`

**Test Standards:**
- Use pytest framework
- Test files follow `test_*.py` naming convention
- Include sample text changes in tests

**Testing Frameworks:**
- pytest 7.4+ with async support

**Specific Testing Requirements:**
- Test diff generation for added text
- Test diff generation for removed text
- Test diff generation for modified text
- Test diff generation for multiple changes
- Test context lines configuration
- Test large document handling
- Test integration: change detected → diff generated → stored

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-27 | 1.1 | Story implementation completed | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Created `api/services/diff_generator.py` with `generate_diff()` function using `difflib.unified_diff()`
- Implemented `generate_html_diff()` function for future HTML output support
- Added optimization for large documents: reduces context lines for documents > 5MB, truncates diffs > 10MB with note
- Integrated diff generation into `change_detector.py` - automatically generates diff when change detected
- Updated `ChangeDetectionResult` dataclass to include `diff` field
- Created comprehensive unit tests covering all text change scenarios (added, removed, modified, multiple changes)
- Created integration tests verifying diff generation in full pipeline and PolicyChange creation
- Added `get_change_with_formatted_diff()` method to PolicyChangeRepository for retrieving PolicyChange with diff ready for display
- All acceptance criteria met: diff uses difflib, compares PolicyVersion texts, stored in PolicyChange.diff, includes context lines, human-readable format, handles large documents efficiently

### File List
**Created:**
- `api/services/diff_generator.py` - Diff generation service with unified diff and HTML diff support
- `tests/unit/test_services/test_diff_generator.py` - Unit tests for diff generation
- `tests/integration/test_pipeline/test_diff_generation.py` - Integration tests for diff generation in pipeline

**Modified:**
- `api/services/change_detector.py` - Integrated diff generation when change detected, added `diff` field to ChangeDetectionResult
- `api/repositories/policy_change_repository.py` - Added `get_change_with_formatted_diff()` helper method

## QA Results
_To be populated by QA Agent_

