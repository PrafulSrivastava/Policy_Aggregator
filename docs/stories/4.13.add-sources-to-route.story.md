# Story 4.13: Add Sources to a Route

## Status
Ready for Review

## Story
**As a** user,  
**I want** to attach one or more sources to a route,  
**so that** the system can track changes.

## Acceptance Criteria

1. Calls `POST /api/routes/{route_id}/sources` endpoint (if exists) OR uses existing source management
2. Source types are constrained to backend-supported values (html, pdf)
3. UI prevents invalid configurations before submission
4. Form includes: source URL, fetch type (HTML/PDF), check frequency, country, visa type
5. Validation errors surfaced clearly
6. Successful creation updates UI immediately
7. Loading state during submission
8. Error state if API call fails
9. Sources displayed in route detail view (if route detail page exists)
10. Can add multiple sources to a route

## Tasks / Subtasks

- [x] Task 1: Check backend API for route-source association
  - [x] Verify endpoint exists: `POST /api/routes/{route_id}/sources`
  - [x] If not, use `POST /api/sources` with route association in metadata
  - [x] Document API approach
- [x] Task 2: Update sources service (AC: 1)
  - [x] Add `createSource(sourceData)` to `src/services/sources.ts`
  - [x] Add `addSourceToRoute(routeId, sourceData)` if endpoint exists
  - [x] Handle success/error responses
- [x] Task 3: Create add source form component (AC: 4, 5, 9)
  - [x] Create `src/pages/sources/Add.tsx`
  - [x] Form fields:
    - [x] Country dropdown
    - [x] Visa type dropdown
    - [x] Source URL input
    - [x] Fetch type radio buttons (HTML/PDF)
    - [x] Check frequency dropdown (daily, weekly, custom)
    - [x] Source name input (required)
  - [x] Client-side validation
  - [x] Apply design system
- [x] Task 4: Implement source-to-route association (AC: 1, 2, 3)
  - [x] If route context available, pre-fill country/visa type from route
  - [x] Associate source with route on creation (via metadata)
  - [x] Validate source type matches backend support (html, pdf)
  - [x] Validate URL format
- [x] Task 5: Display sources for route (AC: 9)
  - [x] Create route detail page (`src/pages/routes/Detail.tsx`)
  - [x] Fetch sources for route: `GET /api/sources?country={country}&visa_type={visa_type}`
  - [x] Display sources list
  - [x] Show "Add Source" button
- [x] Task 6: Create unit tests (AC: All)
  - [x] Test source creation
  - [x] Test route-source association
  - [x] Test validation
  - [x] Test error handling
- [ ] Task 7: Manual testing (AC: All)
  - [ ] Test adding source to route
  - [ ] Test validation errors
  - [ ] Test invalid source types
  - [ ] Test multiple sources per route

## Dev Notes

### API Specifications
[Source: architecture/api-specification.md]

**Create Source Endpoint:**
- `POST /api/sources` - Create new source
- Request body:
  ```json
  {
    "country": "DE",
    "visaType": "Student",
    "url": "https://example.com/policy",
    "fetchType": "html",
    "checkFrequency": "daily",
    "name": "Source Name"
  }
  ```
- Fetch type: enum ["html", "pdf"]
- Check frequency: enum ["daily", "weekly", "custom"]

**Note:** Backend may not have explicit route-source association endpoint. May need to use source metadata or route filtering.

### Technical Constraints
- Must use backend-supported source types only
- Must validate before submission
- Must handle API errors gracefully

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/pages/sources/Add.test.js`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes
- All implementation tasks completed (Tasks 1-6)
- Task 7 (Manual testing) pending - requires user/QA verification
- All unit tests passing
- Sources are associated with routes implicitly by matching country/visa_type
- Route detail page created to display sources for a route
- Sources can be added from route context (pre-fills country/visa_type)
- Route_id stored in source metadata for explicit tracking
- Form validation includes URL format, required fields, and backend constraints
- Follows design system with proper error handling and loading states

### API Approach Documentation
**Finding:** No explicit `POST /api/routes/{route_id}/sources` endpoint exists.

**Solution:** 
- Sources are associated with routes implicitly by matching:
  - `source.country == route.destination_country`
  - `source.visa_type == route.visa_type`
- Use `POST /api/sources` to create sources
- Store `route_id` in source `metadata` for explicit tracking
- Filter sources for route using: `GET /api/sources?country={country}&visa_type={visa_type}`

### File List
**New Files:**
- `frontend/src/services/sources.ts` - Sources service with createSource, getSources, getSourcesForRoute, addSourceToRoute
- `frontend/src/pages/sources/Add.tsx` - Add source form page
- `frontend/src/pages/routes/Detail.tsx` - Route detail page showing sources
- `frontend/src/components/forms/Radio.tsx` - Radio button component
- `frontend/src/__tests__/services/sources.test.ts` - Unit tests for sources service
- `frontend/src/__tests__/pages/sources/Add.test.tsx` - Unit tests for Add source page

**Modified Files:**
- `frontend/src/App.tsx` - Added routes for `/routes/:routeId` and `/sources/new`
- `frontend/src/pages/Routes.tsx` - Added "View" button linking to route detail page

### Debug Log References
- No blocking issues encountered
- All TypeScript types properly defined
- All linting checks passed
- Tests passing successfully

## QA Results
_To be populated by QA Agent_

