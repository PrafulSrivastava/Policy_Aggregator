# Story 5.6: Route Expansion Testing & Validation

## Status
Draft

## Story
**As a** developer,  
**I want** to thoroughly test the route expansion functionality,  
**so that** I can ensure new routes work as reliably as the original route.

## Acceptance Criteria

1. End-to-end test for each new route:
   - Source fetch works
   - Change detection works
   - Alerts sent correctly
   - Admin UI displays correctly
2. Test route isolation:
   - Changes on one route don't affect others
   - Route filtering works correctly
   - Alerts sent only to relevant route subscriptions
3. Performance test:
   - Multiple routes don't slow down system
   - Daily job handles all routes efficiently
4. Error handling test:
   - One route failure doesn't break others
   - Graceful degradation works
5. Data integrity test:
   - Route data stored correctly
   - No data corruption or mixing between routes
6. User acceptance test:
   - Admin can configure new routes
   - Admin can view changes for new routes
   - Alerts received correctly for new routes
7. Documentation: Update user guide with multi-route instructions

## Tasks / Subtasks

- [ ] Task 1: Create end-to-end tests for each new route (AC: 1)
  - [ ] Create `tests/integration/test_routes/test_new_route_e2e.py`
  - [ ] For each new route, test:
    - [ ] Source fetch works (run fetcher, verify content extracted)
    - [ ] Change detection works (trigger fetch, verify PolicyChange created)
    - [ ] Alerts sent correctly (verify email sent to route subscription)
    - [ ] Admin UI displays correctly (verify route appears in UI)
  - [ ] Test with both HTML and PDF sources
  - [ ] Test with multiple sources per route
- [ ] Task 2: Test route isolation (AC: 2)
  - [ ] Create `tests/integration/test_routes/test_route_isolation.py`
  - [ ] Test: create route subscriptions for multiple routes
  - [ ] Test: trigger fetch for one route, verify other routes unaffected
  - [ ] Test: verify route filtering works correctly:
    - [ ] Filter by origin country (only shows matching routes)
    - [ ] Filter by destination country (only shows matching routes)
    - [ ] Filter by visa type (only shows matching routes)
  - [ ] Test: verify alerts sent only to relevant route subscriptions:
    - [ ] Create change on Route A
    - [ ] Verify alert sent only to Route A subscription
    - [ ] Verify Route B subscription does not receive alert
- [ ] Task 3: Performance testing (AC: 3)
  - [ ] Create `tests/performance/test_multi_route_performance.py`
  - [ ] Test: run daily job with multiple routes:
    - [ ] Measure execution time
    - [ ] Verify all routes processed
    - [ ] Verify no significant slowdown with multiple routes
  - [ ] Test: concurrent source fetching:
    - [ ] Fetch sources for multiple routes simultaneously
    - [ ] Verify no performance degradation
  - [ ] Test: database query performance:
    - [ ] Query routes with filtering
    - [ ] Query sources with route filtering
    - [ ] Verify query performance is acceptable
- [ ] Task 4: Error handling testing (AC: 4)
  - [ ] Create `tests/integration/test_routes/test_route_error_handling.py`
  - [ ] Test: one route failure doesn't break others:
    - [ ] Configure one source to fail (invalid URL, network error)
    - [ ] Run daily job
    - [ ] Verify other routes still process successfully
    - [ ] Verify error logged but doesn't stop other routes
  - [ ] Test: graceful degradation:
    - [ ] Simulate source fetch failure
    - [ ] Verify system continues processing other sources
    - [ ] Verify error notifications sent (if configured)
    - [ ] Verify system recovers on next run
- [ ] Task 5: Data integrity testing (AC: 5)
  - [ ] Create `tests/integration/test_routes/test_route_data_integrity.py`
  - [ ] Test: route data stored correctly:
    - [ ] Create route subscriptions for multiple routes
    - [ ] Verify data stored with correct origin, destination, visa_type
    - [ ] Verify no data mixing between routes
  - [ ] Test: source data stored correctly:
    - [ ] Create sources for multiple routes
    - [ ] Verify sources stored with correct country, visa_type
    - [ ] Verify route-to-source mapping works correctly
  - [ ] Test: change data stored correctly:
    - [ ] Create changes for multiple routes
    - [ ] Verify PolicyChange records linked to correct sources
    - [ ] Verify no data corruption or mixing
- [ ] Task 6: User acceptance testing (AC: 6)
  - [ ] Manual test: admin can configure new routes:
    - [ ] Access admin UI
    - [ ] Create route subscription for new route
    - [ ] Verify route appears in route list
    - [ ] Verify route can be edited/deleted
  - [ ] Manual test: admin can view changes for new routes:
    - [ ] Access change history page
    - [ ] Filter by new route
    - [ ] Verify changes for new route displayed correctly
    - [ ] Verify change detail/diff view works for new route
  - [ ] Manual test: alerts received correctly for new routes:
    - [ ] Create route subscription for new route with test email
    - [ ] Trigger fetch that detects change
    - [ ] Verify email alert received
    - [ ] Verify email content includes correct route information
- [ ] Task 7: Update documentation (AC: 7)
  - [ ] Update `docs/user-guide.md` or create multi-route guide
  - [ ] Document multi-route functionality:
    - [ ] How to create route subscriptions for multiple routes
    - [ ] How to filter views by route
    - [ ] How to manage multiple routes
  - [ ] Update API documentation with route filtering parameters
  - [ ] Update admin UI documentation with multi-route features

## Dev Notes

### Previous Story Insights
- Story 5.1 researched and documented new route sources
- Story 5.2 implemented source fetchers for new routes
- Story 5.3 configured new routes in database
- Story 5.4 added additional sources for existing routes
- Story 5.5 added multi-route support to admin UI
- Story 2.9 created end-to-end fetch pipeline
- Story 3.4 created alert engine
- Story 3.5 created scheduled job system

### Testing Strategy
[Source: docs/architecture/testing-strategy.md]

**Testing Pyramid:**
- Unit tests: Test individual components
- Integration tests: Test component interactions
- End-to-end tests: Test complete workflows
- Manual tests: User acceptance testing

**Test Organization:**
- `tests/unit/` - Unit tests
- `tests/integration/` - Integration tests
- `tests/performance/` - Performance tests
- `tests/e2e/` - End-to-end tests (optional)

### End-to-End Pipeline
[Source: docs/stories/2.9.end-to-end-fetch-pipeline.story.md]

**Pipeline Flow:**
1. Fetch source content (via fetcher)
2. Normalize content
3. Create PolicyVersion record
4. Compare with previous version (hash comparison)
5. If change detected:
   - Generate text diff
   - Create PolicyChange record
   - Trigger alert engine

**Testing:**
- Test complete flow for each new route
- Verify all steps execute correctly
- Verify error handling works

### Alert System
[Source: docs/stories/3.4.alert-engine-change-detection-to-email-flow.story.md]

**Alert Flow:**
1. PolicyChange detected
2. Get Source from PolicyChange
3. Find matching RouteSubscriptions via RouteMapper
4. Send email alerts to each route subscription
5. Create EmailAlert records

**Testing:**
- Verify alerts sent only to relevant route subscriptions
- Verify route isolation (alerts don't cross routes)

### Route Isolation
[Source: docs/stories/3.1.route-to-source-mapping-logic.story.md]

**Mapping Logic:**
- Routes match sources by destination_country and visa_type
- Origin country not used in matching
- Each route is independent

**Testing:**
- Verify changes on one route don't affect others
- Verify route filtering works correctly
- Verify alerts sent only to relevant routes

### Performance Considerations
[Source: docs/architecture/backend-architecture.md]

**Database Queries:**
- Indexes on (country, visa_type) for efficient route queries
- Indexes on (destination_country, visa_type) for route subscriptions
- Query performance should scale with number of routes

**Daily Job:**
- Processes all active sources
- Should handle multiple routes efficiently
- One route failure shouldn't slow down others

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `tests/integration/test_routes/test_new_route_e2e.py` - End-to-end tests
- `tests/integration/test_routes/test_route_isolation.py` - Route isolation tests
- `tests/performance/test_multi_route_performance.py` - Performance tests
- `tests/integration/test_routes/test_route_error_handling.py` - Error handling tests
- `tests/integration/test_routes/test_route_data_integrity.py` - Data integrity tests

Files to update:
- `docs/user-guide.md` - User guide with multi-route instructions

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Testing:**
- Use `pytest` for all tests
- Use `pytest-asyncio` for async tests
- Use fixtures for test data setup
- Use mocks for external dependencies (email service, etc.)

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Integration Tests:**
- Test complete workflows end-to-end
- Test component interactions
- Use test database (not production)
- Clean up test data after tests

**Performance Tests:**
- Measure execution time
- Verify performance is acceptable
- Test with realistic data volumes

**Manual Testing:**
- User acceptance testing
- Test from admin perspective
- Verify all features work as expected

### Technical Constraints
- Tests must use test database (not production)
- Tests must clean up test data
- Performance tests should use realistic data volumes
- Error handling tests should simulate real failure scenarios

## Testing

**End-to-End Tests:**
- Test complete flow for each new route
- Verify source fetch, change detection, alerts, and UI all work

**Route Isolation Tests:**
- Verify changes on one route don't affect others
- Verify route filtering works correctly
- Verify alerts sent only to relevant routes

**Performance Tests:**
- Test daily job with multiple routes
- Verify no significant slowdown
- Test database query performance

**Error Handling Tests:**
- Test one route failure doesn't break others
- Test graceful degradation
- Test error recovery

**Data Integrity Tests:**
- Verify route data stored correctly
- Verify no data mixing between routes
- Verify route-to-source mapping works correctly

**User Acceptance Tests:**
- Admin can configure new routes
- Admin can view changes for new routes
- Alerts received correctly for new routes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

