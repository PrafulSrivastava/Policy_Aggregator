# Story 4.10: React Frontend Foundation and User Authentication

## Status
Ready for Review

## Story
**As an** authenticated user,  
**I want** to log in using email + password or OAuth (e.g., Google / GitHub),  
**so that** I can securely access the admin interface and all API endpoints.

## Acceptance Criteria

1. React application foundation set up with proper project structure
2. Authentication is mandatory before any API access
3. Auth token is securely stored and attached to all API requests
4. Unauthorized users cannot see routes, sources, or analysis data
5. Frontend must enforce auth gating, not rely on backend errors as UX
6. Login page supports:
   - Email + password authentication
   - OAuth providers (Google / GitHub) - if backend supports
7. Auth token stored securely (httpOnly cookie preferred, or secure localStorage)
8. Protected routes redirect to login if not authenticated
9. Logout functionality clears auth state and redirects to login
10. Loading states shown during authentication
11. Error messages displayed for invalid credentials
12. Session persistence (user stays logged in on page refresh)

## Tasks / Subtasks

- [x] Task 1: Set up React application foundation (AC: 1)
  - [x] Initialize React project (Create React App or Vite)
  - [x] Set up project structure: `src/components/`, `src/pages/`, `src/services/`, `src/hooks/`, `src/utils/`
  - [x] Configure build tooling (webpack/vite)
  - [x] Set up routing library (React Router)
  - [x] Configure environment variables for API base URL
  - [x] Set up Tailwind CSS (or design system from design_prompt.md)
- [x] Task 2: Create API client service (AC: 3)
  - [x] Create `src/services/api.js` (or `.ts` if using TypeScript)
  - [x] Implement base API client with axios or fetch
  - [x] Implement token management (read from cookie/localStorage, attach to requests)
  - [x] Implement request/response interceptors for auth token attachment
  - [x] Implement error handling for 401 responses (redirect to login)
  - [ ] Implement retry logic for failed requests (optional)
- [x] Task 3: Create authentication service (AC: 2, 3, 6)
  - [x] Create `src/services/auth.js`
  - [x] Implement `login(email, password)` function
    - [x] Call `POST /auth/login` endpoint
    - [x] Store token securely (cookie or localStorage)
    - [x] Return success/error response
  - [x] Implement `logout()` function
    - [x] Call `POST /auth/logout` endpoint (if available)
    - [x] Clear token from storage
    - [x] Clear any user state
  - [x] Implement `getCurrentUser()` function (if endpoint exists)
  - [x] Implement OAuth login functions (if backend supports)
    - [x] Google OAuth flow (placeholder)
    - [x] GitHub OAuth flow (placeholder)
- [x] Task 4: Create authentication context/hook (AC: 2, 4, 8, 12)
  - [x] Create `src/contexts/AuthContext.js` (or use React Hook)
  - [x] Implement auth state management (isAuthenticated, user, loading)
  - [x] Implement `useAuth()` hook for components
  - [x] Implement token validation on app load (check if token exists and is valid)
  - [ ] Implement automatic token refresh (if backend supports refresh tokens)
  - [x] Handle token expiration and auto-logout
- [x] Task 5: Create login page component (AC: 6, 10, 11)
  - [x] Create `src/pages/Login.js`
  - [x] Create login form with:
    - [x] Email input field
    - [x] Password input field
    - [x] Submit button
    - [x] OAuth buttons (Google, GitHub) if supported (commented out, ready for future)
  - [x] Implement form validation (email format, required fields)
  - [x] Implement loading state during authentication
  - [x] Display error messages for invalid credentials
  - [x] Redirect to dashboard on successful login
  - [x] Apply design system from design_prompt.md (Minimalist Monochrome)
- [x] Task 6: Create protected route component (AC: 4, 8)
  - [x] Create `src/components/ProtectedRoute.js`
  - [x] Check authentication status
  - [x] Redirect to `/login` if not authenticated
  - [x] Render children if authenticated
  - [x] Show loading state while checking auth
- [x] Task 7: Set up routing with protection (AC: 8)
  - [x] Configure React Router in `src/App.js`
  - [x] Define routes:
    - [x] `/login` - Login page (public)
    - [x] `/` - Dashboard (protected)
    - [x] `/routes` - Routes list (protected)
    - [x] `/sources` - Sources list (protected)
    - [x] `/changes` - Changes list (protected)
  - [x] Wrap protected routes with `ProtectedRoute` component
  - [x] Implement redirect after login (return to intended page or dashboard)
- [x] Task 8: Create logout functionality (AC: 9)
  - [x] Add logout button/link to navigation
  - [x] Implement logout handler:
    - [x] Call auth service logout function
    - [x] Clear auth context state
    - [x] Redirect to login page
  - [ ] Show confirmation dialog for logout (optional)
- [x] Task 9: Implement auth state persistence (AC: 12)
  - [x] Check for existing token on app initialization
  - [x] Validate token with backend (optional: call `/auth/me` or similar)
  - [x] Restore auth state if valid token exists
  - [x] Clear invalid/expired tokens
- [x] Task 10: Create unit tests (AC: All)
  - [x] Test authentication service functions
  - [x] Test API client token attachment
  - [x] Test protected route component
  - [x] Test login form validation
  - [x] Test error handling
- [ ] Task 11: Manual testing (AC: All)
  - [ ] Test login with valid credentials
  - [ ] Test login with invalid credentials
  - [ ] Test accessing protected routes without auth (should redirect)
  - [ ] Test logout functionality
  - [ ] Test session persistence (refresh page, should stay logged in)
  - [ ] Test token expiration handling

## Dev Notes

### Previous Story Insights
- Story 4.1 created Jinja2-based admin UI foundation
- Story 1.5 created authentication system with JWT tokens
- Backend endpoints available: `POST /auth/login`, `POST /auth/logout`
- JWT tokens expire after 24 hours
- Authentication uses Bearer token in Authorization header

### API Specifications
[Source: architecture/api-specification.md]

**Authentication Endpoints:**
- `POST /auth/login` - Accepts `{username, password}`, returns `{access_token, token_type: "bearer"}`
- `POST /auth/logout` - Invalidates current token (requires authentication)

**Token Storage:**
- Backend can set httpOnly cookie via `Set-Cookie` header
- Or frontend stores in localStorage and attaches to `Authorization: Bearer <token>` header
- All API requests must include token in Authorization header

**Error Responses:**
- 401 Unauthorized: Missing or invalid token
- 400 Bad Request: Validation errors
- Error format: `{error: {code, message, details, timestamp, requestId}}`

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Note:** This story represents a shift from Jinja2 server-side rendering to React SPA architecture. The existing frontend architecture document describes Jinja2 templates, but this story implements a React-based frontend that consumes the same FastAPI APIs.

**React Project Structure:**
```
frontend/ (or react-admin-ui/)
├── src/
│   ├── components/          # Reusable UI components
│   │   ├── Button.js
│   │   ├── Input.js
│   │   ├── ProtectedRoute.js
│   │   └── ...
│   ├── pages/              # Page components
│   │   ├── Login.js
│   │   ├── Dashboard.js
│   │   └── ...
│   ├── services/           # API client services
│   │   ├── api.js          # Base API client
│   │   ├── auth.js         # Authentication service
│   │   └── ...
│   ├── contexts/           # React contexts
│   │   ├── AuthContext.js
│   │   └── ...
│   ├── hooks/             # Custom React hooks
│   │   ├── useAuth.js
│   │   └── ...
│   ├── utils/             # Utility functions
│   │   └── ...
│   ├── App.js              # Main app component
│   └── index.js            # Entry point
├── public/                 # Static assets
├── package.json
└── .env                    # Environment variables
```

### Design System
[Source: .ignore/design_prompt.md]

**Minimalist Monochrome Design:**
- Pure black (#000000) and white (#FFFFFF) palette
- Serif typography (Playfair Display for headlines, Source Serif 4 for body)
- Sharp 90-degree corners (no border-radius)
- Line-based visual system (borders, underlines)
- Dramatic negative space
- Instant transitions (0-100ms)
- Textures for depth (horizontal lines, grid patterns)

**Component Styling:**
- Buttons: Black background, white text, uppercase, tracking-widest
- Inputs: 2px solid black border (bottom only), no radius
- Forms: Generous spacing, clear hierarchy

### Tech Stack
[Source: architecture/tech-stack.md]

**Frontend Framework:** React (latest stable version)
**Build Tool:** Vite or Create React App
**Routing:** React Router v6+
**HTTP Client:** Axios or fetch API
**Styling:** Tailwind CSS (or custom CSS following design_prompt.md)
**State Management:** React Context API (no Redux needed for MVP)

### File Locations
[Source: architecture/unified-project-structure.md]

**New Directory Structure:**
- Create `frontend/` or `react-admin-ui/` directory at project root
- Or integrate React app into existing `admin-ui/` directory
- API client should point to FastAPI backend (same origin or CORS configured)

### Coding Standards
[Source: architecture/coding-standards.md]

**React Component Naming:** PascalCase (e.g., `Login.js`, `ProtectedRoute.js`)
**JavaScript Functions:** camelCase (e.g., `login()`, `handleSubmit()`)
**File Naming:** Match component name (e.g., `Login.js` for `Login` component)

**API Client Patterns:**
- Use async/await for API calls
- Handle errors consistently
- Show loading states for async operations
- Never store sensitive data in localStorage (use httpOnly cookies if possible)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/` or `frontend/tests/`

**Testing Frameworks:**
- React Testing Library for component tests
- Jest for unit tests
- Mock API responses for service tests

**Specific Testing Requirements:**
- Test authentication flow (login, logout)
- Test protected route access
- Test token attachment to API requests
- Test error handling
- Test session persistence

### Technical Constraints
- Must consume only existing FastAPI endpoints
- Must not re-implement backend logic
- Must reflect backend capabilities one-to-one
- Must enforce auth gating on frontend (not just rely on backend errors)
- Must store tokens securely (httpOnly cookies preferred)
- Must handle token expiration gracefully
- Must work with existing CORS configuration

### Cross-Cutting Requirements
**User Data Isolation:**
- All API responses are user-scoped
- Frontend must never display another user's data
- If frontend displays another user's route, that is a severity-1 bug

**State & Feedback Discipline:**
- Every API call must have: loading state, success state, failure state
- Silent failures are not acceptable
- Show clear error messages to users

**Frontend Is Driven by Backend Reality:**
- No hardcoded assumptions about routes, sources, diff structure
- Frontend renders what the API actually returns
- Handle empty states explicitly

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/` or `frontend/tests/`

**Test Standards:**
- Use React Testing Library for component tests
- Use Jest for unit tests
- Mock API responses using MSW (Mock Service Worker) or jest.mock
- Test user interactions (clicks, form submissions)
- Test error states and edge cases

**Testing Frameworks:**
- Jest 29+ with React Testing Library
- MSW (Mock Service Worker) for API mocking (optional)

**Specific Testing Requirements:**
- Test login form validation
- Test login API call and token storage
- Test protected route redirect
- Test logout functionality
- Test token attachment to API requests
- Test 401 error handling (redirect to login)
- Test session persistence on page refresh
- Test error message display

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
_No debug log entries required_

### Completion Notes List
- React application initialized with Vite and TypeScript
- Project structure created: components, pages, services, contexts, hooks, utils
- Tailwind CSS configured with Minimalist Monochrome design system
- API client service with axios, token management, and 401 error handling
- Authentication service with login/logout functions
- AuthContext provides global authentication state management
- Login page with form validation and design system styling
- ProtectedRoute component enforces authentication on routes
- React Router configured with protected routes (/, /routes, /sources, /changes)
- Navigation component with logout functionality
- Auth state persistence implemented (token stored in localStorage, validated on app load)
- Unit tests created for API client, auth service, ProtectedRoute, and Login components
- All core functionality implemented and ready for manual testing

### File List
**New Files Created:**
- `frontend/package.json` - React project dependencies and scripts
- `frontend/vite.config.ts` - Vite build configuration
- `frontend/vitest.config.ts` - Vitest test configuration
- `frontend/tailwind.config.js` - Tailwind CSS configuration with design system
- `frontend/postcss.config.js` - PostCSS configuration
- `frontend/index.html` - HTML entry point
- `frontend/src/main.tsx` - React app entry point
- `frontend/src/App.tsx` - Main app component with routing
- `frontend/src/index.css` - Global styles with Tailwind and design system
- `frontend/src/utils/config.ts` - Application configuration (API base URL)
- `frontend/src/services/api.ts` - Base API client with axios, token management, interceptors
- `frontend/src/services/auth.ts` - Authentication service (login, logout, getCurrentUser)
- `frontend/src/contexts/AuthContext.tsx` - Authentication context provider
- `frontend/src/hooks/useAuth.ts` - useAuth hook (re-export from AuthContext)
- `frontend/src/pages/Login.tsx` - Login page component
- `frontend/src/pages/Dashboard.tsx` - Dashboard page (placeholder)
- `frontend/src/pages/Routes.tsx` - Routes page (placeholder)
- `frontend/src/pages/Sources.tsx` - Sources page (placeholder)
- `frontend/src/pages/Changes.tsx` - Changes page (placeholder)
- `frontend/src/components/ProtectedRoute.tsx` - Protected route wrapper component
- `frontend/src/components/Navigation.tsx` - Navigation bar with logout
- `frontend/src/test/setup.ts` - Test setup configuration
- `frontend/src/__tests__/api.test.ts` - API client unit tests
- `frontend/src/__tests__/auth.test.ts` - Authentication service unit tests
- `frontend/src/__tests__/ProtectedRoute.test.tsx` - ProtectedRoute component tests
- `frontend/src/__tests__/Login.test.tsx` - Login page component tests

## QA Results
_To be populated by QA Agent_

