# Story 8.3: Webhook Notifications

## Status
Draft

## Story
**As a** developer/integrator,  
**I want** webhook notifications for policy changes,  
**so that** I can receive real-time updates in my own systems.

## Acceptance Criteria

1. Webhook configuration:
   - Customers can configure webhook URLs
   - Multiple webhooks per customer (optional)
   - Webhook authentication (signature verification)
2. Webhook delivery:
   - Real-time delivery when change detected
   - Webhook payload includes: route, source, timestamp, diff, summary (if available)
   - JSON payload format
3. Webhook retry logic:
   - Retry failed webhooks (exponential backoff)
   - Maximum retry attempts
   - Dead letter queue for failed webhooks
4. Webhook security:
   - HTTPS required for webhook URLs
   - Signature verification (HMAC)
   - Secret key management
5. Webhook management:
   - Create, update, delete webhooks (admin UI or API)
   - Test webhook delivery
   - View webhook delivery history
6. Webhook monitoring:
   - Delivery success/failure tracking
   - Delivery latency monitoring
   - Webhook health dashboard
7. Webhook logs:
   - Log all webhook delivery attempts
   - View webhook logs in admin UI
   - Export webhook logs
8. Manual test: Configure webhook, trigger change, verify webhook received

## Tasks / Subtasks

- [ ] Task 1: Create webhook model (AC: 1)
  - [ ] Create Alembic migration for `webhooks` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users)
    - [ ] `url`: TEXT (webhook URL, must be HTTPS)
    - [ ] `secret_key`: VARCHAR(255) (hashed secret for HMAC)
    - [ ] `name`: VARCHAR(255) (webhook name/description)
    - [ ] `is_active`: BOOLEAN
    - [ ] `events`: JSONB (array of event types to subscribe to)
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/webhook.py`
  - [ ] Create repository: `api/repositories/webhook_repository.py`
- [ ] Task 2: Create webhook delivery service (AC: 2)
  - [ ] Create `api/services/webhook_service.py`
  - [ ] Implement `deliver_webhook(webhook: Webhook, event_data: dict) -> WebhookDeliveryResult`:
    - [ ] Create webhook payload (JSON)
    - [ ] Generate HMAC signature
    - [ ] Send HTTP POST request to webhook URL
    - [ ] Include signature in headers (`X-Webhook-Signature`)
    - [ ] Return delivery result (success/failure, status code, response)
  - [ ] Payload includes: route, source, timestamp, diff, summary (if available), event type
- [ ] Task 3: Create webhook payload generator (AC: 2)
  - [ ] Implement `generate_webhook_payload(policy_change: PolicyChange, event_type: str) -> dict`:
    - [ ] Include route information
    - [ ] Include source information
    - [ ] Include timestamp
    - [ ] Include diff (or link to diff)
    - [ ] Include AI summary (if available)
    - [ ] Include event type
    - [ ] Return JSON-serializable dictionary
- [ ] Task 4: Implement HMAC signature generation (AC: 4)
  - [ ] Implement `generate_webhook_signature(payload: str, secret: str) -> str`:
    - [ ] Use HMAC-SHA256
    - [ ] Sign JSON payload string
    - [ ] Return hex-encoded signature
  - [ ] Include signature in webhook headers
  - [ ] Document signature verification for webhook receivers
- [ ] Task 5: Implement webhook retry logic (AC: 3)
  - [ ] Create `api/services/webhook_retry.py`
  - [ ] Implement retry mechanism:
    - [ ] Retry on network errors (timeout, connection errors)
    - [ ] Retry on 5xx status codes
    - [ ] Don't retry on 4xx status codes (client errors)
    - [ ] Exponential backoff (1s, 2s, 4s, 8s)
    - [ ] Maximum 5 retry attempts
  - [ ] Store retry attempts in webhook_deliveries table
- [ ] Task 6: Create webhook delivery tracking (AC: 3, 6, 7)
  - [ ] Create Alembic migration for `webhook_deliveries` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `webhook_id`: UUID (foreign key to webhooks)
    - [ ] `policy_change_id`: UUID (foreign key to policy_changes)
    - [ ] `event_type`: VARCHAR(50) ('policy_change', etc.)
    - [ ] `status`: VARCHAR(20) ('pending', 'success', 'failed', 'retrying')
    - [ ] `status_code`: INTEGER (HTTP status code)
    - [ ] `response_body`: TEXT (response from webhook endpoint)
    - [ ] `attempt_number`: INTEGER
    - [ ] `delivered_at`: TIMESTAMP WITH TIME ZONE (nullable)
    - [ ] `error_message`: TEXT (nullable)
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/webhook_delivery.py`
- [ ] Task 7: Integrate webhook delivery with change detection (AC: 2)
  - [ ] Update alert engine or change detection pipeline:
    - [ ] After PolicyChange created, get all active webhooks for user
    - [ ] For each webhook, trigger webhook delivery
    - [ ] Don't block change detection if webhook delivery fails
  - [ ] Make webhook delivery async (background task or queue)
- [ ] Task 8: Create webhook management API endpoints (AC: 5)
  - [ ] Create `GET /api/webhooks` - List user's webhooks
  - [ ] Create `POST /api/webhooks` - Create webhook
  - [ ] Create `GET /api/webhooks/{id}` - Get webhook details
  - [ ] Create `PUT /api/webhooks/{id}` - Update webhook
  - [ ] Create `DELETE /api/webhooks/{id}` - Delete webhook
  - [ ] Create `POST /api/webhooks/{id}/test` - Test webhook delivery
  - [ ] Require authentication
- [ ] Task 9: Create webhook management UI (AC: 5)
  - [ ] Create `admin-ui/templates/pages/webhooks/list.html` - Webhook list
  - [ ] Create `admin-ui/templates/pages/webhooks/form.html` - Create/edit webhook
  - [ ] Create web routes: `GET /webhooks`, `GET /webhooks/new`, `GET /webhooks/{id}/edit`
  - [ ] Display webhook management:
    - [ ] List of webhooks with status
    - [ ] Create/edit webhook form (URL, name, events)
    - [ ] Test webhook button
    - [ ] View delivery history
  - [ ] Add "Webhooks" link to admin navigation
- [ ] Task 10: Create webhook delivery history UI (AC: 5, 7)
  - [ ] Create `admin-ui/templates/pages/webhooks/delivery-history.html` - Delivery history
  - [ ] Create web route: `GET /webhooks/{id}/history`
  - [ ] Display delivery history:
    - [ ] Table of delivery attempts
    - [ ] Status, timestamp, response code, error message
    - [ ] Filter by status, date range
    - [ ] Export logs option
- [ ] Task 11: Create webhook monitoring dashboard (AC: 6)
  - [ ] Create `admin-ui/templates/pages/webhooks/monitoring.html` - Webhook monitoring
  - [ ] Create web route: `GET /webhooks/monitoring`
  - [ ] Display webhook health:
    - [ ] Success rate per webhook
    - [ ] Average delivery latency
    - [ ] Recent failures
    - [ ] Health status indicators
- [ ] Task 12: Implement dead letter queue (AC: 3)
  - [ ] Create dead letter queue for failed webhooks:
    - [ ] After max retries, mark as failed
    - [ ] Store in webhook_deliveries with status='failed'
    - [ ] Option to manually retry from admin UI
  - [ ] Create admin UI for dead letter queue
- [ ] Task 13: Validate webhook URLs (AC: 4)
  - [ ] Add validation:
    - [ ] URL must be HTTPS
    - [ ] URL must be valid format
    - [ ] Test URL accessibility (optional ping)
  - [ ] Reject invalid URLs with clear error message
- [ ] Task 14: Manual testing (AC: 8)
  - [ ] Test: Create webhook
  - [ ] Test: Trigger policy change
  - [ ] Test: Verify webhook received
  - [ ] Test: Verify signature validation
  - [ ] Test: Test retry logic (simulate failure)
  - [ ] Test: View delivery history

## Dev Notes

### Previous Story Insights
- Story 2.9 created change detection pipeline
- Story 3.4 created alert engine
- Story 8.2 created public API endpoints
- Story 1.5 created authentication system

### Webhook Security
**HMAC Signature:**
- Use HMAC-SHA256 to sign webhook payloads
- Secret key stored hashed in database
- Signature in `X-Webhook-Signature` header
- Receivers verify signature to ensure authenticity

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `api/models/db/webhook.py` - Webhook model
- `api/models/db/webhook_delivery.py` - Webhook delivery tracking model
- `api/repositories/webhook_repository.py` - Webhook repository
- `api/services/webhook_service.py` - Webhook delivery service
- `api/services/webhook_retry.py` - Webhook retry logic
- `admin-ui/templates/pages/webhooks/` - Webhook UI templates
- `alembic/versions/XXX_add_webhooks.py` - Migration
- `alembic/versions/XXX_add_webhook_deliveries.py` - Migration

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Webhook Delivery:**
- Use async HTTP client (httpx or aiohttp)
- Handle timeouts (30 seconds)
- Log all delivery attempts
- Don't block change detection

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Integration Tests:**
- Test webhook delivery end-to-end
- Test retry logic
- Test signature generation and verification

**Manual Testing:**
- Configure webhook
- Trigger change
- Verify webhook received
- Test retry logic

## Testing

**Integration Tests:**
- Test webhook delivery
- Test retry logic
- Test signature generation

**Manual Testing:**
- Create webhook
- Trigger policy change
- Verify webhook received
- Test retry logic
- View delivery history

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |



