# Story 6.4: Weekly Summary Emails

## Status
Draft

## Story
**As an** admin user,  
**I want** weekly summary emails of all policy changes,  
**so that** I can review the week's activity in one consolidated view.

## Acceptance Criteria

1. Weekly summary email sent automatically:
   - Sent every Monday (or configurable day)
   - Summarizes previous week's activity (Sunday-Saturday)
2. Email content includes:
   - Total changes detected during the week
   - Changes grouped by route
   - Changes grouped by source
   - List of all changes (with links to full diffs)
   - Summary statistics (sources checked, routes monitored)
3. Change list format:
   - Date and time of each change
   - Route affected
   - Source name
   - Brief change description (first line of diff or "Content changed")
   - Link to full diff
4. Statistics section:
   - Number of sources checked
   - Number of routes monitored
   - Most active sources
   - Most active routes
5. Email template:
   - HTML format with plain text fallback
   - Professional, readable layout
   - Link to dashboard for detailed view
6. Configuration:
   - Enable/disable weekly summaries (admin UI)
   - Choose day of week for delivery
   - Choose time of day for delivery
7. Scheduling:
   - Automated job runs weekly (cron or scheduled task)
   - Handles timezone correctly
   - Skips if no changes detected (optional - or send "no changes" summary)
8. Error handling:
   - Logs summary generation and sending
   - Handles failures gracefully
9. Manual test: Trigger weekly summary manually, verify content and delivery

## Tasks / Subtasks

- [ ] Task 1: Create weekly summary configuration model (AC: 6)
  - [ ] Create Alembic migration for `weekly_summary_config` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users, nullable for MVP)
    - [ ] `enabled`: BOOLEAN (whether summaries are enabled)
    - [ ] `day_of_week`: INTEGER (0=Monday, 6=Sunday, default 0)
    - [ ] `time_of_day`: TIME (default 09:00)
    - [ ] `timezone`: VARCHAR(50) (default 'UTC')
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/weekly_summary_config.py`
  - [ ] Create repository: `api/repositories/weekly_summary_config_repository.py`
- [ ] Task 2: Create weekly summary configuration API (AC: 6)
  - [ ] Create `GET /api/weekly-summary/config` - Get configuration
  - [ ] Create `PUT /api/weekly-summary/config` - Update configuration
  - [ ] Require authentication
  - [ ] Return configuration as JSON
- [ ] Task 3: Create weekly summary configuration UI (AC: 6)
  - [ ] Create `admin-ui/templates/pages/settings/weekly-summary.html` - Configuration page
  - [ ] Create web route: `GET /settings/weekly-summary`
  - [ ] Display configuration form:
    - [ ] Enable/disable toggle
    - [ ] Day of week dropdown (Monday-Sunday)
    - [ ] Time of day input (time picker)
    - [ ] Timezone dropdown (optional, default UTC)
    - [ ] Save button
  - [ ] Add "Settings" or "Weekly Summary" link to admin navigation
- [ ] Task 4: Create weekly summary service (AC: 1, 2, 3, 4)
  - [ ] Create `api/services/weekly_summary.py`
  - [ ] Implement `generate_weekly_summary(start_date: date, end_date: date) -> WeeklySummary` function:
    - [ ] Get all PolicyChanges in date range
    - [ ] Group changes by route
    - [ ] Group changes by source
    - [ ] Calculate statistics:
      - [ ] Total changes
      - [ ] Sources checked
      - [ ] Routes monitored
      - [ ] Most active sources
      - [ ] Most active routes
    - [ ] Format change list with date, route, source, description, link
    - [ ] Return WeeklySummary data structure
- [ ] Task 5: Create weekly summary email template (AC: 5)
  - [ ] Create `admin-ui/templates/emails/weekly_summary.html` - HTML template
  - [ ] Create `admin-ui/templates/emails/weekly_summary.txt` - Plain text template
  - [ ] Template includes:
    - [ ] Header with week date range
    - [ ] Total changes detected
    - [ ] Statistics section (sources checked, routes monitored, most active)
    - [ ] Changes grouped by route
    - [ ] Changes grouped by source
    - [ ] List of all changes (date, route, source, description, link)
    - [ ] Link to dashboard
    - [ ] Professional, readable layout
  - [ ] Use EmailTemplateService to render template
- [ ] Task 6: Create weekly summary email sending function (AC: 1, 2, 5)
  - [ ] Implement `send_weekly_summary(route_subscription_id: UUID, summary: WeeklySummary) -> EmailResult` function
  - [ ] Get route subscription email address
  - [ ] Generate email subject: "Weekly Policy Change Summary: {week_date_range}"
  - [ ] Render email template with summary data
  - [ ] Send email via email service (Resend)
  - [ ] Log email send (success/failure)
- [ ] Task 7: Create weekly summary job (AC: 1, 7)
  - [ ] Create `scripts/run_weekly_summary_job.py` or add to scheduler
  - [ ] Implement `run_weekly_summary_job() -> JobResult` function:
    - [ ] Get current date and calculate week range (previous Sunday-Saturday)
    - [ ] Get all active route subscriptions
    - [ ] For each route subscription:
      - [ ] Check if weekly summaries enabled (from config)
      - [ ] Generate weekly summary for route's changes
      - [ ] If changes detected (or if configured to send even with no changes):
        - [ ] Send weekly summary email
    - [ ] Log job execution
    - [ ] Return JobResult with summary
- [ ] Task 8: Configure weekly summary scheduling (AC: 7)
  - [ ] Update GitHub Actions workflow or create new workflow:
    - [ ] Create `.github/workflows/weekly-summary.yml`
    - [ ] Schedule to run weekly (configurable day and time)
    - [ ] Use cron syntax: `0 9 * * 1` (Monday 9 AM UTC, or configurable)
    - [ ] Run weekly summary job script
    - [ ] Handle timezone correctly (use config timezone)
  - [ ] Or use system cron if running on server
- [ ] Task 9: Handle timezone correctly (AC: 7)
  - [ ] Store timezone in configuration (default UTC)
  - [ ] Convert scheduled time to UTC for cron
  - [ ] Use timezone when calculating week range
  - [ ] Display timezone in email template
- [ ] Task 10: Implement "no changes" handling (AC: 7)
  - [ ] Check if changes detected in week
  - [ ] If no changes:
    - [ ] Option 1: Skip sending summary (if configured)
    - [ ] Option 2: Send "no changes" summary (if configured)
  - [ ] Add configuration option for this behavior
- [ ] Task 11: Add error handling and logging (AC: 8)
  - [ ] Log weekly summary job start/end
  - [ ] Log summary generation for each route
  - [ ] Log email sending (success/failure)
  - [ ] Handle errors gracefully:
    - [ ] If summary generation fails, log and continue with next route
    - [ ] If email sending fails, log and continue
    - [ ] Do not stop job on single failure
- [ ] Task 12: Create manual trigger endpoint (AC: 9)
  - [ ] Create `POST /api/jobs/weekly-summary` endpoint
  - [ ] Accept optional parameters:
    - [ ] `start_date`: ISO date string (optional, defaults to previous Sunday)
    - [ ] `end_date`: ISO date string (optional, defaults to previous Saturday)
  - [ ] Trigger weekly summary job manually
  - [ ] Return JobResult as JSON
  - [ ] Require authentication
- [ ] Task 13: Manual testing (AC: 9)
  - [ ] Test: Configure weekly summary settings
  - [ ] Test: Trigger weekly summary manually
  - [ ] Test: Verify email content is correct
  - [ ] Test: Verify email delivery
  - [ ] Test: Verify statistics accuracy
  - [ ] Test: Test with no changes (if configured)

## Dev Notes

### Previous Story Insights
- Story 3.2 created email template system with Jinja2
- Story 3.3 created email sending service integration (Resend)
- Story 3.5 created scheduled job system (daily fetch)
- Story 3.6 created GitHub Actions cron configuration
- Story 4.2 created dashboard for viewing changes

### Email Template System
[Source: docs/stories/3.2.email-template-system.story.md]

**Email Templates:**
- Jinja2 templates in `admin-ui/templates/emails/`
- HTML and plain text versions
- EmailTemplateService for rendering
- Templates can be updated without code changes

### Email Sending Service
[Source: docs/stories/3.3.email-sending-service-integration.story.md]

**Email Service:**
- Resend API for sending emails
- `send_email(recipient, subject, html_body, text_body)` function
- Returns success/failure status and message ID
- Error handling and retry logic

### Scheduled Job System
[Source: docs/stories/3.5.scheduled-job-system.story.md]

**Job Pattern:**
- `run_daily_fetch_job()` function pattern
- Returns JobResult with execution details
- Handles errors gracefully
- Logs start/end time and results

### GitHub Actions Cron
[Source: docs/stories/3.6.github-actions-cron-configuration.story.md]

**Cron Configuration:**
- GitHub Actions workflow file
- Scheduled using cron syntax
- Runs in GitHub Actions environment
- Uses environment variables from secrets

### PolicyChange Model
[Source: docs/architecture/data-models.md]

**PolicyChange Attributes:**
- `id`: UUID
- `sourceId`: UUID
- `detectedAt`: Date
- `diff`: string
- `oldVersionId`: UUID
- `newVersionId`: UUID

**Querying:**
- Can filter by date range (`detectedAt`)
- Can join with RouteSubscription for route filtering
- Can join with Source for source information

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `api/models/db/weekly_summary_config.py` - Configuration model
- `api/repositories/weekly_summary_config_repository.py` - Configuration repository
- `api/services/weekly_summary.py` - Weekly summary service
- `scripts/run_weekly_summary_job.py` - Weekly summary job script
- `admin-ui/templates/emails/weekly_summary.html` - HTML email template
- `admin-ui/templates/emails/weekly_summary.txt` - Plain text email template
- `admin-ui/templates/pages/settings/weekly-summary.html` - Configuration UI
- `.github/workflows/weekly-summary.yml` - GitHub Actions workflow
- `alembic/versions/XXX_add_weekly_summary_config.py` - Migration

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Database Access:**
- Always use Repository pattern
- Use async/await for all database operations

**Email Sending:**
- Always use email service abstraction
- Log all email sends
- Handle errors gracefully

**Job Execution:**
- Log job start/end
- Handle errors gracefully
- Return JobResult with execution details

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Unit Tests:**
- Test weekly summary generation
- Test email template rendering
- Test configuration management

**Integration Tests:**
- Test weekly summary job end-to-end
- Test email delivery
- Test scheduling

**Manual Testing:**
- Configure weekly summary settings
- Trigger weekly summary manually
- Verify email content and delivery

### Technical Constraints
- Must handle timezone correctly
- Must work with existing email service
- Must integrate with existing job system
- Performance: Generate summary efficiently

## Testing

**Unit Tests:**
- Test weekly summary generation
- Test email template rendering
- Test configuration management

**Integration Tests:**
- Test weekly summary job end-to-end
- Test email delivery
- Test scheduling

**Manual Testing:**
- Configure weekly summary settings
- Trigger weekly summary manually
- Verify email content is correct
- Verify email delivery
- Verify statistics accuracy
- Test with no changes (if configured)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

