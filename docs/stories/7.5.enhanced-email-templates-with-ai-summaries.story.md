# Story 7.5: Enhanced Email Templates with AI Summaries

## Status
Draft

## Story
**As an** admin user,  
**I want** AI summaries included in email alerts (optional),  
**so that** I can quickly understand changes without opening the full diff.

## Acceptance Criteria

1. Email template enhancement:
   - Include AI summary in email (if available and enabled)
   - Summary appears before diff preview
   - Clear labeling: "AI Summary" or "Summary"
2. User preferences:
   - Opt-in/opt-out of AI summaries in emails
   - Preference stored per user/organization
   - Default: opt-in (but can disable)
3. Email content structure:
   - AI summary (if enabled and available)
   - Diff preview (always included)
   - Link to full diff (always included)
   - Impact assessment (if enabled)
4. Clear AI labeling:
   - "AI-Generated Summary" label
   - Disclaimer: "This summary is AI-generated and may contain errors"
   - Link to full diff for verification
5. Fallback handling:
   - If summary not available, show diff preview only
   - If summarization failed, show diff preview only
   - No blocking if AI features unavailable
6. Email testing:
   - Test emails with and without AI summaries
   - Verify formatting and readability
   - Test across email clients
7. Manual test: Enable AI summaries, receive alert, verify summary appears correctly

## Tasks / Subtasks

- [ ] Task 1: Update email template to include AI summary (AC: 1, 4)
  - [ ] Update `admin-ui/templates/emails/change_alert.html`
  - [ ] Add AI summary section:
    - [ ] Check if `ai_summary` exists in change data
    - [ ] Display summary with clear "AI-Generated Summary" label
    - [ ] Add disclaimer: "This summary is AI-generated and may contain errors"
    - [ ] Add link to full diff for verification
  - [ ] Position summary before diff preview
  - [ ] Style summary section (professional, readable)
- [ ] Task 2: Update email template service (AC: 1)
  - [ ] Update `api/services/email_template.py`
  - [ ] Update `render_change_alert_template()` function:
    - [ ] Include `ai_summary` in template context if available
    - [ ] Pass summary to template
  - [ ] Update template rendering to conditionally include summary
- [ ] Task 3: Create user preference model (AC: 2)
  - [ ] Create Alembic migration for `user_preferences` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users, nullable for MVP)
    - [ ] `preference_key`: VARCHAR(100) (e.g., 'ai_summaries_in_emails')
    - [ ] `preference_value`: TEXT (JSON or string)
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/user_preference.py`
  - [ ] Create repository: `api/repositories/user_preference_repository.py`
- [ ] Task 4: Create user preference API endpoints (AC: 2)
  - [ ] Create `GET /api/user-preferences` - Get user preferences
  - [ ] Create `PUT /api/user-preferences` - Update user preferences
  - [ ] Support preference: `ai_summaries_in_emails` (boolean)
  - [ ] Default: true (opt-in)
  - [ ] Require authentication
- [ ] Task 5: Create user preference UI (AC: 2)
  - [ ] Create `admin-ui/templates/pages/settings/email-preferences.html` - Email preferences page
  - [ ] Create web route: `GET /settings/email-preferences`
  - [ ] Display preference form:
    - [ ] "Include AI summaries in emails" toggle
    - [ ] Explanation of what AI summaries are
    - [ ] Save button
  - [ ] Add "Email Preferences" link to admin navigation
- [ ] Task 6: Update alert engine to check preferences (AC: 2, 3)
  - [ ] Update `api/services/alert_engine.py`
  - [ ] Before sending email:
    - [ ] Check user preference for `ai_summaries_in_emails`
    - [ ] Only include AI summary if preference is enabled
    - [ ] Always include diff preview and link to full diff
  - [ ] Include impact assessment if enabled (from Story 7.3)
- [ ] Task 7: Update email content structure (AC: 3)
  - [ ] Update email template structure:
    - [ ] AI summary section (if enabled and available)
    - [ ] Diff preview section (always included)
    - [ ] Link to full diff (always included)
    - [ ] Impact assessment section (if enabled and available)
  - [ ] Ensure clear visual separation between sections
  - [ ] Use professional, readable layout
- [ ] Task 8: Add clear AI labeling and disclaimers (AC: 4)
  - [ ] Add "AI-Generated Summary" label to summary section
  - [ ] Add disclaimer text:
    - [ ] "This summary is AI-generated and may contain errors"
    - [ ] "For complete information, view the full diff"
  - [ ] Add link to full diff prominently
  - [ ] Style disclaimers (smaller font, italic or gray text)
- [ ] Task 9: Implement fallback handling (AC: 5)
  - [ ] Update email template:
    - [ ] If `ai_summary` is None or empty, don't show summary section
    - [ ] Always show diff preview (fallback)
    - [ ] Always show link to full diff
  - [ ] Update alert engine:
    - [ ] Don't block email sending if summary not available
    - [ ] Log warning if summary expected but not available
- [ ] Task 10: Update plain text email template (AC: 1, 4)
  - [ ] Update `admin-ui/templates/emails/change_alert.txt`
  - [ ] Add AI summary section (if available):
    - [ ] Label: "AI-Generated Summary:"
    - [ ] Summary text
    - [ ] Disclaimer: "This summary is AI-generated and may contain errors"
    - [ ] Link to full diff
  - [ ] Ensure plain text version includes all information
- [ ] Task 11: Test email formatting (AC: 6)
  - [ ] Test email with AI summary:
    - [ ] Verify summary appears correctly
    - [ ] Verify formatting is readable
    - [ ] Verify disclaimers visible
  - [ ] Test email without AI summary:
    - [ ] Verify diff preview still shown
    - [ ] Verify no broken sections
  - [ ] Test across email clients:
    - [ ] Gmail (web and mobile)
    - [ ] Outlook (desktop and web)
    - [ ] Apple Mail (desktop and mobile)
- [ ] Task 12: Manual testing (AC: 7)
  - [ ] Test: Enable AI summaries in preferences
  - [ ] Test: Receive email alert with AI summary
  - [ ] Test: Verify summary appears correctly
  - [ ] Test: Disable AI summaries in preferences
  - [ ] Test: Receive email alert without AI summary
  - [ ] Test: Verify diff preview still shown

## Dev Notes

### Previous Story Insights
- Story 3.2 created email template system
- Story 3.4 created alert engine
- Story 7.2 created AI summarization
- Story 7.3 created impact assessment
- Story 6.5 enhanced email templates (UX improvements)

### Email Template System
[Source: docs/stories/3.2.email-template-system.story.md]

**Email Templates:**
- Jinja2 templates in `admin-ui/templates/emails/`
- HTML and plain text versions
- EmailTemplateService for rendering

**Current Template:**
- `change_alert.html` - Policy change alert template
- Includes route, source, timestamp, diff preview, link to full diff

### Alert Engine
[Source: docs/stories/3.4.alert-engine-change-detection-to-email-flow.story.md]

**Alert Flow:**
- `send_alerts_for_change(policy_change_id)` orchestrates alert sending
- Gets PolicyChange and RouteSubscription
- Renders email template
- Sends email via email service

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to update:
- `admin-ui/templates/emails/change_alert.html` - Add AI summary section
- `admin-ui/templates/emails/change_alert.txt` - Add AI summary section
- `api/services/email_template.py` - Include AI summary in context
- `api/services/alert_engine.py` - Check user preferences

Files to create:
- `api/models/db/user_preference.py` - User preference model
- `api/repositories/user_preference_repository.py` - Preference repository
- `admin-ui/templates/pages/settings/email-preferences.html` - Preferences UI
- `alembic/versions/XXX_add_user_preferences.py` - Migration

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Email Templates:**
- Use table-based layouts for email compatibility
- Inline CSS styles
- Test across multiple email clients

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Manual Testing:**
- Test in multiple email clients
- Test with and without AI summaries
- Verify formatting and readability

## Testing

**Email Client Testing:**
- Test in Gmail, Outlook, Apple Mail
- Test on mobile devices
- Verify formatting is correct

**Functional Testing:**
- Test with AI summary enabled
- Test with AI summary disabled
- Test fallback when summary not available
- Verify all links work correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |



