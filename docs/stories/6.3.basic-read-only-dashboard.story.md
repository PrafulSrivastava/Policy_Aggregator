# Story 6.3: Basic Read-Only Dashboard

## Status
Draft

## Story
**As an** admin user,  
**I want** a read-only dashboard showing historical changes and statistics,  
**so that** I can review past policy changes and system activity without relying solely on emails.

## Acceptance Criteria

1. Dashboard page displays:
   - Recent changes list (last 30 days, configurable)
   - Changes by route (summary counts)
   - Changes by source (summary counts)
   - System health indicators (last check per source)
2. Historical change view:
   - Chronological list of all changes
   - Filterable by: route, source, date range, visa type
   - Searchable (text search in change content)
   - Pagination for large result sets
3. Statistics and metrics:
   - Total changes detected (all time, last 30 days, last 7 days)
   - Changes per route
   - Most active sources
   - Change frequency trends (simple chart or table)
4. Route and source overview:
   - Active routes list
   - Active sources list
   - Last check timestamp per source
   - Source health status (healthy, error, never checked)
5. Read-only design:
   - No editing capabilities
   - No real-time monitoring (email remains primary)
   - Historical data only
6. Dashboard filters:
   - Date range picker (last 7 days, 30 days, custom range)
   - Route filter dropdown
   - Source filter dropdown
   - Apply filters and reset
7. Export functionality:
   - Export filtered results to CSV
   - Export statistics to PDF (optional)
8. Performance: Dashboard loads efficiently (< 3 seconds) even with many changes
9. Responsive design: Works on desktop and tablet
10. Manual test: View dashboard, test filters, verify statistics accuracy

## Tasks / Subtasks

- [ ] Task 1: Enhance dashboard API endpoint (AC: 1, 2, 3, 4)
  - [ ] Update `GET /api/dashboard` endpoint
  - [ ] Add query parameters for filtering:
    - [ ] `date_range`: "7d", "30d", "custom"
    - [ ] `start_date`: ISO date string (for custom range)
    - [ ] `end_date`: ISO date string (for custom range)
    - [ ] `route_id`: UUID (filter by route)
    - [ ] `source_id`: UUID (filter by source)
    - [ ] `visa_type`: string (filter by visa type)
    - [ ] `search`: string (text search in change content)
    - [ ] `page`: int (pagination)
    - [ ] `page_size`: int (pagination)
  - [ ] Return enhanced dashboard data:
    - [ ] Recent changes list (filtered, paginated)
    - [ ] Changes by route (summary counts)
    - [ ] Changes by source (summary counts)
    - [ ] Statistics (total changes, changes per period)
    - [ ] Route and source overview
    - [ ] System health indicators
- [ ] Task 2: Enhance dashboard service (AC: 1, 2, 3, 4)
  - [ ] Update `api/services/dashboard.py`
  - [ ] Implement filtering logic:
    - [ ] Filter changes by date range
    - [ ] Filter changes by route, source, visa type
    - [ ] Text search in change content (PolicyChange.diff or PolicyVersion.raw_text)
  - [ ] Implement statistics calculation:
    - [ ] Total changes (all time, last 30 days, last 7 days)
    - [ ] Changes per route (group by route)
    - [ ] Changes per source (group by source)
    - [ ] Most active sources (top N by change count)
    - [ ] Change frequency trends (changes per day/week)
  - [ ] Implement pagination for large result sets
- [ ] Task 3: Update dashboard template (AC: 1, 4, 5)
  - [ ] Update `admin-ui/templates/pages/dashboard.html`
  - [ ] Enhance recent changes list:
    - [ ] Show last 30 days by default (configurable)
    - [ ] Display changes in chronological order
    - [ ] Show route, source, timestamp for each change
    - [ ] Link to change detail page
  - [ ] Add changes by route section:
    - [ ] Summary table/cards showing change counts per route
    - [ ] Clickable to filter by route
  - [ ] Add changes by source section:
    - [ ] Summary table/cards showing change counts per source
    - [ ] Clickable to filter by source
  - [ ] Enhance system health section:
    - [ ] Last check timestamp per source
    - [ ] Source health status indicators (healthy, error, never checked)
    - [ ] Visual indicators (green, yellow, red)
- [ ] Task 4: Add historical change view (AC: 2)
  - [ ] Create or update `admin-ui/templates/pages/changes/list.html`
  - [ ] Display chronological list of all changes:
    - [ ] Table with columns: date, route, source, change type
    - [ ] Sortable columns
    - [ ] Pagination controls
  - [ ] Add filtering UI:
    - [ ] Date range picker
    - [ ] Route filter dropdown
    - [ ] Source filter dropdown
    - [ ] Visa type filter dropdown
    - [ ] Search input (text search)
    - [ ] Apply and reset buttons
  - [ ] Implement client-side or server-side filtering
- [ ] Task 5: Add statistics and metrics section (AC: 3)
  - [ ] Create statistics section in dashboard:
    - [ ] Total changes detected (all time, last 30 days, last 7 days)
    - [ ] Changes per route (table or cards)
    - [ ] Most active sources (table or list)
    - [ ] Change frequency trends (simple table or chart)
  - [ ] Use Tailwind CSS for styling
  - [ ] Make statistics visually appealing (cards, charts)
- [ ] Task 6: Add route and source overview (AC: 4)
  - [ ] Create route overview section:
    - [ ] List of active routes
    - [ ] Route statistics (changes, sources, last check)
  - [ ] Create source overview section:
    - [ ] List of active sources
    - [ ] Last check timestamp per source
    - [ ] Source health status (healthy, error, never checked)
    - [ ] Visual status indicators
- [ ] Task 7: Ensure read-only design (AC: 5)
  - [ ] Verify no editing capabilities in dashboard
  - [ ] Remove any edit/delete buttons from dashboard
  - [ ] Ensure dashboard is for viewing only
  - [ ] Document that email remains primary notification method
- [ ] Task 8: Add dashboard filters UI (AC: 6)
  - [ ] Create filter panel in dashboard:
    - [ ] Date range picker (last 7 days, 30 days, custom range)
    - [ ] Route filter dropdown (populated from API)
    - [ ] Source filter dropdown (populated from API)
    - [ ] Apply filters button
    - [ ] Reset filters button
  - [ ] Implement filter state management (JavaScript)
  - [ ] Update dashboard data when filters applied
- [ ] Task 9: Add export functionality (AC: 7)
  - [ ] Add "Export to CSV" button to dashboard
  - [ ] Create `GET /api/dashboard/export` endpoint:
    - [ ] Accept same filter parameters as dashboard
    - [ ] Generate CSV file with filtered results
    - [ ] Return CSV file with proper headers
  - [ ] Implement CSV generation:
    - [ ] Include change data (date, route, source, etc.)
    - [ ] Use Python `csv` module
  - [ ] Add "Export to PDF" button (optional):
    - [ ] Generate PDF with statistics
    - [ ] Use library like `reportlab` or `weasyprint`
- [ ] Task 10: Optimize performance (AC: 8)
  - [ ] Profile dashboard API endpoint with many changes
  - [ ] Optimize database queries:
    - [ ] Use indexes efficiently
    - [ ] Limit result sets with pagination
    - [ ] Use aggregation queries for statistics
  - [ ] Implement caching if needed (optional):
    - [ ] Cache statistics for short period (e.g., 5 minutes)
    - [ ] Invalidate cache on new changes
  - [ ] Ensure dashboard loads in < 3 seconds
- [ ] Task 11: Ensure responsive design (AC: 9)
  - [ ] Test dashboard on desktop (1920x1080, 1366x768)
  - [ ] Test dashboard on tablet (768x1024, 1024x768)
  - [ ] Adjust layout for smaller screens:
    - [ ] Stack statistics cards vertically on mobile
    - [ ] Make tables scrollable horizontally
    - [ ] Adjust font sizes for readability
  - [ ] Use Tailwind CSS responsive classes
- [ ] Task 12: Manual testing (AC: 10)
  - [ ] Test dashboard displays all sections correctly
  - [ ] Test filtering (date range, route, source, visa type, search)
  - [ ] Test pagination
  - [ ] Test export functionality (CSV, PDF if implemented)
  - [ ] Test statistics accuracy
  - [ ] Test responsive design

## Dev Notes

### Previous Story Insights
- Story 4.2 created basic dashboard with system overview
- Story 4.5 created change history view
- Story 4.6 created change detail page
- Story 5.5 added multi-route support to admin UI
- Story 3.5 created scheduled job system

### Current Dashboard
[Source: docs/stories/4.2.dashboard-home-screen.story.md]

**Current Features:**
- Total active route subscriptions
- Total active sources
- Changes detected in last 7 days
- Recent changes list (last 5-10)
- System health per source

**Enhancement Needed:**
- Expand to show last 30 days (configurable)
- Add filtering capabilities
- Add statistics and metrics
- Add export functionality

### Change History View
[Source: docs/stories/4.5.change-history-view.story.md]

**Current Features:**
- List of all detected policy changes
- Sorting and filtering
- Pagination
- Links to change details

**Enhancement Needed:**
- Enhanced filtering (date range, route, source, visa type, search)
- Statistics integration
- Export functionality

### PolicyChange Model
[Source: docs/architecture/data-models.md]

**PolicyChange Attributes:**
- `id`: UUID
- `sourceId`: UUID
- `detectedAt`: Date
- `diff`: string
- `oldVersionId`: UUID
- `newVersionId`: UUID

**Querying:**
- Can filter by source, date range
- Can join with RouteSubscription for route filtering
- Can search in `diff` field for text search

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to update:
- `api/routes/api.py` - Update dashboard endpoint
- `api/services/dashboard.py` - Enhance dashboard service
- `admin-ui/templates/pages/dashboard.html` - Update dashboard template
- `admin-ui/templates/pages/changes/list.html` - Enhance change history view

Files to create:
- `admin-ui/static/js/dashboard.js` - Dashboard filtering JavaScript (if needed)

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Database Access:**
- Always use Repository pattern
- Use async/await for all database operations
- Optimize queries with indexes

**Performance:**
- Use pagination for large result sets
- Optimize aggregation queries
- Consider caching for statistics

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Manual Testing:**
- Test dashboard displays correctly
- Test all filtering options
- Test export functionality
- Test statistics accuracy
- Test responsive design

### Technical Constraints
- Read-only design (no editing)
- Performance target: < 3 seconds
- Responsive design required (desktop and tablet)
- Must work with existing change history

## Testing

**Manual Testing:**
- View dashboard with various data volumes
- Test all filtering options (date range, route, source, visa type, search)
- Test pagination
- Test export functionality (CSV, PDF if implemented)
- Test statistics accuracy
- Test responsive design (desktop and tablet)
- Verify performance (< 3 seconds)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

