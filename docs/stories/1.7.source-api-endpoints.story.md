# Story 1.7: Source API Endpoints

## Status
Ready for Review

## Story
**As a** developer/admin,  
**I want** REST API endpoints for managing sources,  
**so that** I can configure and manage policy sources programmatically.

## Acceptance Criteria

1. `GET /api/sources` - List all sources (with pagination, filtering by country/visa_type)
2. `POST /api/sources` - Create new source:
   - Request body: country, visa_type, url, fetch_type, check_frequency
   - Validation: required fields, valid URL, valid fetch_type
   - Returns created source
3. `GET /api/sources/{id}` - Get specific source with metadata
4. `PUT /api/sources/{id}` - Update source configuration
5. `DELETE /api/sources/{id}` - Delete source (with cascade handling)
6. All endpoints require authentication
7. Proper HTTP status codes and error handling
8. Integration tests for all endpoints

## Tasks / Subtasks

- [x] Task 1: Create source service layer (AC: 1, 2, 3, 4, 5)
  - [x] Create `api/services/source_service.py` (optional, can use repositories directly)
  - [x] Implement business logic for source operations
  - [x] Handle duplicate source validation
  - [x] Handle cascade delete logic (related PolicyVersions, PolicyChanges)
- [x] Task 2: Create source API endpoints (AC: 1, 2, 3, 4, 5, 6)
  - [x] Update `api/routes/api.py` (or create separate source routes file)
  - [x] Implement `GET /api/sources` endpoint
    - [x] Accept pagination parameters (page, page_size)
    - [x] Accept filter parameters (country, visa_type, is_active)
    - [x] Use Source repository to list sources with filters
    - [x] Return paginated response
    - [x] Require authentication
  - [x] Implement `POST /api/sources` endpoint
    - [x] Accept SourceCreate schema
    - [x] Validate request data (Pydantic validation)
    - [x] Check for duplicate sources (url, country, visa_type)
    - [x] Create source via repository
    - [x] Return created source with 201 status
    - [x] Require authentication
  - [x] Implement `GET /api/sources/{id}` endpoint
    - [x] Accept source ID as path parameter
    - [x] Retrieve source by ID
    - [x] Include metadata (last_checked_at, last_change_detected_at)
    - [x] Return 404 if not found
    - [x] Return source data with 200 status
    - [x] Require authentication
  - [x] Implement `PUT /api/sources/{id}` endpoint
    - [x] Accept source ID and SourceUpdate schema
    - [x] Validate request data
    - [x] Check if source exists
    - [x] Update source via repository
    - [x] Return updated source with 200 status
    - [x] Return 404 if not found
    - [x] Require authentication
  - [x] Implement `DELETE /api/sources/{id}` endpoint
    - [x] Accept source ID as path parameter
    - [x] Check if source exists
    - [x] Delete source via repository (cascade handled by database)
    - [x] Return 204 No Content on success
    - [x] Return 404 if not found
    - [x] Require authentication
- [x] Task 3: Add request/response validation (AC: 2, 7)
  - [x] Ensure SourceCreate schema validates:
    - [x] country (required, 2 characters, valid country code)
    - [x] visa_type (required, non-empty string)
    - [x] url (required, valid URL format)
    - [x] fetch_type (required, enum: "html" | "pdf")
    - [x] check_frequency (required, enum: "daily" | "weekly" | "custom")
    - [x] name (required, non-empty string)
    - [x] metadata (optional, JSON object)
  - [x] Ensure SourceUpdate schema allows partial updates
  - [x] Return validation errors with 400 status
- [x] Task 4: Implement filtering logic (AC: 1)
  - [x] Add filter by country (query parameter)
  - [x] Add filter by visa_type (query parameter)
  - [x] Add filter by is_active (query parameter, boolean)
  - [x] Combine multiple filters (AND logic)
  - [x] Test filtering with various combinations
- [x] Task 5: Implement error handling (AC: 7)
  - [x] Handle 400 Bad Request (validation errors)
  - [x] Handle 401 Unauthorized (missing/invalid token)
  - [x] Handle 404 Not Found (source not found)
  - [x] Handle 409 Conflict (duplicate source)
  - [x] Return consistent error response format
  - [x] Include meaningful error messages
- [x] Task 6: Register routes in main application (AC: 1, 2, 3, 4, 5)
  - [x] Import source routes in `api/main.py` (if separate file)
  - [x] Include router in FastAPI app
  - [x] Verify routes are accessible
  - [x] Verify OpenAPI documentation includes routes
- [x] Task 7: Add OpenAPI documentation (AC: 7)
  - [x] Add route descriptions and summaries
  - [x] Add parameter descriptions (query params, path params)
  - [x] Add response model documentation
  - [x] Add example requests/responses
  - [x] Verify documentation accessible at `/docs`
- [x] Task 8: Create integration tests (AC: 8)
  - [x] Create `tests/integration/test_api/test_sources.py`
  - [x] Test GET /api/sources (list sources)
    - [x] Test with authentication
    - [x] Test without authentication (401)
    - [x] Test pagination
    - [x] Test filtering (country, visa_type, is_active)
  - [x] Test POST /api/sources (create source)
    - [x] Test with valid data
    - [x] Test with invalid data (400)
    - [x] Test duplicate source (409)
    - [x] Test without authentication (401)
  - [x] Test GET /api/sources/{id} (get source)
    - [x] Test with valid ID
    - [x] Test with invalid ID (404)
    - [x] Test without authentication (401)
  - [x] Test PUT /api/sources/{id} (update source)
    - [x] Test with valid data
    - [x] Test with invalid ID (404)
    - [x] Test partial update
    - [x] Test without authentication (401)
  - [x] Test DELETE /api/sources/{id} (delete source)
    - [x] Test with valid ID (204)
    - [x] Test with invalid ID (404)
    - [x] Test cascade delete (related records deleted)
    - [x] Test without authentication (401)

## Dev Notes

### Previous Story Insights
- Story 1.3 created Source repository with CRUD operations
- Story 1.6 implemented RouteSubscription API endpoints (similar pattern)
- Authentication system is available from Story 1.5
- Database cascade delete is configured in Story 1.2

### API Specification
[Source: architecture/api-specification.md]

**Source Endpoints:**

```
GET /api/sources
Query params: 
  - country (string, optional)
  - visaType (string, optional)
  - isActive (boolean, optional)
  - page (int, default 1)
  - page_size (int, default 20, max 100)
Response: {
  "items": [Source],
  "total": int,
  "page": int,
  "page_size": int
}

POST /api/sources
Request: {
  "country": "DE",
  "visaType": "Student",
  "url": "https://example.com/policy",
  "fetchType": "html",
  "checkFrequency": "daily",
  "name": "Germany Student Visa Source",
  "metadata": {}
}
Response: Source (201 Created)

GET /api/sources/{id}
Response: Source with metadata (200 OK) or 404 Not Found

PUT /api/sources/{id}
Request: {
  "url": "https://updated.com/policy",
  "isActive": false,
  ...
}
Response: Source (200 OK) or 404 Not Found

DELETE /api/sources/{id}
Response: 204 No Content or 404 Not Found
```

**Authentication:** All endpoints require Bearer token.

### Backend Architecture
[Source: architecture/backend-architecture.md]

**Route Handler Pattern:**
- Use dependency injection for authentication
- Use Pydantic models for validation
- Use HTTPException for errors
- Follow same pattern as RouteSubscription endpoints

### Data Models
[Source: architecture/data-models.md]

**Source Model:**
- `country`: string (2-char country code)
- `visaType`: string
- `url`: string (valid URL)
- `fetchType`: "html" | "pdf"
- `checkFrequency`: "daily" | "weekly" | "custom"
- `name`: string
- `metadata`: JSONB (flexible configuration)
- Unique constraint on (url, country, visa_type)

**Cascade Delete:**
- Deleting Source cascades to PolicyVersion and PolicyChange (configured in database schema)

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create/update:
- `api/routes/api.py` - Source API endpoints (or separate file)
- `api/services/source_service.py` - Optional service layer
- `tests/integration/test_api/test_sources.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Error Handling:** Raise HTTPException with proper status codes.

**Authentication:** Use `get_current_user` dependency.

**Pydantic Models:** Use SourceCreate, SourceUpdate, SourceResponse schemas.

**Type Hints:** All functions must have type hints.

**Async/Await:** Use async for all database operations.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test all CRUD operations
- Test filtering functionality
- Test authentication
- Test validation
- Test cascade delete
- Use FastAPI TestClient

### Technical Constraints
- All endpoints require authentication
- Pagination: page_size max 100
- Duplicate sources must be rejected (409 Conflict)
- Cascade delete handled by database (no manual cleanup needed)
- Filtering supports multiple parameters (AND logic)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_sources.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention
- Use async test fixtures

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test all CRUD operations
- Test filtering (country, visa_type, is_active, combinations)
- Test authentication (with/without token)
- Test validation (invalid URL, invalid enum values)
- Test duplicate source handling (409 Conflict)
- Test cascade delete (verify related records deleted)
- Test pagination
- Test error responses (400, 401, 404, 409)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Created source API endpoints with full CRUD operations
- Implemented pagination and filtering (country, visa_type, is_active) using SQL queries
- Added duplicate source validation using repository exists() method
- All endpoints require authentication using get_current_user dependency
- Error handling includes proper HTTP status codes (200, 201, 204, 400, 401, 404, 409)
- OpenAPI documentation added with descriptions, examples, and response models
- Comprehensive integration tests cover all endpoints, filtering, and error cases
- Cascade delete handled by database relationships (no manual cleanup needed)
- Used repositories directly in routes (skipped optional service layer per task notes)
- Separated routes and sources into different routers for better organization

### File List
**Created:**
- `tests/integration/test_api/test_sources.py` - Integration tests for source endpoints

**Modified:**
- `api/repositories/source_repository.py` - Added list_paginated() and exists() methods
- `api/routes/api.py` - Added source API endpoints and separated routers
- `api/main.py` - Registered sources_router

## QA Results
_To be populated by QA Agent_

