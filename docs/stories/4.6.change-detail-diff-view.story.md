# Story 4.6: Change Detail/Diff View

## Status
Draft

## Story
**As an** admin user,  
**I want** a page showing the full diff for a specific policy change,  
**so that** I can see exactly what changed in the policy.

## Acceptance Criteria

1. Change detail page displays:
   - Route information (origin → destination, visa_type)
   - Source name and URL (link to original source)
   - Detected timestamp
   - Full text diff (formatted for readability)
2. Diff display options:
   - Unified diff format (side-by-side or inline)
   - Syntax highlighting if possible (but not required)
   - Line numbers
3. Previous version and new version displayed (if space allows)
4. Link to download diff as text file (optional)
5. Navigation: back to change history, next/previous change
6. Page loads diff efficiently (even for large documents)
7. Manual test: view diff, verify formatting is readable

## Tasks / Subtasks

- [ ] Task 1: Create change detail API endpoint (AC: 1)
  - [ ] Create or update `api/routes/api.py`
  - [ ] Implement `GET /api/changes/{id}` endpoint
  - [ ] Fetch PolicyChange by ID
  - [ ] Include related data:
    - [ ] RouteSubscription information
    - [ ] Source information
    - [ ] Old and new PolicyVersion records
    - [ ] Full diff text
  - [ ] Return change detail as JSON
  - [ ] Require authentication
- [ ] Task 2: Create change detail service (AC: 1)
  - [ ] Create or update `api/services/change.py`
  - [ ] Implement `get_change_detail(change_id)` function
  - [ ] Fetch PolicyChange with all related data
  - [ ] Format route information for display
  - [ ] Return structured change detail
- [ ] Task 3: Create change detail template (AC: 1, 2, 3)
  - [ ] Create `admin-ui/templates/pages/changes/detail.html`
  - [ ] Display change metadata:
    - [ ] Route information (origin → destination, visa_type)
    - [ ] Source name and URL (as clickable link)
    - [ ] Detected timestamp
  - [ ] Display diff:
    - [ ] Use `<pre>` tag or code block for diff text
    - [ ] Apply CSS styling for readability
    - [ ] Add line numbers (if possible)
    - [ ] Format unified diff nicely
  - [ ] Display previous and new versions (if space allows):
    - [ ] Side-by-side layout (optional)
    - [ ] Or toggle between old/new versions
  - [ ] Use Tailwind CSS for styling
- [ ] Task 4: Create change detail web route (AC: 1)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /changes/{id}` route
    - [ ] Fetch change detail from API (`/api/changes/{id}`)
    - [ ] Render change detail template
    - [ ] Require authentication
- [ ] Task 5: Format diff for display (AC: 2)
  - [ ] Create or update `admin-ui/static/js/diff.js` (optional)
  - [ ] Format unified diff text:
    - [ ] Highlight added lines (green background)
    - [ ] Highlight removed lines (red background)
    - [ ] Highlight context lines (gray background)
    - [ ] Add line numbers
  - [ ] Or use CSS classes for diff formatting
  - [ ] Ensure diff is readable (monospace font, proper spacing)
- [ ] Task 6: Add navigation controls (AC: 5)
  - [ ] Add "Back to Change History" button/link
  - [ ] Add "Previous Change" button (if available)
  - [ ] Add "Next Change" button (if available)
  - [ ] Calculate previous/next changes based on current change's detected_at
  - [ ] Link to previous/next change detail pages
- [ ] Task 7: Add download diff functionality (optional, AC: 4)
  - [ ] Add "Download Diff" button to change detail page
  - [ ] Create `GET /api/changes/{id}/download` endpoint:
    - [ ] Return diff as plain text file
    - [ ] Set Content-Type: text/plain
    - [ ] Set Content-Disposition: attachment
  - [ ] Trigger download in browser
- [ ] Task 8: Optimize diff loading (AC: 6)
  - [ ] Ensure diff text is loaded efficiently:
    - [ ] Diff is stored in PolicyChange.diff field (from Story 2.7)
    - [ ] No additional processing needed (already generated)
  - [ ] For very large diffs:
    - [ ] Consider truncating display (show first N lines)
    - [ ] Add "Show More" button
    - [ ] Or use virtual scrolling
  - [ ] Test with large diffs (10,000+ lines)
- [ ] Task 9: Add version display (AC: 3)
  - [ ] Display old and new PolicyVersion content:
    - [ ] Show raw text from old_version and new_version
    - [ ] Use side-by-side layout or toggle
    - [ ] Format text nicely (monospace, line numbers)
  - [ ] Make versions collapsible/expandable (optional)
- [ ] Task 10: Manual testing (AC: 7)
  - [ ] Test change detail page displays correctly
  - [ ] Test diff formatting is readable
  - [ ] Test navigation (back, previous, next)
  - [ ] Test with small diffs
  - [ ] Test with large diffs
  - [ ] Test download functionality (if implemented)
  - [ ] Test version display

## Dev Notes

### Previous Story Insights
- Story 4.5 created change history view
- Story 2.7 created text diff generation
- Story 2.8 created PolicyChange records with diff
- Story 1.3 created PolicyChange repository

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/changes/{id}        → Change detail with diff
```

**API Client:**
- `api.getChange(id)` - Get single change detail

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/change.py` - Update with change detail function
- `api/routes/api.py` - Add change detail endpoint
- `api/routes/web.py` - Add change detail web route
- `admin-ui/templates/pages/changes/detail.html` - Change detail template
- `admin-ui/static/js/diff.js` - Diff formatting (optional)

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test change detail API endpoint
- Test change detail web route
- Test diff formatting

**Manual Testing:**
- Test change detail display
- Test diff readability
- Test navigation
- Test with various diff sizes

### Technical Constraints
- Must handle large diffs efficiently
- Must format diff for readability
- Must be responsive
- Diff is already generated (from Story 2.7), just needs display

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_changes.py` and `tests/integration/test_web/test_changes.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test change detail API endpoint
- Test change detail web route
- Test diff display
- Test navigation
- Manual test: verify diff readability and functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



