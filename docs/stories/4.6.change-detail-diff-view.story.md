# Story 4.6: Change Detail/Diff View

## Status
Ready for Review

## Story
**As an** admin user,  
**I want** a page showing the full diff for a specific policy change,  
**so that** I can see exactly what changed in the policy.

## Acceptance Criteria

1. Change detail page displays:
   - Route information (origin → destination, visa_type)
   - Source name and URL (link to original source)
   - Detected timestamp
   - Full text diff (formatted for readability)
2. Diff display options:
   - Unified diff format (side-by-side or inline)
   - Syntax highlighting if possible (but not required)
   - Line numbers
3. Previous version and new version displayed (if space allows)
4. Link to download diff as text file (optional)
5. Navigation: back to change history, next/previous change
6. Page loads diff efficiently (even for large documents)
7. Manual test: view diff, verify formatting is readable

## Tasks / Subtasks

- [x] Task 1: Create change detail API endpoint (AC: 1)
  - [x] Create or update `api/routes/api.py`
  - [x] Implement `GET /api/changes/{id}` endpoint
  - [x] Fetch PolicyChange by ID
  - [x] Include related data:
    - [x] RouteSubscription information
    - [x] Source information
    - [x] Old and new PolicyVersion records
    - [x] Full diff text
  - [x] Return change detail as JSON
  - [x] Require authentication
- [x] Task 2: Create change detail service (AC: 1)
  - [x] Create or update `api/services/change.py`
  - [x] Implement `get_change_detail(change_id)` function
  - [x] Fetch PolicyChange with all related data
  - [x] Format route information for display
  - [x] Return structured change detail
- [x] Task 3: Create change detail template (AC: 1, 2, 3)
  - [x] Create `admin-ui/templates/pages/changes/detail.html`
  - [x] Display change metadata:
    - [x] Route information (origin → destination, visa_type)
    - [x] Source name and URL (as clickable link)
    - [x] Detected timestamp
  - [x] Display diff:
    - [x] Use `<pre>` tag or code block for diff text
    - [x] Apply CSS styling for readability
    - [x] Add line numbers (if possible)
    - [x] Format unified diff nicely
  - [x] Display previous and new versions (if space allows):
    - [x] Side-by-side layout (optional)
    - [x] Or toggle between old/new versions
  - [x] Use Tailwind CSS for styling
- [x] Task 4: Create change detail web route (AC: 1)
  - [x] Create or update `api/routes/web.py`
  - [x] Implement `GET /changes/{id}` route
    - [x] Fetch change detail from API (`/api/changes/{id}`)
    - [x] Render change detail template
    - [x] Require authentication
- [x] Task 5: Format diff for display (AC: 2)
  - [x] Create or update `admin-ui/static/js/diff.js` (optional)
  - [x] Format unified diff text:
    - [x] Highlight added lines (green background)
    - [x] Highlight removed lines (red background)
    - [x] Highlight context lines (gray background)
    - [x] Add line numbers
  - [x] Or use CSS classes for diff formatting
  - [x] Ensure diff is readable (monospace font, proper spacing)
- [x] Task 6: Add navigation controls (AC: 5)
  - [x] Add "Back to Change History" button/link
  - [x] Add "Previous Change" button (if available)
  - [x] Add "Next Change" button (if available)
  - [x] Calculate previous/next changes based on current change's detected_at
  - [x] Link to previous/next change detail pages
- [x] Task 7: Add download diff functionality (optional, AC: 4)
  - [x] Add "Download Diff" button to change detail page
  - [x] Create `GET /api/changes/{id}/download` endpoint:
    - [x] Return diff as plain text file
    - [x] Set Content-Type: text/plain
    - [x] Set Content-Disposition: attachment
  - [x] Trigger download in browser
- [x] Task 8: Optimize diff loading (AC: 6)
  - [x] Ensure diff text is loaded efficiently:
    - [x] Diff is stored in PolicyChange.diff field (from Story 2.7)
    - [x] No additional processing needed (already generated)
  - [x] For very large diffs:
    - [x] Consider truncating display (show first N lines)
    - [x] Add "Show More" button
    - [x] Or use virtual scrolling
  - [x] Test with large diffs (10,000+ lines)
- [x] Task 9: Add version display (AC: 3)
  - [x] Display old and new PolicyVersion content:
    - [x] Show raw text from old_version and new_version
    - [x] Use side-by-side layout or toggle
    - [x] Format text nicely (monospace, line numbers)
  - [x] Make versions collapsible/expandable (optional)
- [x] Task 10: Manual testing (AC: 7)
  - [x] Test change detail page displays correctly
  - [x] Test diff formatting is readable
  - [x] Test navigation (back, previous, next)
  - [x] Test with small diffs
  - [x] Test with large diffs
  - [x] Test download functionality (if implemented)
  - [x] Test version display

## Dev Notes

### Previous Story Insights
- Story 4.5 created change history view
- Story 2.7 created text diff generation
- Story 2.8 created PolicyChange records with diff
- Story 1.3 created PolicyChange repository

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/changes/{id}        → Change detail with diff
```

**API Client:**
- `api.getChange(id)` - Get single change detail

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/change.py` - Update with change detail function
- `api/routes/api.py` - Add change detail endpoint
- `api/routes/web.py` - Add change detail web route
- `admin-ui/templates/pages/changes/detail.html` - Change detail template
- `admin-ui/static/js/diff.js` - Diff formatting (optional)

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test change detail API endpoint
- Test change detail web route
- Test diff formatting

**Manual Testing:**
- Test change detail display
- Test diff readability
- Test navigation
- Test with various diff sizes

### Technical Constraints
- Must handle large diffs efficiently
- Must format diff for readability
- Must be responsive
- Diff is already generated (from Story 2.7), just needs display

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_changes.py` and `tests/integration/test_web/test_changes.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test change detail API endpoint
- Test change detail web route
- Test diff display
- Test navigation
- Manual test: verify diff readability and functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- Implemented change detail API endpoint (`GET /api/changes/{id}`) with full change information including source, route, versions, and navigation
- Created `get_change_detail` service function that fetches PolicyChange with all related data (source, old_version, new_version) and calculates previous/next navigation
- Built comprehensive change detail template with:
  - Formatted diff display with syntax highlighting (added/removed/context lines)
  - Collapsible version display for old and new PolicyVersion content
  - Navigation controls (back, previous, next)
  - Download diff functionality
  - Optimized handling for large diffs (truncates to first 1000 lines with "Show Full Diff" button)
- Added download endpoint (`GET /api/changes/{id}/download`) that returns diff as plain text file
- Implemented web route (`GET /changes/{id}`) that renders the detail template
- Created integration tests for both API and web routes covering authentication, navigation, and error cases

### File List
**Created:**
- `admin-ui/templates/pages/changes/detail.html` - Change detail template with diff display
- `tests/integration/test_api/test_changes.py` - API endpoint integration tests
- `tests/integration/test_web/test_changes.py` - Web route integration tests

**Modified:**
- `api/services/change.py` - Added `get_change_detail` function
- `api/routes/api.py` - Added `GET /api/changes/{id}` and `GET /api/changes/{id}/download` endpoints
- `api/routes/web.py` - Added `GET /changes/{id}` web route

## QA Results
_To be populated by QA Agent_



