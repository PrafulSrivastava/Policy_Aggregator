# Story 4.14: View Route Diff

## Status
Ready for Review

## Story
**As a** user,  
**I want** to see what changed in a route between versions,  
**so that** I can understand policy updates.

## Acceptance Criteria

1. Calls `GET /api/routes/{route_id}/diff` endpoint (if exists) OR `GET /api/changes/{change_id}` for route changes
2. Clearly highlights: Added, Removed, Modified elements
3. Must be scoped to the user's route only
4. Diff displayed in readable format (unified diff or side-by-side)
5. Loading state while fetching diff
6. Error state if API call fails
7. Empty state if no changes found
8. Shows source attribution and timestamp
9. Link to original source URL
10. Can navigate to change detail from routes view

## Tasks / Subtasks

- [x] Task 1: Check backend API for route diff
  - [x] Verify endpoint: `GET /api/routes/{route_id}/diff` or use changes endpoint
  - [x] If using changes: `GET /api/changes?route_id={route_id}`
  - [x] Document API approach
- [x] Task 2: Create changes/diff service (AC: 1)
  - [x] Add `getChangesForRoute(routeId)` to `src/services/changes.ts`
  - [x] Add `getChangeDetail(changeId)` for full diff
  - [x] Handle API response
- [x] Task 3: Create diff display component (AC: 2, 4)
  - [x] Create `src/components/changes/DiffView.tsx`
  - [x] Implement unified diff display:
    - [x] Added lines: green background, + prefix
    - [x] Removed lines: red background, - prefix
    - [x] Context lines: normal background
  - [x] Use monospace font (JetBrains Mono)
  - [x] Apply design system (sharp corners, black borders)
- [x] Task 4: Create route changes page (AC: 5, 6, 7, 8, 9)
  - [x] Create `src/pages/routes/Changes.tsx`
  - [x] Fetch changes for route
  - [x] Display list of changes with timestamps
  - [x] Link to change detail view
  - [x] Show source information
  - [x] Show empty state if no changes
- [x] Task 5: Integrate with routes list (AC: 10)
  - [x] Add "View Changes" button to route detail page
  - [x] Navigate to route changes page
- [x] Task 6: Create unit tests (AC: All)
  - [x] Test diff component rendering
  - [x] Test changes fetching
  - [x] Test empty state
  - [x] Test error handling
- [ ] Task 7: Manual testing (AC: All)
  - [ ] Test viewing route diff
  - [ ] Test diff display format
  - [ ] Test empty state
  - [ ] Test error handling
  - [ ] Test navigation from routes list

## Dev Notes

### API Specifications
[Source: architecture/api-specification.md]

**Changes Endpoint:**
- `GET /api/changes?routeId={uuid}` - List changes filtered by route
- Response: `{items: [PolicyChange], total: int, page: int, page_size: int}`
- PolicyChange includes: `id, detected_at, diff, source, route`

**Change Detail Endpoint:**
- `GET /api/changes/{change_id}` - Get specific change with full diff
- Response includes: `diff, old_version, new_version, source, route`

### Design System
[Source: .ignore/design_prompt.md]

**Diff Display:**
- Monospace font (JetBrains Mono)
- Sharp corners
- Color coding: green for additions, red for deletions
- Line numbers optional

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/components/changes/DiffView.test.js`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes
- All implementation tasks completed (Tasks 1-6)
- Task 7 (Manual testing) pending - requires user/QA verification
- All unit tests passing
- Uses `GET /api/changes?route_id={uuid}` endpoint (note: uses `route_id` not `routeId`)
- Unified diff display with color coding (green for additions, red for deletions)
- Route changes page shows list of changes with source attribution and timestamps
- Change detail page shows full diff with navigation between changes
- Integrated with route detail page via "View Changes" button
- All error cases handled (404, API errors)
- Empty states handled gracefully

### API Approach Documentation
**Finding:** No explicit `GET /api/routes/{route_id}/diff` endpoint exists.

**Solution:**
- Use `GET /api/changes?route_id={uuid}` to list changes for a route
- Use `GET /api/changes/{change_id}` to get full diff for a specific change
- API uses `route_id` query parameter (not `routeId`)
- Changes are automatically scoped to user's routes (backend enforces this)

### File List
**New Files:**
- `frontend/src/services/changes.ts` - Changes service with getChanges, getChangesForRoute, getChangeDetail
- `frontend/src/components/changes/DiffView.tsx` - Unified diff display component
- `frontend/src/pages/routes/Changes.tsx` - Route changes list page
- `frontend/src/pages/changes/Detail.tsx` - Change detail page with full diff
- `frontend/src/__tests__/services/changes.test.ts` - Unit tests for changes service
- `frontend/src/__tests__/components/changes/DiffView.test.tsx` - Unit tests for DiffView component

**Modified Files:**
- `frontend/src/App.tsx` - Added routes for `/routes/:routeId/changes` and `/changes/:changeId`
- `frontend/src/pages/routes/Detail.tsx` - Added "View Changes" button

### Debug Log References
- No blocking issues encountered
- All TypeScript types properly defined
- All linting checks passed
- Tests passing successfully

## QA Results
_To be populated by QA Agent_

