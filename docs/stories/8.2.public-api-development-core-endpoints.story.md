# Story 8.2: Public API Development - Core Endpoints

## Status
Draft

## Story
**As a** developer/integrator,  
**I want** a RESTful API to access policy change data,  
**so that** I can integrate monitoring into my own systems.

## Acceptance Criteria

1. API authentication:
   - API key authentication
   - OAuth 2.0 support (optional, future)
   - Secure key storage and management
2. Core API endpoints:
   - `GET /api/v1/routes` - List routes
   - `GET /api/v1/routes/{id}` - Get route details
   - `GET /api/v1/sources` - List sources
   - `GET /api/v1/sources/{id}` - Get source details
   - `GET /api/v1/changes` - List policy changes (with filtering)
   - `GET /api/v1/changes/{id}` - Get change details with diff
   - `GET /api/v1/subscriptions` - List subscriptions (authenticated user)
3. API response format:
   - JSON responses
   - Consistent error format
   - Pagination for list endpoints
   - Filtering and sorting options
4. API versioning:
   - Version in URL (`/api/v1/`)
   - Versioning strategy documented
   - Backward compatibility considerations
5. API documentation:
   - OpenAPI/Swagger specification
   - Interactive API documentation
   - Endpoint descriptions and examples
   - Authentication guide
6. Error handling:
   - Standard HTTP status codes
   - Meaningful error messages
   - Error response format consistent
7. Rate limiting:
   - Rate limits per API key
   - Rate limit headers in responses
   - Clear rate limit documentation
8. Unit tests for all API endpoints
9. Integration test: Call API endpoints, verify responses

## Tasks / Subtasks

- [ ] Task 1: Create API key model (AC: 1)
  - [ ] Create Alembic migration for `api_keys` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users)
    - [ ] `key_hash`: VARCHAR(255) (hashed API key)
    - [ ] `key_prefix`: VARCHAR(20) (first 8 chars for display)
    - [ ] `name`: VARCHAR(255) (key name/description)
    - [ ] `is_active`: BOOLEAN
    - [ ] `last_used_at`: TIMESTAMP WITH TIME ZONE (nullable)
    - [ ] `expires_at`: TIMESTAMP WITH TIME ZONE (nullable)
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/api_key.py`
  - [ ] Create repository: `api/repositories/api_key_repository.py`
- [ ] Task 2: Create API key generation service (AC: 1)
  - [ ] Create `api/services/api_key_service.py`
  - [ ] Implement `generate_api_key(user_id: UUID, name: str) -> Tuple[str, APIKey]`:
    - [ ] Generate secure random key (32+ characters)
    - [ ] Hash key using bcrypt or similar
    - [ ] Store hashed key in database
    - [ ] Return plain key (only shown once) and APIKey record
  - [ ] Implement key validation: `validate_api_key(key: str) -> Optional[APIKey]`
- [ ] Task 3: Create API key authentication middleware (AC: 1)
  - [ ] Create `api/middleware/api_auth.py`
  - [ ] Implement `get_api_user(api_key: str, db: AsyncSession) -> Optional[User]`:
    - [ ] Extract API key from request header (`X-API-Key` or `Authorization: Bearer`)
    - [ ] Validate API key
    - [ ] Return associated user
  - [ ] Create FastAPI dependency: `get_api_authenticated_user`
  - [ ] Update `last_used_at` on successful authentication
- [ ] Task 4: Create API key management endpoints (AC: 1)
  - [ ] Create `GET /api/api-keys` - List user's API keys
  - [ ] Create `POST /api/api-keys` - Generate new API key
  - [ ] Create `DELETE /api/api-keys/{id}` - Revoke API key
  - [ ] Require user authentication (JWT)
  - [ ] Return key prefix only (never full key after creation)
- [ ] Task 5: Create API key management UI (AC: 1)
  - [ ] Create `admin-ui/templates/pages/settings/api-keys.html` - API key management page
  - [ ] Create web route: `GET /settings/api-keys`
  - [ ] Display list of API keys:
    - [ ] Key name, prefix, created date, last used
    - [ ] Revoke button
  - [ ] Add "Generate New API Key" button
  - [ ] Show full key only once after generation (copy to clipboard)
- [ ] Task 6: Create public API v1 routes (AC: 2)
  - [ ] Create `api/routes/api_v1.py` - Public API v1 routes
  - [ ] Implement endpoints:
    - [ ] `GET /api/v1/routes` - List routes (public, no auth required or filtered)
    - [ ] `GET /api/v1/routes/{id}` - Get route details
    - [ ] `GET /api/v1/sources` - List sources
    - [ ] `GET /api/v1/sources/{id}` - Get source details
    - [ ] `GET /api/v1/changes` - List policy changes (with filtering)
    - [ ] `GET /api/v1/changes/{id}` - Get change details with diff
    - [ ] `GET /api/v1/subscriptions` - List user's subscriptions (requires auth)
  - [ ] Use API key authentication dependency
- [ ] Task 7: Implement API response format (AC: 3)
  - [ ] Create consistent response schemas:
    - [ ] `PaginatedResponse[T]` - For list endpoints
    - [ ] `ErrorResponse` - For error responses
    - [ ] Standard success response format
  - [ ] Implement pagination:
    - [ ] Query params: `page`, `page_size`
    - [ ] Response includes: `items`, `total`, `page`, `page_size`
  - [ ] Implement filtering and sorting:
    - [ ] Query params for filtering (e.g., `route_id`, `source_id`, `date_from`, `date_to`)
    - [ ] Query param for sorting (e.g., `sort_by`, `sort_order`)
- [ ] Task 8: Implement API versioning (AC: 4)
  - [ ] Create API router with version prefix: `/api/v1/`
  - [ ] Document versioning strategy:
    - [ ] URL-based versioning
    - [ ] Backward compatibility policy
    - [ ] Deprecation process
  - [ ] Add version header to responses (optional)
- [ ] Task 9: Create OpenAPI/Swagger documentation (AC: 5)
  - [ ] FastAPI automatically generates OpenAPI spec
  - [ ] Enhance OpenAPI spec:
    - [ ] Add detailed descriptions
    - [ ] Add request/response examples
    - [ ] Add authentication documentation
  - [ ] Access at `/api/v1/docs` (Swagger UI)
  - [ ] Access at `/api/v1/redoc` (ReDoc)
- [ ] Task 10: Implement error handling (AC: 6)
  - [ ] Create consistent error response format:
    - [ ] `error`: Object with `code`, `message`, `details`
    - [ ] Standard HTTP status codes
  - [ ] Create error handlers:
    - [ ] 400 Bad Request
    - [ ] 401 Unauthorized
    - [ ] 403 Forbidden
    - [ ] 404 Not Found
    - [ ] 429 Too Many Requests
    - [ ] 500 Internal Server Error
  - [ ] Add meaningful error messages
- [ ] Task 11: Implement rate limiting (AC: 7)
  - [ ] Create rate limiting middleware or dependency
  - [ ] Track API usage per API key:
    - [ ] Requests per minute/hour/day
    - [ ] Store in database or cache (Redis if available)
  - [ ] Enforce limits:
    - [ ] Return 429 Too Many Requests if limit exceeded
    - [ ] Add rate limit headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
  - [ ] Configure limits per subscription tier
- [ ] Task 12: Create unit tests (AC: 8)
  - [ ] Create `tests/unit/test_api_v1/` - Unit tests for API endpoints
  - [ ] Test all endpoints with mock authentication
  - [ ] Test error handling
  - [ ] Test rate limiting
  - [ ] Use `pytest` and `pytest-mock`
- [ ] Task 13: Create integration tests (AC: 9)
  - [ ] Create `tests/integration/test_api_v1/` - Integration tests
  - [ ] Test API key authentication
  - [ ] Test all endpoints with real database
  - [ ] Test pagination, filtering, sorting
  - [ ] Test rate limiting

## Dev Notes

### Previous Story Insights
- Story 1.5 created JWT authentication system
- Story 1.6 created RouteSubscription API endpoints
- Story 1.7 created Source API endpoints
- Story 4.6 created Change detail API endpoint
- Story 1.4 created FastAPI application setup

### Authentication System
[Source: docs/stories/1.5.authentication-system.story.md]

**Current Authentication:**
- JWT-based authentication for admin UI
- Bearer token in Authorization header
- Token in cookie for web requests

**API Key Authentication:**
- New authentication method for public API
- API keys stored hashed in database
- Similar pattern to password hashing (bcrypt)

### FastAPI Application
[Source: docs/stories/1.4.fastapi-application-setup-and-health-check-endpoint.story.md]

**FastAPI Features:**
- Automatic OpenAPI/Swagger documentation
- Dependency injection for authentication
- Request/response models with Pydantic

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `api/models/db/api_key.py` - API key model
- `api/repositories/api_key_repository.py` - API key repository
- `api/services/api_key_service.py` - API key service
- `api/middleware/api_auth.py` - API authentication middleware
- `api/routes/api_v1.py` - Public API v1 routes
- `admin-ui/templates/pages/settings/api-keys.html` - API key management UI
- `tests/unit/test_api_v1/` - Unit tests
- `tests/integration/test_api_v1/` - Integration tests
- `alembic/versions/XXX_add_api_keys.py` - Migration

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**API Design:**
- RESTful API design
- Consistent response formats
- Proper HTTP status codes
- Clear error messages

**Security:**
- API keys stored hashed (never plain text)
- HTTPS required
- Rate limiting enforced
- Input validation

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Unit Tests:**
- Test API endpoints with mocks
- Test authentication
- Test error handling

**Integration Tests:**
- Test with real database
- Test authentication flow
- Test rate limiting

## Testing

**Unit Tests:**
- Test all API endpoints
- Test authentication
- Test error handling
- Test rate limiting

**Integration Tests:**
- Test API key generation and validation
- Test all endpoints with real database
- Test pagination, filtering, sorting
- Test rate limiting enforcement

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |



