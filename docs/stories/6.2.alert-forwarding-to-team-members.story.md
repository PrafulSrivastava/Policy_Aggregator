# Story 6.2: Alert Forwarding to Team Members

## Status
Draft

## Story
**As an** admin user,  
**I want** to forward email alerts to team members,  
**so that** I can share policy change notifications with my team without manual forwarding.

## Acceptance Criteria

1. Forward alert functionality in email:
   - "Forward to Team" button/link in email alerts
   - Opens forwarding interface (web form or email reply)
2. Forwarding interface:
   - List of team member emails (configurable per organization)
   - Select one or multiple recipients
   - Optional message/note field
   - Send button
3. Forwarded email includes:
   - Original alert content (route, source, timestamp, diff preview)
   - Forwarder's name/email
   - Optional note from forwarder
   - Link to full diff
4. Team member management:
   - Add team member emails (admin UI)
   - Remove team members
   - List of current team members
5. Forwarding tracking:
   - Log all forwarded alerts (who forwarded, to whom, when)
   - View forwarding history in admin UI
6. Email delivery:
   - Forwarded emails sent via same email service
   - Proper "From" and "Reply-To" headers
7. Privacy: Team member emails stored securely, not shared
8. Manual test: Forward alert to team member, verify delivery and tracking

## Tasks / Subtasks

- [ ] Task 1: Create team member database model (AC: 4, 7)
  - [ ] Create Alembic migration for `team_members` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users, nullable for MVP - single admin)
    - [ ] `email`: VARCHAR(255) (team member email, unique per user)
    - [ ] `name`: VARCHAR(255) (optional, team member name)
    - [ ] `is_active`: BOOLEAN (whether team member is active)
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/team_member.py`
  - [ ] Add indexes: `idx_team_members_user_id`, `idx_team_members_email`
- [ ] Task 2: Create team member repository (AC: 4)
  - [ ] Create `api/repositories/team_member_repository.py`
  - [ ] Implement CRUD operations:
    - [ ] `create(team_member_data)` - Add team member
    - [ ] `get_by_id(team_member_id)` - Get team member
    - [ ] `list_by_user(user_id)` - List team members for user
    - [ ] `update(team_member_id, updates)` - Update team member
    - [ ] `delete(team_member_id)` - Remove team member
  - [ ] Add validation: email format, uniqueness per user
- [ ] Task 3: Create team member API endpoints (AC: 4)
  - [ ] Create `GET /api/team-members` - List team members
  - [ ] Create `POST /api/team-members` - Add team member
  - [ ] Create `PUT /api/team-members/{id}` - Update team member
  - [ ] Create `DELETE /api/team-members/{id}` - Remove team member
  - [ ] Require authentication
  - [ ] Return team member data as JSON
- [ ] Task 4: Create team member management UI (AC: 4)
  - [ ] Create `admin-ui/templates/pages/team-members/list.html` - Team member list page
  - [ ] Create `admin-ui/templates/pages/team-members/form.html` - Add/edit team member form
  - [ ] Add "Team Members" link to admin navigation
  - [ ] Display list of team members with email and name
  - [ ] Add "Add Team Member" button
  - [ ] Add edit and delete buttons for each team member
  - [ ] Create web routes: `GET /team-members`, `GET /team-members/new`, `GET /team-members/{id}/edit`
- [ ] Task 5: Add "Forward to Team" link to email alerts (AC: 1)
  - [ ] Update email template: `admin-ui/templates/emails/change_alert.html`
  - [ ] Add "Forward to Team" button/link
  - [ ] Link points to forwarding interface: `/alerts/{change_id}/forward`
  - [ ] Include change_id and route_subscription_id in link (as query params or path)
- [ ] Task 6: Create forwarding interface (AC: 2)
  - [ ] Create `admin-ui/templates/pages/alerts/forward.html` - Forwarding form
  - [ ] Create web route: `GET /alerts/{change_id}/forward`
  - [ ] Display forwarding form:
    - [ ] List of team member emails (checkboxes or multi-select)
    - [ ] Optional message/note field (textarea)
    - [ ] "Send" button
  - [ ] Fetch team members from API
  - [ ] Pre-fill change information (route, source, timestamp)
- [ ] Task 7: Create forwarding API endpoint (AC: 2, 3, 6)
  - [ ] Create `POST /api/alerts/{change_id}/forward` endpoint
  - [ ] Accept request body:
    - [ ] `recipient_emails`: List[str] (team member emails)
    - [ ] `note`: Optional[str] (forwarder's note)
  - [ ] Validate recipient emails (must be team members)
  - [ ] Get original alert content (from PolicyChange and RouteSubscription)
  - [ ] Generate forwarded email content:
    - [ ] Include original alert content
    - [ ] Add forwarder's name/email
    - [ ] Add optional note
    - [ ] Include link to full diff
  - [ ] Send forwarded emails via email service (Resend)
  - [ ] Create EmailAlert records for forwarded emails
- [ ] Task 8: Create forwarded email template (AC: 3)
  - [ ] Create `admin-ui/templates/emails/forwarded_alert.html` - HTML template
  - [ ] Create `admin-ui/templates/emails/forwarded_alert.txt` - Plain text template
  - [ ] Template includes:
    - [ ] Original alert content (route, source, timestamp, diff preview)
    - [ ] Forwarder's name/email
    - [ ] Optional note from forwarder
    - [ ] Link to full diff
  - [ ] Use EmailTemplateService to render template
- [ ] Task 9: Create forwarding tracking (AC: 5)
  - [ ] Create Alembic migration for `alert_forwards` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `email_alert_id`: UUID (foreign key to email_alerts)
    - [ ] `forwarder_email`: VARCHAR(255) (who forwarded)
    - [ ] `recipient_email`: VARCHAR(255) (who received forwarded email)
    - [ ] `note`: TEXT (optional note from forwarder)
    - [ ] `forwarded_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/alert_forward.py`
  - [ ] Log forwarding when email is sent
- [ ] Task 10: Create forwarding history UI (AC: 5)
  - [ ] Create `admin-ui/templates/pages/alerts/forward-history.html` - Forwarding history page
  - [ ] Create web route: `GET /alerts/forward-history`
  - [ ] Display forwarding history table:
    - [ ] Original alert (link to change detail)
    - [ ] Forwarder email
    - [ ] Recipient email
    - [ ] Note (if provided)
    - [ ] Forwarded timestamp
  - [ ] Add filtering (by forwarder, recipient, date range)
  - [ ] Add "Forwarding History" link to admin navigation
- [ ] Task 11: Configure email headers (AC: 6)
  - [ ] Update email sending service to set proper headers:
    - [ ] `From`: System email (e.g., alerts@policyaggregator.com)
    - [ ] `Reply-To`: Forwarder's email (if available)
  - [ ] Ensure forwarded emails are clearly marked
- [ ] Task 12: Manual testing (AC: 8)
  - [ ] Test: Add team member via admin UI
  - [ ] Test: Forward alert to team member
  - [ ] Test: Verify forwarded email received
  - [ ] Test: Verify forwarding history recorded
  - [ ] Test: Verify email headers correct

## Dev Notes

### Previous Story Insights
- Story 3.2 created email template system with Jinja2
- Story 3.3 created email sending service integration (Resend)
- Story 3.4 created alert engine that sends emails
- Story 3.6 created EmailAlert record storage
- Story 4.1 created admin UI foundation

### Email Template System
[Source: docs/stories/3.2.email-template-system.story.md]

**Email Templates:**
- Jinja2 templates in `admin-ui/templates/emails/`
- HTML and plain text versions
- EmailTemplateService for rendering
- Templates can be updated without code changes

**Current Email Template:**
- `change_alert.html` - Policy change alert template
- Includes route, source, timestamp, diff preview, link to full diff

### Email Sending Service
[Source: docs/stories/3.3.email-sending-service-integration.story.md]

**Email Service:**
- Resend API for sending emails
- `send_email(recipient, subject, html_body, text_body)` function
- Returns success/failure status and message ID
- Error handling and retry logic

### EmailAlert Model
[Source: docs/architecture/database-schema.md]

**EmailAlert Table:**
- `id`: UUID (primary key)
- `policy_change_id`: UUID (foreign key)
- `route_subscription_id`: UUID (foreign key)
- `sent_at`: TIMESTAMP WITH TIME ZONE
- `email_provider`: VARCHAR(50) (default 'resend')
- `email_provider_id`: VARCHAR(255) (Resend email ID)
- `status`: VARCHAR(20) ('sent', 'failed', 'bounced')
- `error_message`: TEXT

### User Model
[Source: api/models/db/user.py]

**User Table:**
- `id`: UUID (primary key)
- `username`: VARCHAR(100) (unique)
- `hashed_password`: VARCHAR(255)
- `is_active`: BOOLEAN
- `created_at`, `updated_at`, `last_login_at`: TIMESTAMP

**Note:** For MVP, single admin user. Team members can be associated with user_id (nullable for future multi-user support).

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `api/models/db/team_member.py` - Team member model
- `api/models/db/alert_forward.py` - Alert forward tracking model
- `api/repositories/team_member_repository.py` - Team member repository
- `api/routes/api.py` - Update with team member and forwarding endpoints
- `admin-ui/templates/pages/team-members/list.html` - Team member list
- `admin-ui/templates/pages/team-members/form.html` - Team member form
- `admin-ui/templates/pages/alerts/forward.html` - Forwarding form
- `admin-ui/templates/pages/alerts/forward-history.html` - Forwarding history
- `admin-ui/templates/emails/forwarded_alert.html` - Forwarded email template
- `admin-ui/templates/emails/forwarded_alert.txt` - Forwarded email template (plain text)
- `alembic/versions/XXX_add_team_members.py` - Migration for team members
- `alembic/versions/XXX_add_alert_forwards.py` - Migration for alert forwards

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Database Access:**
- Always use Repository pattern for database access
- Use async/await for all database operations
- Never access database directly from services

**Email Sending:**
- Always use email service abstraction
- Log all email sends
- Handle errors gracefully

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Unit Tests:**
- Test team member CRUD operations
- Test forwarding logic
- Test email template rendering

**Integration Tests:**
- Test forwarding flow end-to-end
- Test email delivery
- Test forwarding history tracking

**Manual Testing:**
- Test team member management
- Test alert forwarding
- Test email delivery and headers

### Technical Constraints
- Team members stored securely (encrypted at rest if required)
- Email addresses validated before storage
- Forwarding requires authentication
- Privacy: Team member emails not shared with other users

## Testing

**Unit Tests:**
- Test team member CRUD operations
- Test forwarding logic
- Test email template rendering

**Integration Tests:**
- Test forwarding flow end-to-end
- Test email delivery
- Test forwarding history tracking

**Manual Testing:**
- Add team member via admin UI
- Forward alert to team member
- Verify forwarded email received
- Verify forwarding history recorded
- Verify email headers correct

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

