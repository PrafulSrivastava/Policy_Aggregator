# Story 4.3: Route Subscription Management UI

## Status
Draft

## Story
**As an** admin user,  
**I want** a UI for managing route subscriptions,  
**so that** I can create, view, edit, and delete route subscriptions without using the API.

## Acceptance Criteria

1. Route list page: displays all route subscriptions in a table
   - Columns: origin, destination, visa_type, email, created_at
   - Sortable by any column
   - Search/filter functionality
2. Create route form:
   - Fields: origin (dropdown/autocomplete), destination (dropdown/autocomplete), visa_type (dropdown), email (text input)
   - Validation: required fields, valid email format, valid country codes
   - Submit creates route via API
   - Success message and redirect to route list
3. Edit route page: pre-filled form, update via API
4. Delete route: confirmation dialog, delete via API
5. View route detail: shows route info and associated sources
6. Error handling: display API errors to user
7. Manual test: create, edit, delete routes via UI

## Tasks / Subtasks

- [ ] Task 1: Create route list page (AC: 1)
  - [ ] Create `admin-ui/templates/pages/routes/list.html`
  - [ ] Create table displaying routes:
    - [ ] Columns: origin, destination, visa_type, email, created_at
    - [ ] Use Tailwind CSS for table styling
  - [ ] Add "Add New Route" button
  - [ ] Add search/filter input field
  - [ ] Add sorting functionality (client-side or server-side)
  - [ ] Make table responsive
- [ ] Task 2: Create route list web route (AC: 1)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /routes` route
    - [ ] Fetch routes from API (`/api/routes`)
    - [ ] Render route list template
    - [ ] Require authentication
- [ ] Task 3: Create route form template (AC: 2, 3)
  - [ ] Create `admin-ui/templates/pages/routes/form.html`
  - [ ] Create form with fields:
    - [ ] Origin country (dropdown/select)
    - [ ] Destination country (dropdown/select)
    - [ ] Visa type (dropdown/select)
    - [ ] Email (text input, type="email")
  - [ ] Add form validation (HTML5 and JavaScript)
  - [ ] Add submit button
  - [ ] Add cancel button (link back to list)
  - [ ] Support both create and edit modes
- [ ] Task 4: Create route form web routes (AC: 2, 3)
  - [ ] Create `GET /routes/new` route:
    - [ ] Render route form template (create mode)
    - [ ] Require authentication
  - [ ] Create `GET /routes/{id}` route:
    - [ ] Fetch route from API
    - [ ] Render route form template (edit mode, pre-filled)
    - [ ] Require authentication
- [ ] Task 5: Add form submission handling (AC: 2, 3)
  - [ ] Create or update `admin-ui/static/js/forms.js`
  - [ ] Add form submission handler:
    - [ ] Prevent default form submission
    - [ ] Collect form data
    - [ ] Validate form data (client-side)
    - [ ] Call API to create/update route
    - [ ] Show success message
    - [ ] Redirect to route list on success
    - [ ] Show error message on failure
  - [ ] Use API client from `api.js`
- [ ] Task 6: Add delete functionality (AC: 4)
  - [ ] Add delete button to route list or detail page
  - [ ] Add confirmation dialog (JavaScript modal or browser confirm)
  - [ ] On confirmation, call API to delete route
  - [ ] Show success message
  - [ ] Refresh route list
- [ ] Task 7: Create route detail page (AC: 5)
  - [ ] Create `admin-ui/templates/pages/routes/detail.html` (optional, can use form.html)
  - [ ] Display route information
  - [ ] Display associated sources (use route mapper from Story 3.1)
  - [ ] Add edit and delete buttons
- [ ] Task 8: Add error handling (AC: 6)
  - [ ] Display API errors in form:
    - [ ] Show error message above form
    - [ ] Highlight invalid fields
    - [ ] Show field-specific errors if available
  - [ ] Handle network errors gracefully
  - [ ] Show user-friendly error messages
- [ ] Task 9: Add country code dropdowns (AC: 2)
  - [ ] Create country code list (ISO 3166-1 alpha-2 codes)
  - [ ] Populate origin and destination dropdowns
  - [ ] Use `<select>` element or autocomplete
  - [ ] Store country codes in JavaScript or template
- [ ] Task 10: Add search/filter functionality (AC: 1)
  - [ ] Add search input to route list page
  - [ ] Implement client-side filtering (JavaScript):
    - [ ] Filter by origin, destination, visa_type, email
    - [ ] Real-time filtering as user types
  - [ ] Or implement server-side filtering (API call with query params)
- [ ] Task 11: Add sorting functionality (AC: 1)
  - [ ] Add sortable column headers to table
  - [ ] Implement client-side sorting (JavaScript):
    - [ ] Click column header to sort
    - [ ] Toggle ascending/descending
    - [ ] Show sort indicator
  - [ ] Or implement server-side sorting (API call with sort params)
- [ ] Task 12: Manual testing (AC: 7)
  - [ ] Test create route form
  - [ ] Test edit route form
  - [ ] Test delete route (with confirmation)
  - [ ] Test route list display
  - [ ] Test search/filter
  - [ ] Test sorting
  - [ ] Test error handling

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation and authentication
- Story 4.2 created dashboard (similar pattern for web routes)
- Story 1.6 created RouteSubscription API endpoints
- Story 3.1 created route-to-source mapping (for showing associated sources)

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/routes              → Route subscriptions list
/routes/new          → Create route form
/routes/{id}         → Edit route form
/routes/{id}/delete  → Delete route (POST)
```

**API Client:**
- `api.getRoutes()` - Get all routes
- `api.createRoute(data)` - Create route
- `api.updateRoute(id, data)` - Update route (if endpoint exists)
- `api.deleteRoute(id)` - Delete route

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `admin-ui/templates/pages/routes/list.html` - Route list page
- `admin-ui/templates/pages/routes/form.html` - Route create/edit form
- `api/routes/web.py` - Add route web routes
- `admin-ui/static/js/forms.js` - Form handling (update existing)
- `admin-ui/static/js/api.js` - API client (update existing)

### Coding Standards
[Source: architecture/coding-standards.md]

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately (inline messages).

**Form Validation:** Validate on both client-side (JavaScript) and server-side (API).

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test route list page
- Test route form submission
- Test delete functionality

**Manual Testing:**
- Test all CRUD operations via UI
- Test form validation
- Test error handling

### Technical Constraints
- Must use API endpoints (not direct database access)
- Must validate forms client-side and server-side
- Must handle errors gracefully
- Must be responsive

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_web/test_routes.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test route list page rendering
- Test route form rendering (create and edit)
- Test form submission (create and update)
- Test delete functionality
- Test error handling
- Manual test: full CRUD operations via UI

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



