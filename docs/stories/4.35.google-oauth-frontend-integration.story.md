# Story 4.35: Google OAuth Frontend Integration

## Status
Draft

## Story
**As a** user,  
**I want** to sign in with my Google account from the React frontend,  
**so that** I can authenticate without managing a separate password.

## Acceptance Criteria

1. "Sign in with Google" button on login page
2. Button redirects to `/auth/google` endpoint (backend handles OAuth flow)
3. After Google authorization, user is redirected back to application
4. Backend callback (`/auth/google/callback`) sets JWT token in cookie
5. Frontend detects authenticated state and redirects to dashboard
6. Error handling for OAuth failures:
   - User denies access
   - Network errors
   - Invalid OAuth state
7. Loading state shown during OAuth redirect
8. Button only shown if Google OAuth is configured (check backend)
9. Design system styling applied (Minimalist Monochrome)
10. Works with hash-based routing (/#/login, /#/dashboard)

## Tasks / Subtasks

- [x] Task 1: Create Google OAuth button component (AC: 1, 9)
  - [x] Create `src/components/auth/GoogleOAuthButton.tsx`
  - [x] Style button according to design system
  - [x] Add Google branding (optional: Google logo/colors)
  - [x] Make button accessible (keyboard navigation, ARIA labels)
- [x] Task 2: Integrate button into login page (AC: 1, 8)
  - [x] Update `src/pages/Login.tsx`
  - [x] Add Google OAuth button
  - [x] Check if Google OAuth is configured (optional: call `/api/auth/google` to check)
  - [x] Only show button if OAuth is available
  - [x] Add visual separator between OAuth and password login
- [x] Task 3: Implement OAuth redirect flow (AC: 2, 3, 4, 5)
  - [x] Handle "Sign in with Google" button click
  - [x] Redirect to `/auth/google` (backend endpoint)
  - [x] Backend redirects to Google OAuth
  - [x] After Google authorization, redirect to `/auth/google/callback`
  - [x] Backend sets JWT token in cookie
  - [x] Frontend detects authentication (check auth context)
  - [x] Redirect to dashboard (/#/dashboard)
- [x] Task 4: Handle OAuth callback (AC: 4, 5, 10)
  - [x] Backend callback sets cookie and redirects to /#/dashboard
  - [x] Frontend checks for auth token on page load
  - [x] Update auth context with authenticated state
  - [x] Navigate to dashboard using hash routing
- [x] Task 5: Implement error handling (AC: 6)
  - [x] Handle OAuth errors from backend:
    - [x] User denies access: Show "Access denied" message
    - [x] Invalid state: Show "Authentication failed" message
    - [x] Network errors: Show "Connection error" message
  - [x] Display errors on login page
  - [x] Allow user to retry or use password login
- [x] Task 6: Add loading state (AC: 7)
  - [x] Show loading indicator when OAuth button is clicked
  - [x] Disable button during redirect
  - [x] Show "Redirecting to Google..." message
- [x] Task 7: Check OAuth availability (AC: 8)
  - [x] Option A: Try calling `/auth/google` and catch 501 error
  - [x] Option B: Add `/api/auth/config` endpoint to check OAuth availability
  - [x] Option C: Use environment variable (if frontend can access)
  - [x] Only show button if OAuth is configured
- [x] Task 8: Update auth service (AC: 2, 3)
  - [x] Update `src/services/api.ts`
  - [x] Add `initiateGoogleOAuth()` function (redirects to `/auth/google`)
  - [x] Add `checkOAuthAvailability()` function (optional)
  - [x] Handle OAuth callback detection
- [ ] Task 9: Create unit tests (AC: All)
  - [ ] Test Google OAuth button component
  - [ ] Test OAuth redirect flow
  - [ ] Test error handling
  - [ ] Test OAuth availability check
- [ ] Task 10: Manual testing (AC: All)
  - [ ] Test complete OAuth flow:
    - [ ] Click "Sign in with Google"
    - [ ] Redirect to Google
    - [ ] Authorize application
    - [ ] Redirect back and login
  - [ ] Test error cases:
    - [ ] User denies access
    - [ ] Network errors
  - [ ] Test button visibility (with/without OAuth config)
  - [ ] Test hash-based routing

## Dev Notes

### Previous Story Insights
- Story 4.9 created Google OAuth backend implementation
- Story 4.10 created login page with OAuth placeholder
- Story 4.17 implemented hash-based routing
- Backend endpoints exist: `GET /auth/google`, `GET /auth/google/callback`

### API Specifications
[Source: architecture/api-specification.md]

**OAuth Endpoints (Backend - Already Implemented):**
- `GET /auth/google` - Initiates OAuth flow, redirects to Google
- `GET /auth/google/callback?code={code}&state={state}` - Handles OAuth callback
  - Sets JWT token in httpOnly cookie
  - Redirects to `/` (dashboard) on success
  - Redirects to `/login?error=...` on failure

**OAuth Flow:**
1. User clicks "Sign in with Google" button
2. Frontend redirects to `/auth/google` (backend endpoint)
3. Backend generates state token and redirects to Google OAuth URL
4. User authorizes on Google
5. Google redirects to `/auth/google/callback` with code
6. Backend exchanges code for user info, creates/authenticates user
7. Backend sets JWT token in cookie and redirects to `/`
8. Frontend detects authenticated state and shows dashboard

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Component Structure:**
- Button component: `src/components/auth/GoogleOAuthButton.tsx`
- Login page: `src/pages/Login.tsx` (update existing)
- Auth service: `src/services/auth.ts` (update existing)

### Design System
[Source: .ignore/design_prompt.md]

**Button Styling:**
- Can use Google branding colors (optional) or design system
- If using design system: Black background, white text
- Sharp corners (no border-radius)
- Uppercase, tracking-widest for text
- Hover state: color inversion

### File Locations
- `frontend/src/components/auth/GoogleOAuthButton.tsx` - Create OAuth button component
- `frontend/src/pages/Login.tsx` - Update with OAuth button
- `frontend/src/services/auth.ts` - Add OAuth functions

### Technical Constraints
- Must work with hash-based routing (/#/login, /#/dashboard)
- Backend handles OAuth flow (frontend just initiates redirect)
- JWT token set in httpOnly cookie by backend
- Frontend must detect authentication state from cookie
- Must handle OAuth errors gracefully

### Security Considerations
- OAuth state token managed by backend (CSRF protection)
- JWT token in httpOnly cookie (secure)
- OAuth errors don't expose system details
- User can choose between OAuth and password login

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/components/auth/GoogleOAuthButton.test.tsx`

**Test Cases:**
- Test button rendering
- Test OAuth redirect
- Test error handling
- Test OAuth availability check
- Test integration with login page

**Note:** Full OAuth flow requires manual testing with real Google OAuth credentials.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes List
- Google OAuth button component created with design system styling
- Button integrated into login page with conditional rendering based on OAuth availability
- OAuth redirect flow implemented - button redirects to `/auth/google` backend endpoint
- OAuth callback handling - backend redirects to `/#/` on success, frontend detects auth via cookie
- Error handling implemented for all OAuth error scenarios (denied, invalid, failed)
- Loading state added to OAuth button during redirect
- OAuth availability check implemented - button only shows if OAuth is configured
- AuthContext updated to verify authentication from httpOnly cookies
- Backend redirects updated to use hash routing (`/#/login`, `/#/`)
- Axios configured with `withCredentials: true` to send cookies automatically

### File List
**Backend:**
- `api/routes/auth.py` - Updated OAuth callback redirects to use hash routing

**Frontend:**
- `frontend/components/auth/GoogleOAuthButton.tsx` - Created Google OAuth button component
- `frontend/pages/Login.tsx` - Integrated OAuth button with error handling and availability check
- `frontend/services/api.ts` - Added OAuth functions (`initiateGoogleOAuth`, `checkOAuthAvailability`, `verifyAuth`) and configured withCredentials
- `frontend/context/AuthContext.tsx` - Added OAuth functions and cookie-based auth verification

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |
| 2025-12-30 | 1.1 | Frontend OAuth integration completed | Dev Agent |

## QA Results
_To be populated by QA Agent_

