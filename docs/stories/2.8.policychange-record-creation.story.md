# Story 2.8: PolicyChange Record Creation

## Status
Ready for Review

## Story
**As a** developer,  
**I want** automatic creation of PolicyChange records when changes are detected,  
**so that** I have a complete history of all policy changes with timestamps and diffs.

## Acceptance Criteria

1. When change detected (hash differs), create PolicyChange record:
   - source_id (foreign key)
   - old_hash (previous PolicyVersion hash)
   - new_hash (current PolicyVersion hash)
   - diff (text diff from difflib)
   - detected_at (timestamp)
2. PolicyChange records are immutable (never updated)
3. Link PolicyChange to both old and new PolicyVersions (via hashes)
4. Database index on detected_at for efficient chronological queries
5. Database index on source_id for efficient source-based queries
6. Helper functions:
   - Get all changes for a source
   - Get changes within date range
   - Get latest change for a source
7. Unit tests for PolicyChange creation
8. Integration test: full flow - fetch, change detected, PolicyChange created with diff

## Tasks / Subtasks

- [x] Task 1: Create PolicyChange storage service (AC: 1, 2, 3)
  - [x] Create `api/services/change_storage.py` or add to existing service
  - [x] Implement `create_policy_change(source_id: UUID, old_version_id: UUID, new_version_id: UUID, old_hash: str, new_hash: str, diff: str, detected_at: datetime) -> PolicyChange` function
  - [x] Create PolicyChange record:
    - [x] source_id
    - [x] old_hash
    - [x] new_hash
    - [x] diff
    - [x] detected_at
    - [x] old_version_id
    - [x] new_version_id
    - [x] diff_length (calculate from diff)
  - [x] Ensure immutability (never update existing PolicyChange)
  - [x] Link to both old and new PolicyVersions via foreign keys
- [x] Task 2: Verify database indexes (AC: 4, 5)
  - [x] Verify indexes exist from Story 1.2:
    - [x] Index on `policy_changes.source_id`
    - [x] Index on `policy_changes.detected_at` (DESC)
    - [x] Composite index on `(source_id, detected_at DESC)`
  - [x] Create migration if indexes missing
- [x] Task 3: Add helper functions to repository (AC: 6)
  - [x] Update `api/repositories/policy_change_repository.py` (from Story 1.3)
  - [x] Verify helper functions exist:
    - [x] `get_by_source_id(source_id)` - Get all changes for a source
    - [x] `get_by_date_range(start_date, end_date)` - Get changes within date range
    - [x] `get_latest_by_source_id(source_id)` - Get latest change for a source
  - [x] Add if missing
- [x] Task 4: Integrate with change detection and diff generation (AC: 1)
  - [x] After change detected and diff generated, create PolicyChange record
  - [x] Pass all required data (source_id, hashes, diff, version IDs)
  - [x] Handle creation errors gracefully
  - [x] Log PolicyChange creation
- [x] Task 5: Create unit tests (AC: 7)
  - [x] Create `tests/unit/test_services/test_change_storage.py`
  - [x] Test PolicyChange creation:
    - [x] Creates PolicyChange with all required fields
    - [x] Links to old and new PolicyVersions
    - [x] Stores diff correctly
    - [x] Calculates diff_length
  - [x] Test immutability:
    - [x] Verify PolicyChange is never updated
    - [x] Verify new changes are always created
  - [x] Test helper functions:
    - [x] `get_by_source_id()`
    - [x] `get_by_date_range()`
    - [x] `get_latest_by_source_id()`
- [x] Task 6: Create integration test (AC: 8)
  - [x] Create `tests/integration/test_pipeline/test_change_creation.py`
  - [x] Test full flow:
    - [x] Fetch source
    - [x] Modify content
    - [x] Fetch again
    - [x] Verify change detected
    - [x] Verify diff generated
    - [x] Verify PolicyChange created with all fields
  - [x] Verify PolicyChange links to correct PolicyVersions

## Dev Notes

### Previous Story Insights
- Story 2.6 created change detection service
- Story 2.7 created diff generation service
- Story 1.3 created PolicyChange repository with CRUD operations
- Story 1.2 created PolicyChange database model and indexes

### Data Models
[Source: architecture/data-models.md]

**PolicyChange Model:**
- `id`: UUID (primary key)
- `sourceId`: UUID (foreign key to Source)
- `oldHash`: string (SHA256, 64 characters)
- `newHash`: string (SHA256, 64 characters)
- `diff`: string (text diff)
- `detectedAt`: Date
- `oldVersionId`: UUID (foreign key to PolicyVersion, nullable)
- `newVersionId`: UUID (foreign key to PolicyVersion)
- `diffLength`: number
- `alertSentAt`: Date | null (for Epic 3)
- `createdAt`: Date

**Immutability Requirements:**
- PolicyChange records are immutable (never updated)
- This ensures complete audit trail

### Database Schema
[Source: architecture/database-schema.md]

**Policy Changes Table:**
- Indexes on `source_id`, `detected_at` (DESC)
- Composite index on `(source_id, detected_at DESC)` for efficient queries
- Foreign keys to PolicyVersions (old_version_id, new_version_id)

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create/update:
- `api/services/change_storage.py` - PolicyChange storage service (or add to existing service)
- `api/repositories/policy_change_repository.py` - Verify helper functions exist
- `tests/unit/test_services/test_change_storage.py` - Unit tests
- `tests/integration/test_pipeline/test_change_creation.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Type Hints:** All Python functions must have type hints.

**Async/Await:** Use `async def` and `await` for all database operations.

**Immutability:** PolicyChange records must never be updated.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test PolicyChange creation
- Test immutability
- Test helper functions

**Integration Tests:**
- Test full flow: fetch → change → diff → PolicyChange creation

### Technical Constraints
- PolicyChange records are immutable (no update operations)
- Must link to both old and new PolicyVersions
- Must store diff text
- Must calculate diff_length

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_change_storage.py` and `tests/integration/test_pipeline/test_change_creation.py`

**Test Standards:**
- Use pytest framework
- Use async test fixtures for database operations
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- pytest-asyncio for async test support

**Specific Testing Requirements:**
- Test PolicyChange creation with all fields
- Test immutability (never updates existing change)
- Test helper functions (get_by_source_id, get_by_date_range, get_latest)
- Test integration: full flow from fetch to PolicyChange creation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-27 | 1.1 | Story implementation completed | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Created `api/services/change_storage.py` with `create_policy_change()` function
- Verified database indexes exist in PolicyChange model (source_id, detected_at DESC, composite index)
- Verified helper functions exist in PolicyChangeRepository (get_by_source_id, get_by_date_range, get_latest_by_source_id)
- Integrated PolicyChange creation into `version_storage.py` - automatically creates PolicyChange when change detected and diff generated
- Added comprehensive validation for all required fields (source_id, hashes, diff, detected_at)
- Ensured immutability - PolicyChange records are never updated, only new records created
- Created comprehensive unit tests covering PolicyChange creation, immutability, and helper functions
- Created integration tests verifying full pipeline: fetch → change detected → diff generated → PolicyChange created
- All acceptance criteria met: PolicyChange created with all fields, links to PolicyVersions, indexes verified, helper functions tested

### File List
**Created:**
- `api/services/change_storage.py` - PolicyChange storage service
- `tests/unit/test_services/test_change_storage.py` - Unit tests for PolicyChange creation
- `tests/integration/test_pipeline/test_change_creation.py` - Integration tests for full pipeline

**Modified:**
- `api/services/version_storage.py` - Integrated PolicyChange creation when change detected

## QA Results
_To be populated by QA Agent_

