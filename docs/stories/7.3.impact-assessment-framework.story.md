# Story 7.3: Impact Assessment Framework

## Status
Draft

## Story
**As an** admin user,  
**I want** to understand how policy changes might affect my specific cases,  
**so that** I can prioritize which changes need immediate attention.

## Acceptance Criteria

1. Impact assessment criteria defined:
   - What constitutes "high impact" vs "low impact"
   - Factors: visa type, application stage, route, change type
   - Scoring system (1-5 or high/medium/low)
2. User context collection:
   - Allow users to specify active cases/application status
   - Store user context (route, visa type, application stage)
   - Update context as needed
3. Impact assessment engine:
   - Compare policy change to user's context
   - Generate impact score/indicator using OpenRouter API
   - Provide brief explanation of impact
4. Impact display:
   - Show impact indicator in email alerts (if enabled)
   - Show impact in dashboard and change detail views
   - Color coding (red = high impact, yellow = medium, green = low)
5. Legal disclaimers:
   - Prominent disclaimer: "Impact assessment is informational only"
   - "Not legal advice" messaging
   - Link to full legal disclaimer
6. Impact assessment storage:
   - Store impact score with PolicyChange (per user context)
   - Allow multiple impact assessments per change (different contexts)
7. User opt-in/opt-out:
   - Users can enable/disable impact assessment
   - Clear explanation of what impact assessment does
8. Manual test: Configure user context, receive change, verify impact assessment

## Tasks / Subtasks

- [ ] Task 1: Define impact assessment criteria (AC: 1)
  - [ ] Document impact assessment factors:
    - [ ] Visa type match (exact match = high impact)
    - [ ] Route match (origin/destination match = high impact)
    - [ ] Application stage (active application = higher impact)
    - [ ] Change type (major change = higher impact)
  - [ ] Define scoring system:
    - [ ] High impact (4-5): Direct match to user context, major changes
    - [ ] Medium impact (2-3): Partial match, moderate changes
    - [ ] Low impact (1): Indirect match, minor changes
  - [ ] Document criteria in code comments or documentation
- [ ] Task 2: Create user context model (AC: 2)
  - [ ] Create Alembic migration for `user_contexts` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users, nullable for MVP)
    - [ ] `route_subscription_id`: UUID (foreign key, nullable - link to route)
    - [ ] `visa_type`: VARCHAR(50) (visa type user is interested in)
    - [ ] `application_stage`: VARCHAR(50) (e.g., "planning", "applied", "approved")
    - [ ] `is_active`: BOOLEAN (whether context is active)
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/user_context.py`
  - [ ] Create repository: `api/repositories/user_context_repository.py`
- [ ] Task 3: Create user context API endpoints (AC: 2)
  - [ ] Create `GET /api/user-contexts` - List user contexts
  - [ ] Create `POST /api/user-contexts` - Create user context
  - [ ] Create `PUT /api/user-contexts/{id}` - Update user context
  - [ ] Create `DELETE /api/user-contexts/{id}` - Delete user context
  - [ ] Require authentication
  - [ ] Return user context data as JSON
- [ ] Task 4: Create user context management UI (AC: 2)
  - [ ] Create `admin-ui/templates/pages/settings/user-context.html` - User context page
  - [ ] Create web route: `GET /settings/user-context`
  - [ ] Display user context form:
    - [ ] Route selection (dropdown)
    - [ ] Visa type (dropdown)
    - [ ] Application stage (dropdown: planning, applied, approved, etc.)
    - [ ] Active toggle
    - [ ] Save button
  - [ ] Add "User Context" link to admin navigation
- [ ] Task 5: Create impact assessment service (AC: 3)
  - [ ] Create `api/services/impact_assessment.py`
  - [ ] Implement `assess_impact(policy_change: PolicyChange, user_context: UserContext) -> ImpactAssessment` function:
    - [ ] Compare policy change to user context:
      - [ ] Check visa type match
      - [ ] Check route match
      - [ ] Check application stage relevance
      - [ ] Analyze change type from diff
    - [ ] Generate impact score (1-5 or high/medium/low)
    - [ ] Generate impact explanation using OpenRouter API:
      - [ ] Create prompt with policy change and user context
      - [ ] Call OpenRouter API to generate explanation
      - [ ] Extract explanation from response
    - [ ] Return ImpactAssessment with score and explanation
- [ ] Task 6: Create impact assessment prompt template (AC: 3)
  - [ ] Design prompt for impact assessment:
    - [ ] Context: "Assess the impact of this policy change for a user"
    - [ ] Include policy change diff
    - [ ] Include user context (route, visa type, application stage)
    - [ ] Instructions: "Provide impact score (1-5) and brief explanation"
    - [ ] Constraints: "Informational only, not legal advice"
  - [ ] Store prompt template in code or configuration
- [ ] Task 7: Create impact assessment storage (AC: 6)
  - [ ] Create Alembic migration for `impact_assessments` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `policy_change_id`: UUID (foreign key to policy_changes)
    - [ ] `user_context_id`: UUID (foreign key to user_contexts)
    - [ ] `impact_score`: INTEGER (1-5)
    - [ ] `impact_level`: VARCHAR(20) ('high', 'medium', 'low')
    - [ ] `explanation`: TEXT (AI-generated explanation)
    - [ ] `model_used`: VARCHAR(100) (OpenRouter model used)
    - [ ] `generated_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create SQLAlchemy model: `api/models/db/impact_assessment.py`
  - [ ] Create repository: `api/repositories/impact_assessment_repository.py`
- [ ] Task 8: Integrate impact assessment with change detection (AC: 3)
  - [ ] Update change detection pipeline:
    - [ ] After PolicyChange created, check if impact assessment enabled
    - [ ] Get all active user contexts
    - [ ] For each user context, generate impact assessment
    - [ ] Store impact assessments in database
  - [ ] Make integration optional (feature flag)
  - [ ] Don't block change detection if impact assessment fails
- [ ] Task 9: Add impact display to email alerts (AC: 4)
  - [ ] Update email template: `admin-ui/templates/emails/change_alert.html`
  - [ ] Add impact indicator section:
    - [ ] Show impact level (high/medium/low) with color coding
    - [ ] Show impact score (1-5)
    - [ ] Show brief explanation (if available)
  - [ ] Only show if impact assessment enabled and available
- [ ] Task 10: Add impact display to dashboard (AC: 4)
  - [ ] Update `admin-ui/templates/pages/dashboard.html`
  - [ ] Add impact indicators to change list:
    - [ ] Color-coded badges (red/yellow/green)
    - [ ] Impact level text
    - [ ] Click to view full impact assessment
- [ ] Task 11: Add impact display to change detail page (AC: 4)
  - [ ] Update `admin-ui/templates/pages/changes/detail.html`
  - [ ] Add impact assessment section:
    - [ ] Show impact score and level
    - [ ] Show full explanation
    - [ ] Show user context used for assessment
  - [ ] Add color coding (red/yellow/green)
- [ ] Task 12: Add legal disclaimers (AC: 5)
  - [ ] Add disclaimer text to impact assessment displays:
    - [ ] "Impact assessment is informational only"
    - [ ] "Not legal advice"
    - [ ] "Consult legal professional for advice"
  - [ ] Add disclaimer to email templates
  - [ ] Add disclaimer to dashboard and change detail pages
  - [ ] Link to full legal disclaimer page
- [ ] Task 13: Add user opt-in/opt-out (AC: 7)
  - [ ] Add feature flag to user settings:
    - [ ] `enable_impact_assessment`: BOOLEAN
    - [ ] Default: false (opt-in)
  - [ ] Create settings UI for enabling/disabling
  - [ ] Add explanation of what impact assessment does
  - [ ] Store preference in database
- [ ] Task 14: Manual testing (AC: 8)
  - [ ] Test: Configure user context
  - [ ] Test: Receive policy change
  - [ ] Test: Verify impact assessment generated
  - [ ] Test: Verify impact displayed in email, dashboard, change detail
  - [ ] Test: Verify disclaimers visible

## Dev Notes

### Previous Story Insights
- Story 7.1 created OpenRouter API integration
- Story 7.2 created summarization engine (similar pattern)
- Story 1.6 created RouteSubscription model
- Story 1.2 created PolicyChange model

### OpenRouter API Integration
[Source: docs/stories/7.1.openrouter-api-integration-and-infrastructure.story.md]

**OpenRouter Client:**
- `api/integrations/openrouter.py` - OpenRouter API client
- `generate_completion(prompt: str, model: str, **kwargs) -> CompletionResult`
- Use for generating impact explanations

### Impact Assessment Prompt Design
**Prompt Template:**
```
You are a helpful assistant that assesses the impact of policy changes for immigration cases.

Given a policy change and a user's context, provide an impact assessment.

User Context:
- Route: {origin} â†’ {destination}
- Visa Type: {visa_type}
- Application Stage: {application_stage}

Policy Change:
{diff_text}

Provide:
1. Impact Score (1-5): 1=low impact, 5=high impact
2. Impact Level: high, medium, or low
3. Brief Explanation (2-3 sentences): Why this change matters for this user context

Remember: This is informational only, not legal advice.

Assessment:
```

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `api/models/db/user_context.py` - User context model
- `api/models/db/impact_assessment.py` - Impact assessment model
- `api/repositories/user_context_repository.py` - User context repository
- `api/repositories/impact_assessment_repository.py` - Impact assessment repository
- `api/services/impact_assessment.py` - Impact assessment service
- `admin-ui/templates/pages/settings/user-context.html` - User context UI
- `alembic/versions/XXX_add_user_contexts.py` - Migration
- `alembic/versions/XXX_add_impact_assessments.py` - Migration

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Service Layer:**
- Always use service layer for business logic
- Use async/await for all async operations
- Handle errors gracefully

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Unit Tests:**
- Test impact assessment logic
- Test scoring algorithm
- Test OpenRouter API integration

**Integration Tests:**
- Test end-to-end impact assessment
- Test with various user contexts
- Test with various policy changes

## Testing

**Unit Tests:**
- Test impact assessment logic
- Test scoring algorithm
- Test OpenRouter API integration

**Integration Tests:**
- Test end-to-end impact assessment
- Test with various user contexts
- Test with various policy changes

**Manual Testing:**
- Configure user context
- Receive policy change
- Verify impact assessment generated
- Verify impact displayed correctly
- Verify disclaimers visible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

