# Story 4.8: System Status/Monitoring View

## Status
Ready for Review

## Story
**As an** admin user,  
**I want** a page showing system health and source monitoring status,  
**so that** I can verify all sources are being checked regularly.

## Acceptance Criteria

1. System status page displays:
   - List of all sources with:
     - Last checked timestamp
     - Status (healthy, error, never checked)
     - Last change detected timestamp
     - Error count (if any)
     - Next expected check time
2. Visual indicators: green (healthy), yellow (warning - not checked recently), red (error)
3. Sources sorted by status (errors first)
4. Can trigger manual fetch from this page
5. System-wide stats: total sources, healthy sources, sources with errors
6. Last successful daily job run timestamp
7. Page auto-refreshes or can be manually refreshed
8. Manual test: verify all sources show correct status

## Tasks / Subtasks

- [x] Task 1: Create system status API endpoint (AC: 1, 5, 6)
  - [x] Create or update `api/routes/api.py`
  - [x] Implement `GET /api/status` endpoint
  - [x] Fetch system status data:
    - [x] All sources with status information
    - [x] System-wide statistics
    - [x] Last daily job run timestamp
  - [x] Return status data as JSON
  - [x] Require authentication
- [x] Task 2: Create system status service (AC: 1, 5, 6)
  - [x] Create or update `api/services/status.py`
  - [x] Implement `get_system_status()` function
  - [x] For each source, calculate:
    - [x] Last checked timestamp (from PolicyVersion)
    - [x] Status (healthy, error, never_checked, stale)
    - [x] Last change detected timestamp (from PolicyChange)
    - [x] Error count (from error tracking)
    - [x] Next expected check time (based on check_frequency)
  - [x] Calculate system-wide stats:
    - [x] Total sources
    - [x] Healthy sources count
    - [x] Sources with errors count
    - [x] Stale sources count
  - [x] Get last daily job run timestamp (from job tracking or logs)
  - [x] Return structured status data
- [x] Task 3: Create system status template (AC: 1, 2, 3, 4)
  - [x] Create `admin-ui/templates/pages/status.html`
  - [x] Display system-wide stats:
    - [x] Total sources card
    - [x] Healthy sources card
    - [x] Sources with errors card
    - [x] Last daily job run timestamp
  - [x] Display sources table:
    - [x] Columns: source name, last checked, status, last change, error count, next check
    - [x] Sort by status (errors first)
    - [x] Visual indicators (green/yellow/red badges)
    - [x] "Fetch Now" button for each source
  - [x] Use Tailwind CSS for styling
- [x] Task 4: Create system status web route (AC: 1)
  - [x] Create or update `api/routes/web.py`
  - [x] Implement `GET /status` route
    - [x] Fetch system status from API (`/api/status`)
    - [x] Render status template
    - [x] Require authentication
- [x] Task 5: Add status calculation logic (AC: 1, 2)
  - [x] In status service, calculate source status:
    - [x] Healthy: checked recently, no errors
    - [x] Error: has recent errors
    - [x] Never checked: no PolicyVersion records
    - [x] Stale: not checked recently (beyond check_frequency + buffer)
  - [x] Calculate next expected check time:
    - [x] Based on check_frequency (daily, weekly, monthly)
    - [x] Based on last checked timestamp
    - [x] Show next expected time
- [x] Task 6: Add visual indicators (AC: 2)
  - [x] In status template, add status badges:
    - [x] Green badge for healthy sources
    - [x] Yellow badge for stale sources
    - [x] Red badge for error sources
    - [x] Gray badge for never checked sources
  - [x] Use Tailwind CSS classes for colors
- [x] Task 7: Add sorting by status (AC: 3)
  - [x] Sort sources by status priority:
    - [x] Errors first
    - [x] Stale second
    - [x] Never checked third
    - [x] Healthy last
  - [x] Within same status, sort by last checked (oldest first)
- [x] Task 8: Add manual trigger from status page (AC: 4)
  - [x] Add "Fetch Now" button to each source in status table
  - [x] Use trigger functionality from Story 4.7
  - [x] Show loading state while triggering
  - [x] Update status after trigger completes
- [x] Task 9: Add auto-refresh functionality (AC: 7)
  - [x] Add "Refresh" button to status page
  - [x] Optionally add auto-refresh:
    - [x] Refresh every 30 seconds (optional)
    - [x] Or manual refresh only
  - [x] Update status data without full page reload (AJAX)
- [x] Task 10: Add last daily job display (AC: 6)
  - [x] Get last daily job run timestamp:
    - [x] From job tracking system (if exists)
    - [x] Or from logs
    - [x] Or from database (if job logs stored)
  - [x] Display in system stats section
  - [x] Show "Never run" if no job has run
  - Note: For MVP, job tracking not in database - returns None, can be enhanced later
- [x] Task 11: Manual testing (AC: 8)
  - [x] Test system status page displays correctly
  - [x] Test status indicators (green/yellow/red)
  - [x] Test sorting by status
  - [x] Test manual trigger from status page
  - [x] Test refresh functionality
  - [x] Test with various source states
  - [x] Verify all sources show correct status

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation
- Story 4.2 created dashboard (similar pattern)
- Story 4.7 created manual trigger functionality
- Story 2.5 created PolicyVersion storage
- Story 2.8 created PolicyChange records
- Story 3.7 created error tracking
- Story 3.8 created scheduled jobs

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/status             â†’ System status page
```

**API Client:**
- `api.getStatus()` - Get system status
- `api.triggerSource(id)` - Trigger fetch (from Story 4.7)

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/status.py` - System status service
- `api/routes/api.py` - Add status endpoint
- `api/routes/web.py` - Add status web route
- `admin-ui/templates/pages/status.html` - Status page template
- `admin-ui/static/js/status.js` - Status page interactivity (optional)

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test system status API endpoint
- Test status calculation logic
- Test sorting

**Manual Testing:**
- Test status page display
- Test status indicators
- Test trigger functionality
- Test refresh

### Technical Constraints
- Must calculate status accurately
- Must display status clearly
- Must be responsive
- Must handle many sources efficiently

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_status.py` and `tests/integration/test_web/test_status.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test system status API endpoint
- Test status calculation logic
- Test sorting by status
- Test visual indicators
- Manual test: verify all status displays correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- Created system status service (`api/services/status.py`) with comprehensive status calculation
- Implemented `get_system_status()` function that:
  - Calculates status for each source (healthy, error, stale, never_checked) using existing `get_source_status()` function
  - Fetches last change detected timestamp from PolicyChange records
  - Calculates next expected check time based on check_frequency
  - Aggregates system-wide statistics (total, healthy, error, stale, never_checked counts)
  - Sorts sources by status priority (errors first, then stale, never_checked, healthy)
- Created system status API endpoint (`GET /api/status`) with authentication
- Built comprehensive status page template with:
  - System statistics cards (total, healthy, error, stale, never_checked)
  - Sources table with all status information
  - Visual status indicators (color-coded badges)
  - "Fetch Now" buttons for manual triggering
  - Last daily job run display (returns None for MVP - can be enhanced later)
- Implemented status.js with:
  - Manual refresh functionality
  - Auto-refresh capability (commented out by default, can be enabled)
  - Integration with trigger.js for manual fetch functionality
  - Dynamic table updates without full page reload
- Added `getStatus()` method to API client
- Created integration tests for both API endpoint and web route covering status calculation, sorting, and statistics

### File List
**Created:**
- `api/services/status.py` - System status service with status calculation
- `admin-ui/templates/pages/status.html` - System status page template
- `admin-ui/static/js/status.js` - Status page interactivity and refresh
- `tests/integration/test_api/test_status.py` - API endpoint integration tests
- `tests/integration/test_web/test_status.py` - Web route integration tests

**Modified:**
- `api/routes/api.py` - Added status router and `GET /api/status` endpoint
- `api/routes/web.py` - Added `GET /status` web route
- `api/main.py` - Registered status router
- `admin-ui/static/js/api.js` - Added `getStatus()` method

## QA Results
_To be populated by QA Agent_



