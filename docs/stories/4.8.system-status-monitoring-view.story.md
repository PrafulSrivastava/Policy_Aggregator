# Story 4.8: System Status/Monitoring View

## Status
Draft

## Story
**As an** admin user,  
**I want** a page showing system health and source monitoring status,  
**so that** I can verify all sources are being checked regularly.

## Acceptance Criteria

1. System status page displays:
   - List of all sources with:
     - Last checked timestamp
     - Status (healthy, error, never checked)
     - Last change detected timestamp
     - Error count (if any)
     - Next expected check time
2. Visual indicators: green (healthy), yellow (warning - not checked recently), red (error)
3. Sources sorted by status (errors first)
4. Can trigger manual fetch from this page
5. System-wide stats: total sources, healthy sources, sources with errors
6. Last successful daily job run timestamp
7. Page auto-refreshes or can be manually refreshed
8. Manual test: verify all sources show correct status

## Tasks / Subtasks

- [ ] Task 1: Create system status API endpoint (AC: 1, 5, 6)
  - [ ] Create or update `api/routes/api.py`
  - [ ] Implement `GET /api/status` endpoint
  - [ ] Fetch system status data:
    - [ ] All sources with status information
    - [ ] System-wide statistics
    - [ ] Last daily job run timestamp
  - [ ] Return status data as JSON
  - [ ] Require authentication
- [ ] Task 2: Create system status service (AC: 1, 5, 6)
  - [ ] Create or update `api/services/status.py`
  - [ ] Implement `get_system_status()` function
  - [ ] For each source, calculate:
    - [ ] Last checked timestamp (from PolicyVersion)
    - [ ] Status (healthy, error, never_checked, stale)
    - [ ] Last change detected timestamp (from PolicyChange)
    - [ ] Error count (from error tracking)
    - [ ] Next expected check time (based on check_frequency)
  - [ ] Calculate system-wide stats:
    - [ ] Total sources
    - [ ] Healthy sources count
    - [ ] Sources with errors count
    - [ ] Stale sources count
  - [ ] Get last daily job run timestamp (from job tracking or logs)
  - [ ] Return structured status data
- [ ] Task 3: Create system status template (AC: 1, 2, 3, 4)
  - [ ] Create `admin-ui/templates/pages/status.html`
  - [ ] Display system-wide stats:
    - [ ] Total sources card
    - [ ] Healthy sources card
    - [ ] Sources with errors card
    - [ ] Last daily job run timestamp
  - [ ] Display sources table:
    - [ ] Columns: source name, last checked, status, last change, error count, next check
    - [ ] Sort by status (errors first)
    - [ ] Visual indicators (green/yellow/red badges)
    - [ ] "Fetch Now" button for each source
  - [ ] Use Tailwind CSS for styling
- [ ] Task 4: Create system status web route (AC: 1)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /status` route
    - [ ] Fetch system status from API (`/api/status`)
    - [ ] Render status template
    - [ ] Require authentication
- [ ] Task 5: Add status calculation logic (AC: 1, 2)
  - [ ] In status service, calculate source status:
    - [ ] Healthy: checked recently, no errors
    - [ ] Error: has recent errors
    - [ ] Never checked: no PolicyVersion records
    - [ ] Stale: not checked recently (beyond check_frequency + buffer)
  - [ ] Calculate next expected check time:
    - [ ] Based on check_frequency (daily, weekly, monthly)
    - [ ] Based on last checked timestamp
    - [ ] Show next expected time
- [ ] Task 6: Add visual indicators (AC: 2)
  - [ ] In status template, add status badges:
    - [ ] Green badge for healthy sources
    - [ ] Yellow badge for stale sources
    - [ ] Red badge for error sources
    - [ ] Gray badge for never checked sources
  - [ ] Use Tailwind CSS classes for colors
- [ ] Task 7: Add sorting by status (AC: 3)
  - [ ] Sort sources by status priority:
    - [ ] Errors first
    - [ ] Stale second
    - [ ] Never checked third
    - [ ] Healthy last
  - [ ] Within same status, sort by last checked (oldest first)
- [ ] Task 8: Add manual trigger from status page (AC: 4)
  - [ ] Add "Fetch Now" button to each source in status table
  - [ ] Use trigger functionality from Story 4.7
  - [ ] Show loading state while triggering
  - [ ] Update status after trigger completes
- [ ] Task 9: Add auto-refresh functionality (AC: 7)
  - [ ] Add "Refresh" button to status page
  - [ ] Optionally add auto-refresh:
    - [ ] Refresh every 30 seconds (optional)
    - [ ] Or manual refresh only
  - [ ] Update status data without full page reload (AJAX)
- [ ] Task 10: Add last daily job display (AC: 6)
  - [ ] Get last daily job run timestamp:
    - [ ] From job tracking system (if exists)
    - [ ] Or from logs
    - [ ] Or from database (if job logs stored)
  - [ ] Display in system stats section
  - [ ] Show "Never run" if no job has run
- [ ] Task 11: Manual testing (AC: 8)
  - [ ] Test system status page displays correctly
  - [ ] Test status indicators (green/yellow/red)
  - [ ] Test sorting by status
  - [ ] Test manual trigger from status page
  - [ ] Test refresh functionality
  - [ ] Test with various source states
  - [ ] Verify all sources show correct status

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation
- Story 4.2 created dashboard (similar pattern)
- Story 4.7 created manual trigger functionality
- Story 2.5 created PolicyVersion storage
- Story 2.8 created PolicyChange records
- Story 3.7 created error tracking
- Story 3.8 created scheduled jobs

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/status             â†’ System status page
```

**API Client:**
- `api.getStatus()` - Get system status
- `api.triggerSource(id)` - Trigger fetch (from Story 4.7)

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/status.py` - System status service
- `api/routes/api.py` - Add status endpoint
- `api/routes/web.py` - Add status web route
- `admin-ui/templates/pages/status.html` - Status page template
- `admin-ui/static/js/status.js` - Status page interactivity (optional)

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test system status API endpoint
- Test status calculation logic
- Test sorting

**Manual Testing:**
- Test status page display
- Test status indicators
- Test trigger functionality
- Test refresh

### Technical Constraints
- Must calculate status accurately
- Must display status clearly
- Must be responsive
- Must handle many sources efficiently

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_status.py` and `tests/integration/test_web/test_status.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test system status API endpoint
- Test status calculation logic
- Test sorting by status
- Test visual indicators
- Manual test: verify all status displays correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



