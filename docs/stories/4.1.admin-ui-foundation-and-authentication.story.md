# Story 4.1: Admin UI Foundation and Authentication

## Status
Draft

## Story
**As an** admin user,  
**I want** a web-based admin interface with authentication,  
**so that** I can securely access the management interface.

## Acceptance Criteria

1. Admin UI built with template-based framework (Jinja2 with FastAPI)
2. Login page with username/password form
3. Login integrates with existing authentication system (from Epic 1)
4. Session management: user stays logged in (session cookie or JWT)
5. Logout functionality
6. Protected routes: all admin pages require authentication
7. Redirect to login if not authenticated
8. Basic layout: header with navigation, main content area, footer
9. Responsive design (works on desktop and tablet)
10. Unit tests for authentication flow
11. Manual test: login, logout, access protected pages

## Tasks / Subtasks

- [ ] Task 1: Set up Jinja2 templates (AC: 1, 8)
  - [ ] Install Jinja2 (if not already installed)
  - [ ] Configure Jinja2Templates in FastAPI app
  - [ ] Set template directory: `admin-ui/templates`
  - [ ] Create base template structure
- [ ] Task 2: Create base template (AC: 8)
  - [ ] Create `admin-ui/templates/base.html`
  - [ ] Include HTML structure: `<html>`, `<head>`, `<body>`
  - [ ] Add header with navigation (when authenticated)
  - [ ] Add main content area (`{% block content %}`)
  - [ ] Add footer
  - [ ] Include Tailwind CSS (via CDN or compiled)
  - [ ] Include JavaScript files
  - [ ] Make layout responsive (Tailwind responsive classes)
- [ ] Task 3: Create login page (AC: 2, 3)
  - [ ] Create `admin-ui/templates/pages/login.html`
  - [ ] Create login form:
    - [ ] Username input field
    - [ ] Password input field
    - [ ] Submit button
  - [ ] Form submits to `/auth/login` (POST)
  - [ ] Display error messages if login fails
  - [ ] Use base template or standalone layout
- [ ] Task 4: Create web authentication routes (AC: 3, 4, 5)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Create `GET /login` route:
    - [ ] Render login template
    - [ ] Redirect to dashboard if already authenticated
  - [ ] Create `POST /login` route:
    - [ ] Accept username/password from form
    - [ ] Call authentication service (from Story 1.5)
    - [ ] Set JWT token in cookie (for web requests)
    - [ ] Redirect to dashboard on success
    - [ ] Show error on failure
  - [ ] Create `POST /logout` route:
    - [ ] Clear session cookie
    - [ ] Invalidate token (optional, JWT is stateless)
    - [ ] Redirect to login page
- [ ] Task 5: Implement protected route middleware (AC: 6, 7)
  - [ ] Update `api/middleware/auth.py` (from Story 1.5)
  - [ ] Enhance `get_current_user` dependency:
    - [ ] Check JWT token from cookie (for web requests)
    - [ ] Check Authorization header (for API requests)
    - [ ] Redirect to `/login` if not authenticated (for HTML requests)
    - [ ] Return 401 for API requests
  - [ ] Apply authentication to all web routes except `/login` and `/health`
- [ ] Task 6: Create web route handlers (AC: 1, 6)
  - [ ] Create `api/routes/web.py` (if not exists)
  - [ ] Set up Jinja2Templates instance
  - [ ] Create placeholder routes for:
    - [ ] `GET /` - Dashboard (protected)
    - [ ] `GET /routes` - Routes list (protected)
    - [ ] Other routes will be added in later stories
  - [ ] All routes use `get_current_user` dependency
  - [ ] All routes render templates with data
- [ ] Task 7: Add navigation to base template (AC: 8)
  - [ ] Add navigation bar in base template header:
    - [ ] Dashboard link
    - [ ] Routes link
    - [ ] Sources link
    - [ ] Changes link
    - [ ] Trigger link
    - [ ] Logout link
  - [ ] Show navigation only when user is authenticated
  - [ ] Use Tailwind CSS for styling
- [ ] Task 8: Make design responsive (AC: 9)
  - [ ] Use Tailwind responsive classes
  - [ ] Test on desktop viewport
  - [ ] Test on tablet viewport
  - [ ] Ensure navigation is usable on mobile/tablet
- [ ] Task 9: Create unit tests (AC: 10)
  - [ ] Create `tests/integration/test_web/test_auth.py`
  - [ ] Test login flow:
    - [ ] GET /login renders login page
    - [ ] POST /login with valid credentials redirects to dashboard
    - [ ] POST /login with invalid credentials shows error
  - [ ] Test protected routes:
    - [ ] Accessing protected route without auth redirects to login
    - [ ] Accessing protected route with auth shows page
  - [ ] Test logout:
    - [ ] POST /logout clears session and redirects to login
- [ ] Task 10: Manual testing (AC: 11)
  - [ ] Test login with valid credentials
  - [ ] Test login with invalid credentials
  - [ ] Test accessing protected pages without login (should redirect)
  - [ ] Test logout functionality
  - [ ] Test session persistence (stays logged in)
  - [ ] Test responsive design on different screen sizes

## Dev Notes

### Previous Story Insights
- Story 1.5 created authentication system with JWT tokens
- Story 1.4 set up FastAPI application structure
- Authentication dependency `get_current_user` is available
- JWT token generation and validation is implemented

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Component Architecture:**
- Server-side rendering with Jinja2 templates
- Base template with layout and navigation
- Component macros for reusable UI elements
- Tailwind CSS for styling

**Routing Architecture:**
- FastAPI handles routing server-side
- Routes map to Jinja2 template rendering
- Protected routes use `get_current_user` dependency

**Route Structure:**
```
/login               → Login page
/logout              → Logout (POST)
/                    → Dashboard (protected)
/routes              → Route subscriptions list (protected)
/sources             → Sources list (protected)
/changes             → Change history list (protected)
/trigger             → Manual trigger page (protected)
```

### Tech Stack
[Source: architecture/tech-stack.md]

**Frontend Framework:**
- Jinja2 templates with FastAPI
- Tailwind CSS 3.x for styling
- Vanilla JavaScript (no framework)

**State Management:**
- Server-side state (session, page data)
- Minimal client-side state (form inputs, loading states)

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `admin-ui/templates/base.html` - Base template with layout
- `admin-ui/templates/pages/login.html` - Login page
- `admin-ui/templates/components/` - Component macros (will be created in later stories)
- `api/routes/web.py` - Web route handlers
- `admin-ui/static/css/main.css` - Tailwind CSS (or use CDN)
- `admin-ui/static/js/main.js` - Main JavaScript

### Coding Standards
[Source: architecture/coding-standards.md]

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency. Never render templates manually.

**Authentication:** All protected routes must use the `get_current_user` dependency.

**Error Handling:** Display errors to users appropriately (inline messages, not just console logs).

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test login flow
- Test protected route access
- Test logout
- Use FastAPI TestClient

**Manual Testing:**
- Test in browser
- Test responsive design
- Test session persistence

### Technical Constraints
- Must use Jinja2 templates (no React/Vue)
- Must use Tailwind CSS for styling
- Must be responsive (desktop and tablet)
- Must integrate with existing JWT authentication
- Must redirect to login for unauthenticated users

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_web/test_auth.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient for web testing
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test login page rendering
- Test login with valid/invalid credentials
- Test protected route access (with/without auth)
- Test logout functionality
- Test redirect to login for unauthenticated users
- Manual test: verify in browser, test responsive design

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



