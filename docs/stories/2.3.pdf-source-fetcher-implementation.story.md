# Story 2.3: PDF Source Fetcher Implementation

## Status
Draft

## Story
**As a** developer,  
**I want** PDF text extraction capability,  
**so that** I can extract policy content from PDF documents.

## Acceptance Criteria

1. PDF fetcher module that can extract text from PDF files
2. Uses `pdftotext` (via subprocess) or `PyPDF2`/`pdfplumber` library
3. Handles PDFs fetched from URLs (download PDF, extract text, clean up temp file)
4. Handles local PDF files (for testing)
5. Extracts text while preserving basic structure (paragraphs, line breaks)
6. Handles encrypted/protected PDFs gracefully (returns error)
7. Handles corrupted or invalid PDFs gracefully (returns error)
8. Extracts metadata: page count, creation date (if available)
9. Unit tests with sample PDF files
10. At least one working PDF fetcher for a real Germany immigration source (test source)

## Tasks / Subtasks

- [x] Task 1: Choose PDF extraction library (AC: 2)
  - [x] Evaluate options: `pdfplumber`, `PyPDF2`, `pdftotext` (subprocess)
  - [x] Select `pdfplumber` or `PyPDF2` (Python library preferred over subprocess)
  - [x] Add dependency to `requirements.txt`
- [x] Task 2: Create base PDF fetcher module (AC: 1, 3, 4, 5)
  - [x] Create `fetchers/pdf_fetcher.py` or base PDF fetcher utilities
  - [x] Implement `fetch(url: str, metadata: dict) -> FetchResult` function
  - [x] Handle PDFs from URLs:
    - [x] Download PDF to temporary file
    - [x] Extract text from PDF
    - [x] Clean up temporary file
  - [x] Handle local PDF files (for testing):
    - [x] Accept file path in metadata
    - [x] Extract text directly from file
  - [x] Extract text while preserving structure:
    - [x] Preserve paragraphs
    - [x] Preserve line breaks
    - [x] Remove excessive whitespace
- [x] Task 3: Implement PDF text extraction (AC: 1, 5)
  - [x] Use selected library to extract text
  - [x] Extract text page by page
  - [x] Combine pages with appropriate separators
  - [x] Preserve paragraph structure
  - [x] Normalize whitespace (multiple spaces to single space)
- [x] Task 4: Handle encrypted/protected PDFs (AC: 6)
  - [x] Detect encrypted PDFs
  - [x] Return error in `FetchResult` with appropriate message
  - [x] Log encryption detection
  - [x] Do not attempt to decrypt (security/privacy concern)
- [x] Task 5: Handle corrupted/invalid PDFs (AC: 7)
  - [x] Catch PDF parsing errors
  - [x] Return error in `FetchResult` with appropriate message
  - [x] Log error details
  - [x] Handle file corruption gracefully
- [x] Task 6: Extract PDF metadata (AC: 8)
  - [x] Extract page count
  - [x] Extract creation date if available
  - [x] Extract modification date if available
  - [x] Extract author/title if available
  - [x] Store metadata in `FetchResult.metadata` dictionary
- [x] Task 7: Create example PDF fetcher (AC: 10)
  - [x] Create `fetchers/de_bmi_work.py` (or similar Germany PDF source)
  - [x] Implement `fetch()` function using PDF fetcher utilities
  - [x] Test with real PDF source URL
  - [x] Verify text extraction works correctly
  - [x] Document source URL and what it monitors
- [x] Task 8: Create unit tests (AC: 9)
  - [x] Create `tests/unit/test_fetchers/test_pdf_fetcher.py`
  - [x] Test with sample PDF files:
    - [x] Valid PDF with text
    - [x] Encrypted/protected PDF
    - [x] Corrupted PDF
    - [x] PDF with images only (no extractable text)
  - [x] Test text extraction:
    - [x] Verify text is extracted correctly
    - [x] Verify structure is preserved
  - [x] Test metadata extraction:
    - [x] Page count
    - [x] Creation date
  - [x] Test error handling:
    - [x] Encrypted PDF error
    - [x] Corrupted PDF error
    - [x] Invalid file error

## Dev Notes

### Previous Story Insights
- Story 2.1 created fetcher plugin architecture
- Story 2.2 created HTML fetcher implementation (similar pattern)
- `FetchResult` dataclass/model is defined
- Fetcher registry system is available

### Components Architecture
[Source: architecture/components.md]

**Source Fetchers (Plugin System):**
- Individual plugin modules for specific government sources
- Standard interface: `fetch(url, metadata) -> FetchResult`
- Technology: `pdftotext` or `pdfplumber` for PDF extraction

**Dependencies:**
- External government sources (HTTP requests for PDF URLs)
- `requests` library for downloading PDFs
- `pdfplumber` or `PyPDF2` for PDF text extraction

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `fetchers/pdf_fetcher.py` - Base PDF fetcher utilities (optional, can be in individual fetchers)
- `fetchers/de_bmi_work.py` - Example PDF fetcher for Germany BMI Work visa
- `tests/unit/test_fetchers/test_pdf_fetcher.py` - Unit tests
- Sample PDF files in `tests/fixtures/` for testing

### Coding Standards
[Source: architecture/coding-standards.md]

**Fetcher Interface:** All source fetchers must implement the `SourceFetcher` interface.

**Error Handling:** Fetchers should return error status in `FetchResult`, not raise exceptions.

**Logging:** Use Python's `logging` module for fetcher operations.

**Type Hints:** All Python functions must have type hints.

**File Handling:** Always clean up temporary files, use context managers.

### Tech Stack
[Source: architecture/tech-stack.md]

**Dependencies to add:**
- `pdfplumber` or `PyPDF2` - PDF text extraction
- `requests` - For downloading PDFs from URLs (already added in Story 2.2)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test with sample PDF files
- Test error handling scenarios
- Test metadata extraction
- Use fixtures for test PDFs

### Technical Constraints
- Must handle PDFs from URLs (download first)
- Must clean up temporary files
- Must handle encrypted PDFs gracefully (return error)
- Must handle corrupted PDFs gracefully (return error)
- Must preserve text structure (paragraphs, line breaks)
- Must extract metadata when available

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_fetchers/test_pdf_fetcher.py`

**Test Standards:**
- Use pytest framework
- Test files follow `test_*.py` naming convention
- Use sample PDF files in `tests/fixtures/` directory

**Testing Frameworks:**
- pytest 7.4+ with async support

**Specific Testing Requirements:**
- Test successful PDF text extraction
- Test encrypted PDF handling (return error)
- Test corrupted PDF handling (return error)
- Test metadata extraction (page count, dates)
- Test text structure preservation
- Test temporary file cleanup
- Test local file handling (for testing)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Auto)

### Debug Log References
None - No debug issues encountered during implementation.

### Completion Notes List
- Selected PyPDF2 library (already in requirements.txt) for PDF text extraction
- Created comprehensive PDF fetcher utilities module (`fetchers/pdf_fetcher.py`) with all required functionality
- Implemented `fetch_pdf()` function that handles PDFs from URLs and local files
- PDF download uses existing `fetch_html_with_retry()` for consistent HTTP handling with retry logic
- Text extraction preserves paragraph structure by combining pages with double newline separators
- Whitespace normalization: multiple spaces/tabs to single space, multiple newlines to double newline
- Encrypted PDF detection using `PdfEncryptionError`, returns appropriate error without attempting decryption
- Corrupted PDF handling using `PdfReadError`, returns parse error with details
- Metadata extraction includes: page count, creation date, modification date, author, title, subject
- Temporary file cleanup ensured using try/finally blocks
- Local file support via `file_path` in metadata for testing purposes
- Created example fetcher `de_bmi_work.py` demonstrating usage of PDF fetcher utilities
- Comprehensive unit tests covering all functionality: text extraction, metadata extraction, error handling, file cleanup

### File List
**Created:**
- `fetchers/pdf_fetcher.py` - Comprehensive PDF fetcher utilities module
- `fetchers/de_bmi_work.py` - Example PDF fetcher for Germany BMI Work visa
- `tests/unit/test_fetchers/test_pdf_fetcher.py` - Comprehensive unit tests

**Modified:**
- None (PyPDF2 already in requirements.txt)

## QA Results
_To be populated by QA Agent_

