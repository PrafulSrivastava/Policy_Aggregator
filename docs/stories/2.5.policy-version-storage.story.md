# Story 2.5: Policy Version Storage

## Status
Draft

## Story
**As a** developer,  
**I want** automatic storage of fetched policy content as versioned documents,  
**so that** I have a complete audit trail of all policy versions over time.

## Acceptance Criteria

1. After successful fetch and normalization, create PolicyVersion record:
   - source_id (foreign key)
   - content_hash (SHA256 of normalized content)
   - raw_text (normalized text content)
   - fetched_at (timestamp)
2. PolicyVersion records are immutable (never updated, only new versions created)
3. If same hash already exists for a source, do not create duplicate (idempotent)
4. Store full text content (not just hash) for diff generation later
5. Database indexes on source_id and fetched_at for efficient queries
6. Helper function to retrieve latest PolicyVersion for a source
7. Helper function to retrieve PolicyVersion by hash
8. Unit tests for version storage logic
9. Integration test: fetch same source twice, verify only one version if unchanged

## Tasks / Subtasks

- [x] Task 1: Create version storage service (AC: 1, 2, 3, 4)
  - [x] Create `api/services/version_storage.py` or add to existing service
  - [x] Implement `store_policy_version(source_id: UUID, normalized_text: str, fetched_at: datetime) -> PolicyVersion` function
  - [x] Generate SHA256 hash of normalized content (use utility from Story 1.3)
  - [x] Check if hash already exists for this source (idempotency check)
  - [x] If hash exists, return existing PolicyVersion (do not create duplicate)
  - [x] If hash is new, create new PolicyVersion record:
    - [x] source_id
    - [x] content_hash
    - [x] raw_text (normalized text)
    - [x] fetched_at
    - [x] normalized_at (current timestamp)
    - [x] content_length
    - [x] fetch_duration (if available from fetch metadata)
  - [x] Ensure immutability (never update existing PolicyVersion)
- [x] Task 2: Verify database indexes (AC: 5)
  - [x] Verify indexes exist from Story 1.2:
    - [x] Index on `policy_versions.source_id`
    - [x] Index on `policy_versions.content_hash`
    - [x] Index on `policy_versions.fetched_at` (DESC)
    - [x] Composite index on `(source_id, fetched_at DESC)`
  - [x] Create migration if indexes missing
- [x] Task 3: Add helper functions to repository (AC: 6, 7)
  - [x] Update `api/repositories/policy_version_repository.py` (from Story 1.3)
  - [x] Verify `get_latest_by_source_id(source_id)` exists
  - [x] Verify `get_by_hash(content_hash)` exists
  - [x] Verify `exists_by_hash(source_id, content_hash)` exists (for idempotency)
  - [x] Add if missing
- [ ] Task 4: Integrate with fetch pipeline (AC: 1)
  - [ ] Call version storage after normalization step
  - [ ] Pass normalized text and fetch metadata
  - [ ] Handle storage errors gracefully
  - [ ] Log version storage operations
  - Note: This will be completed in Story 2.9 (End-to-End Fetch Pipeline) when full pipeline is orchestrated
- [x] Task 5: Create unit tests (AC: 8)
  - [x] Create `tests/unit/test_services/test_version_storage.py`
  - [x] Test version storage:
    - [x] Creates new PolicyVersion for new content
    - [x] Returns existing PolicyVersion for duplicate hash (idempotency)
    - [x] Stores full text content
    - [x] Generates correct hash
  - [x] Test immutability:
    - [x] Verify PolicyVersion is never updated
    - [x] Verify new versions are always created
  - [x] Test helper functions:
    - [x] `get_latest_by_source_id()`
    - [x] `get_by_hash()`
- [x] Task 6: Create integration test (AC: 9)
  - [x] Create `tests/integration/test_pipeline/test_version_storage.py`
  - [x] Test: fetch same source twice with unchanged content
  - [x] Verify only one PolicyVersion created
  - [x] Verify second fetch returns existing version
  - [x] Test: fetch same source with changed content
  - [x] Verify two PolicyVersions created

## Dev Notes

### Previous Story Insights
- Story 1.3 created PolicyVersion repository with CRUD operations
- Story 1.3 created hashing utility (`api/utils/hashing.py`)
- Story 2.4 created normalization pipeline
- Story 1.2 created PolicyVersion database model and indexes

### Data Models
[Source: architecture/data-models.md]

**PolicyVersion Model:**
- `id`: UUID (primary key)
- `sourceId`: UUID (foreign key to Source)
- `contentHash`: string (SHA256, 64 characters)
- `rawText`: string (full normalized text)
- `fetchedAt`: Date
- `normalizedAt`: Date
- `contentLength`: number
- `fetchDuration`: number (milliseconds)
- `createdAt`: Date

**Immutability Requirements:**
- PolicyVersion records are NEVER updated, only new versions created
- This ensures complete audit trail

### Database Schema
[Source: architecture/database-schema.md]

**Policy Versions Table:**
- Indexes on `source_id`, `content_hash`, `fetched_at`
- Composite index on `(source_id, fetched_at DESC)` for efficient "latest version" queries

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create/update:
- `api/services/version_storage.py` - Version storage service (or add to existing service)
- `api/repositories/policy_version_repository.py` - Verify helper functions exist
- `tests/unit/test_services/test_version_storage.py` - Unit tests
- `tests/integration/test_pipeline/test_version_storage.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern. Never write raw SQL queries.

**Type Hints:** All Python functions must have type hints.

**Async/Await:** Use `async def` and `await` for all database operations.

**Immutability:** PolicyVersion records must never be updated. Always create new versions.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test version storage logic
- Test idempotency
- Test immutability

**Integration Tests:**
- Test full flow: fetch → normalize → store
- Test duplicate detection

### Technical Constraints
- SHA256 hashes must be exactly 64 characters
- PolicyVersion records are immutable (no update operations)
- Must check for duplicate hashes before creating new version
- Must store full text content (not just hash)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_version_storage.py` and `tests/integration/test_pipeline/test_version_storage.py`

**Test Standards:**
- Use pytest framework
- Use async test fixtures for database operations
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- pytest-asyncio for async test support

**Specific Testing Requirements:**
- Test version storage creates new PolicyVersion
- Test idempotency (duplicate hash returns existing version)
- Test immutability (never updates existing version)
- Test helper functions (get_latest, get_by_hash)
- Test integration: fetch same source twice, verify idempotency

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Auto)

### Debug Log References
None - No debug issues encountered during implementation.

### Completion Notes List
- Created version storage service (`api/services/version_storage.py`) with idempotency and immutability guarantees
- Implemented `store_policy_version()` function that generates SHA256 hash, checks for duplicates, and creates new versions only when needed
- Idempotency: If same hash exists for source, returns existing PolicyVersion (no duplicate created)
- Immutability: PolicyVersion records are never updated, only new versions created
- Full text storage: Stores complete normalized text content (not just hash) for diff generation
- Helper functions: `get_latest_policy_version()` and `get_policy_version_by_hash()` for retrieval
- Database indexes verified: All required indexes exist in PolicyVersion model (source_id, content_hash, fetched_at, composite)
- Repository functions verified: All required helper functions already exist in PolicyVersionRepository (get_latest_by_source_id, get_by_hash, exists_by_hash)
- Fetch duration support: Extracts fetch_duration from fetch_metadata if available
- Comprehensive unit tests covering version storage, idempotency, immutability, and helper functions
- Integration tests demonstrating full pipeline: fetch → normalize → store, with idempotency verification
- Note: Task 4 (integration with fetch pipeline) will be completed in Story 2.9 when the full end-to-end pipeline is orchestrated

### File List
**Created:**
- `api/services/version_storage.py` - Version storage service with idempotency
- `tests/unit/test_services/test_version_storage.py` - Comprehensive unit tests
- `tests/integration/test_pipeline/__init__.py` - Integration test package init
- `tests/integration/test_pipeline/test_version_storage.py` - Integration tests

**Verified (already exist):**
- `api/models/db/policy_version.py` - PolicyVersion model with all required fields and indexes
- `api/repositories/policy_version_repository.py` - Repository with all required helper functions
- `api/utils/hashing.py` - Hashing utility for SHA256 generation

## QA Results
_To be populated by QA Agent_

