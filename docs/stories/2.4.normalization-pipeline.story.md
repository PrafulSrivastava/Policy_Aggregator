# Story 2.4: Normalization Pipeline

## Status
Draft

## Story
**As a** developer,  
**I want** a normalization pipeline that prepares content for stable diff comparison,  
**so that** I can detect real changes without false positives from formatting differences.

## Acceptance Criteria

1. Normalization function that processes raw fetched text:
   - Strips leading/trailing whitespace from each line
   - Normalizes multiple spaces to single space
   - Normalizes line breaks (handles Windows/Unix/Mac line endings)
   - Removes common boilerplate (headers, footers, navigation if identifiable)
2. Configurable normalization rules (can be adjusted per source if needed)
3. Preserves meaningful content structure (paragraphs, sections)
4. Does NOT perform semantic parsing or interpretation
5. Unit tests with before/after examples showing normalization
6. Test cases: whitespace normalization, line break normalization, boilerplate removal
7. Documentation of normalization rules and rationale
8. Performance: normalization completes quickly even for large documents

## Tasks / Subtasks

- [x] Task 1: Create normalization service (AC: 1, 3, 4)
  - [x] Create `api/services/normalizer.py`
  - [x] Implement `normalize(raw_text: str, source_metadata: Optional[dict] = None) -> str` function
  - [x] Strip leading/trailing whitespace from each line
  - [x] Normalize multiple spaces to single space
  - [x] Normalize line breaks (convert all to `\n`)
  - [x] Preserve paragraph structure (double line breaks)
  - [x] Do NOT perform semantic parsing
- [x] Task 2: Implement boilerplate removal (AC: 1)
  - [x] Identify common boilerplate patterns:
    - [x] Headers (copyright notices, site navigation)
    - [x] Footers (contact info, legal disclaimers)
    - [x] Navigation menus (if identifiable)
  - [x] Use regex patterns or heuristics to detect boilerplate
  - [x] Remove detected boilerplate
  - [x] Make boilerplate removal configurable per source
- [x] Task 3: Add configurable normalization rules (AC: 2)
  - [x] Create `api/services/normalization_rules.py` (optional)
  - [x] Allow source-specific normalization rules via metadata
  - [x] Support custom patterns for boilerplate removal
  - [x] Support custom whitespace handling if needed
  - [x] Default rules apply if no source-specific rules
- [x] Task 4: Optimize normalization performance (AC: 8)
  - [x] Use efficient string operations
  - [x] Process text in chunks if very large
  - [x] Avoid multiple passes over text where possible
  - [x] Test with large documents (100KB+)
  - [x] Ensure normalization completes in reasonable time (< 1 second for typical documents)
- [x] Task 5: Create unit tests (AC: 5, 6)
  - [x] Create `tests/unit/test_services/test_normalizer.py`
  - [x] Test whitespace normalization:
    - [x] Leading/trailing whitespace removal
    - [x] Multiple spaces to single space
    - [x] Tab normalization
  - [x] Test line break normalization:
    - [x] Windows line endings (`\r\n` → `\n`)
    - [x] Mac line endings (`\r` → `\n`)
    - [x] Unix line endings (unchanged)
  - [x] Test boilerplate removal:
    - [x] Header removal
    - [x] Footer removal
    - [x] Navigation removal
  - [x] Test structure preservation:
    - [x] Paragraph breaks preserved
    - [x] Section breaks preserved
  - [x] Test with before/after examples
- [x] Task 6: Create normalization documentation (AC: 7)
  - [x] Document normalization rules and rationale
  - [x] Explain why each normalization step is needed
  - [x] Document how to configure source-specific rules
  - [x] Include examples of normalized vs non-normalized text
  - [x] Add to README or create `docs/normalization.md`

## Dev Notes

### Previous Story Insights
- Story 2.2 and 2.3 created fetchers that return raw text
- `FetchResult` contains `raw_text` field
- Fetcher manager orchestrates fetching

### Components Architecture
[Source: architecture/components.md]

**Content Normalizer:**
- Normalizes fetched content to enable stable change detection
- Strips boilerplate, normalizes whitespace, removes timestamps/logos
- Ensures consistent hashing for change detection

**Key Interfaces:**
- `normalize(raw_text, source_metadata)` - Normalizes text content
  - Input: raw text from fetcher, source metadata for source-specific rules
  - Output: normalized text string ready for hashing

**Normalization Steps:**
1. Strip HTML tags (if HTML source) - handled by fetchers
2. Normalize whitespace (multiple spaces → single space)
3. Remove timestamps and dates (pattern-based)
4. Remove logos/watermarks (if detectable)
5. Convert to consistent encoding (UTF-8)
6. Trim leading/trailing whitespace

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/normalizer.py` - Normalization logic
- `api/services/normalization_rules.py` - Source-specific normalization rules (optional)
- `tests/unit/test_services/test_normalizer.py` - Unit tests
- `docs/normalization.md` - Normalization documentation (optional)

### Coding Standards
[Source: architecture/coding-standards.md]

**Type Hints:** All Python functions must have type hints.

**Error Handling:** Normalization should handle edge cases gracefully (empty text, very large text).

**Performance:** Normalization must be efficient for large documents.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test each normalization step individually
- Test with before/after examples
- Test edge cases (empty text, very large text)
- Test performance with large documents

### Technical Constraints
- Must preserve meaningful content structure
- Must NOT perform semantic parsing
- Must be configurable per source
- Must complete quickly even for large documents
- Must produce deterministic output (same input → same output)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_normalizer.py`

**Test Standards:**
- Use pytest framework
- Test files follow `test_*.py` naming convention
- Include before/after examples in tests

**Testing Frameworks:**
- pytest 7.4+ with async support

**Specific Testing Requirements:**
- Test whitespace normalization (leading/trailing, multiple spaces)
- Test line break normalization (Windows/Unix/Mac)
- Test boilerplate removal (headers, footers, navigation)
- Test structure preservation (paragraphs, sections)
- Test with before/after examples
- Test performance with large documents
- Test edge cases (empty text, very large text)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Auto)

### Debug Log References
None - No debug issues encountered during implementation.

### Completion Notes List
- Created comprehensive normalization service (`api/services/normalizer.py`) with all required functionality
- Implemented `normalize()` function that processes raw text through multiple normalization steps
- Normalization steps: line break normalization → boilerplate removal → whitespace normalization → structure preservation → final trim
- Boilerplate removal uses regex patterns for common headers, footers, navigation, copyright notices, timestamps
- Created configurable normalization rules system (`api/services/normalization_rules.py`) supporting source-specific custom rules
- Performance optimizations: compiled regex patterns, efficient string operations, single-pass where possible
- Tested with large documents (100KB+): completes in < 1 second for typical documents, < 5 seconds for very large (1MB+)
- Deterministic output: same input always produces same output (critical for consistent hashing)
- Preserves meaningful structure: paragraph breaks (double newlines) preserved, excessive blank lines normalized
- Does NOT perform semantic parsing: purely text-based normalization, no content interpretation
- Comprehensive unit tests covering all normalization steps, edge cases, and performance
- Complete documentation with examples, rationale, configuration guide, and troubleshooting

### File List
**Created:**
- `api/services/normalizer.py` - Main normalization service
- `api/services/normalization_rules.py` - Configurable normalization rules system
- `tests/unit/test_services/test_normalizer.py` - Comprehensive unit tests
- `docs/normalization.md` - Complete normalization documentation

**Modified:**
- None

## QA Results
_To be populated by QA Agent_

