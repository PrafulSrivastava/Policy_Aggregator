# Story 4.4: Source Configuration UI

## Status
Draft

## Story
**As an** admin user,  
**I want** a UI for managing policy sources,  
**so that** I can configure and monitor sources without using the API.

## Acceptance Criteria

1. Source list page: displays all sources in a table
   - Columns: country, visa_type, URL, fetch_type, check_frequency, last_checked, status
   - Sortable and filterable
   - Status indicators: active, error, never checked
2. Create source form:
   - Fields: country, visa_type, URL, fetch_type (dropdown: HTML, PDF), check_frequency
   - Validation: required fields, valid URL, valid fetch_type
   - Submit creates source via API
3. Edit source page: pre-filled form, update via API
4. Delete source: confirmation dialog (warn if source has versions/changes), delete via API
5. View source detail: shows source info, last check status, recent changes
6. Source status display: last checked timestamp, last change detected, error count
7. Manual test: create, edit, delete sources via UI

## Tasks / Subtasks

- [x] Task 1: Create source list page (AC: 1)
  - [x] Create `admin-ui/templates/pages/sources/list.html`
  - [x] Create table displaying sources:
    - [x] Columns: country, visa_type, URL, fetch_type, check_frequency, last_checked, status
    - [x] Use Tailwind CSS for table styling
  - [x] Add status indicators (badges):
    - [x] Active (green)
    - [x] Error (red)
    - [x] Never checked (gray)
  - [x] Add "Add New Source" button
  - [x] Add search/filter input field
  - [x] Add sorting functionality
  - [x] Make table responsive
- [x] Task 2: Create source list web route (AC: 1)
  - [x] Create or update `api/routes/web.py`
  - [x] Implement `GET /sources` route
    - [x] Fetch sources from API (`/api/sources`)
    - [x] Render source list template
    - [x] Require authentication
- [x] Task 3: Create source form template (AC: 2, 3)
  - [x] Create `admin-ui/templates/pages/sources/form.html`
  - [x] Create form with fields:
    - [x] Country (dropdown/select)
    - [x] Visa type (dropdown/select)
    - [x] URL (text input, type="url")
    - [x] Fetch type (dropdown: HTML, PDF)
    - [x] Check frequency (dropdown: daily, weekly, monthly)
  - [x] Add form validation (HTML5 and JavaScript)
  - [x] Add submit button
  - [x] Add cancel button (link back to list)
  - [x] Support both create and edit modes
- [x] Task 4: Create source form web routes (AC: 2, 3)
  - [x] Create `GET /sources/new` route:
    - [x] Render source form template (create mode)
    - [x] Require authentication
  - [x] Create `GET /sources/{id}` route:
    - [x] Fetch source from API
    - [x] Render source form template (edit mode, pre-filled)
    - [x] Require authentication
- [x] Task 5: Add form submission handling (AC: 2, 3)
  - [x] Update `admin-ui/static/js/forms.js`
  - [x] Add source form submission handler:
    - [x] Prevent default form submission
    - [x] Collect form data
    - [x] Validate form data (client-side)
    - [x] Call API to create/update source
    - [x] Show success message
    - [x] Redirect to source list on success
    - [x] Show error message on failure
  - [x] Use API client from `api.js`
- [x] Task 6: Add delete functionality with warning (AC: 4)
  - [x] Add delete button to source list or detail page
  - [x] Before deletion, check if source has versions/changes:
    - [x] Call API to check source usage
    - [x] If source has versions/changes, show warning message
  - [x] Add confirmation dialog (JavaScript modal)
  - [x] On confirmation, call API to delete source
  - [x] Show success message
  - [x] Refresh source list
- [x] Task 7: Create source detail page (AC: 5, 6)
  - [x] Create `admin-ui/templates/pages/sources/detail.html`
  - [x] Display source information:
    - [x] Country, visa_type, URL, fetch_type, check_frequency
  - [x] Display source status:
    - [x] Last checked timestamp
    - [x] Last change detected timestamp
    - [x] Error count (if any)
    - [x] Status indicator (active, error, never checked)
  - [x] Display recent changes (last 5-10, link to change detail)
  - [x] Add edit and delete buttons
  - [x] Add "Trigger Fetch" button (for Story 4.7)
- [x] Task 8: Add status calculation logic (AC: 1, 6)
  - [x] Create or update `api/services/source.py`
  - [x] Implement `get_source_status(source)` function:
    - [x] Check if source has been checked (has PolicyVersion records)
    - [x] Check for recent errors (from error tracking)
    - [x] Check if last check is beyond expected frequency
    - [x] Return status: "active", "error", "never_checked", "stale"
  - [x] Use in source list and detail pages
- [x] Task 9: Add error handling (AC: 2, 3, 4)
  - [x] Display API errors in form:
    - [x] Show error message above form
    - [x] Highlight invalid fields
    - [x] Show field-specific errors if available
  - [x] Handle network errors gracefully
  - [x] Show user-friendly error messages
- [x] Task 10: Add search/filter functionality (AC: 1)
  - [x] Add search input to source list page
  - [x] Implement client-side filtering (JavaScript):
    - [x] Filter by country, visa_type, fetch_type, status
    - [x] Real-time filtering as user types
  - [x] Or implement server-side filtering (API call with query params)
- [x] Task 11: Add sorting functionality (AC: 1)
  - [x] Add sortable column headers to table
  - [x] Implement client-side sorting (JavaScript):
    - [x] Click column header to sort
    - [x] Toggle ascending/descending
    - [x] Show sort indicator
  - [x] Or implement server-side sorting (API call with sort params)
- [ ] Task 12: Manual testing (AC: 7)
  - [ ] Test create source form
  - [ ] Test edit source form
  - [ ] Test delete source (with warning if has versions)
  - [ ] Test source list display
  - [ ] Test status indicators
  - [ ] Test source detail page
  - [ ] Test search/filter
  - [ ] Test sorting

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation
- Story 4.3 created route management UI (similar pattern)
- Story 1.7 created Source API endpoints
- Story 2.5 created PolicyVersion storage
- Story 2.8 created PolicyChange records
- Story 3.7 created error tracking

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/sources             → Sources list
/sources/new         → Create source form
/sources/{id}         → Source detail/edit
/sources/{id}/delete  → Delete source (POST)
```

**API Client:**
- `api.getSources(filters)` - Get all sources
- `api.createSource(data)` - Create source
- `api.updateSource(id, data)` - Update source
- `api.deleteSource(id)` - Delete source

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `admin-ui/templates/pages/sources/list.html` - Source list page
- `admin-ui/templates/pages/sources/form.html` - Source create/edit form
- `admin-ui/templates/pages/sources/detail.html` - Source detail page
- `api/routes/web.py` - Add source web routes
- `api/services/source.py` - Source status calculation (if not exists)
- `admin-ui/static/js/forms.js` - Update form handling

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately.

**Form Validation:** Validate on both client-side and server-side.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test source list page
- Test source form submission
- Test delete functionality
- Test status calculation

**Manual Testing:**
- Test all CRUD operations via UI
- Test status indicators
- Test error handling

### Technical Constraints
- Must use API endpoints (not direct database access)
- Must validate forms client-side and server-side
- Must handle errors gracefully
- Must be responsive
- Must show status indicators correctly

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_web/test_sources.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test source list page rendering
- Test source form rendering (create and edit)
- Test form submission (create and update)
- Test delete functionality (with warning)
- Test status calculation logic
- Test error handling
- Manual test: full CRUD operations via UI

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Implemented source list page with table, status indicators, search/filter, and sorting
- Created source form template supporting both create and edit modes
- Added source detail page showing source information, status, and recent changes
- Implemented status calculation logic (active, error, never_checked, stale)
- Added form validation (client-side and server-side via API)
- Implemented delete functionality with confirmation dialog
- All routes require authentication via `get_current_user_web` dependency
- Status calculation checks for errors, last checked time, and expected frequency
- Client-side search/filter and sorting implemented in JavaScript
- Error handling displays user-friendly messages with field-level validation

### File List
**Created:**
- `admin-ui/templates/pages/sources/list.html` - Source list page template
- `admin-ui/templates/pages/sources/form.html` - Source create/edit form template
- `admin-ui/templates/pages/sources/detail.html` - Source detail page template
- `admin-ui/static/js/sources.js` - Source list page JavaScript (search, filter, sort, delete)
- `api/services/source.py` - Source service with status calculation logic

**Modified:**
- `api/routes/web.py` - Added source web routes (list, new, edit, detail)
- `admin-ui/static/js/api.js` - Added source API methods (getSources, getSource, createSource, updateSource, deleteSource)
- `admin-ui/static/js/forms.js` - Added source form submission handling and validation
- `admin-ui/static/js/countries.js` - Updated to populate country dropdown for source forms

## QA Results
_To be populated by QA Agent_



