# Story 4.4: Source Configuration UI

## Status
Draft

## Story
**As an** admin user,  
**I want** a UI for managing policy sources,  
**so that** I can configure and monitor sources without using the API.

## Acceptance Criteria

1. Source list page: displays all sources in a table
   - Columns: country, visa_type, URL, fetch_type, check_frequency, last_checked, status
   - Sortable and filterable
   - Status indicators: active, error, never checked
2. Create source form:
   - Fields: country, visa_type, URL, fetch_type (dropdown: HTML, PDF), check_frequency
   - Validation: required fields, valid URL, valid fetch_type
   - Submit creates source via API
3. Edit source page: pre-filled form, update via API
4. Delete source: confirmation dialog (warn if source has versions/changes), delete via API
5. View source detail: shows source info, last check status, recent changes
6. Source status display: last checked timestamp, last change detected, error count
7. Manual test: create, edit, delete sources via UI

## Tasks / Subtasks

- [ ] Task 1: Create source list page (AC: 1)
  - [ ] Create `admin-ui/templates/pages/sources/list.html`
  - [ ] Create table displaying sources:
    - [ ] Columns: country, visa_type, URL, fetch_type, check_frequency, last_checked, status
    - [ ] Use Tailwind CSS for table styling
  - [ ] Add status indicators (badges):
    - [ ] Active (green)
    - [ ] Error (red)
    - [ ] Never checked (gray)
  - [ ] Add "Add New Source" button
  - [ ] Add search/filter input field
  - [ ] Add sorting functionality
  - [ ] Make table responsive
- [ ] Task 2: Create source list web route (AC: 1)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /sources` route
    - [ ] Fetch sources from API (`/api/sources`)
    - [ ] Render source list template
    - [ ] Require authentication
- [ ] Task 3: Create source form template (AC: 2, 3)
  - [ ] Create `admin-ui/templates/pages/sources/form.html`
  - [ ] Create form with fields:
    - [ ] Country (dropdown/select)
    - [ ] Visa type (dropdown/select)
    - [ ] URL (text input, type="url")
    - [ ] Fetch type (dropdown: HTML, PDF)
    - [ ] Check frequency (dropdown: daily, weekly, monthly)
  - [ ] Add form validation (HTML5 and JavaScript)
  - [ ] Add submit button
  - [ ] Add cancel button (link back to list)
  - [ ] Support both create and edit modes
- [ ] Task 4: Create source form web routes (AC: 2, 3)
  - [ ] Create `GET /sources/new` route:
    - [ ] Render source form template (create mode)
    - [ ] Require authentication
  - [ ] Create `GET /sources/{id}` route:
    - [ ] Fetch source from API
    - [ ] Render source form template (edit mode, pre-filled)
    - [ ] Require authentication
- [ ] Task 5: Add form submission handling (AC: 2, 3)
  - [ ] Update `admin-ui/static/js/forms.js`
  - [ ] Add source form submission handler:
    - [ ] Prevent default form submission
    - [ ] Collect form data
    - [ ] Validate form data (client-side)
    - [ ] Call API to create/update source
    - [ ] Show success message
    - [ ] Redirect to source list on success
    - [ ] Show error message on failure
  - [ ] Use API client from `api.js`
- [ ] Task 6: Add delete functionality with warning (AC: 4)
  - [ ] Add delete button to source list or detail page
  - [ ] Before deletion, check if source has versions/changes:
    - [ ] Call API to check source usage
    - [ ] If source has versions/changes, show warning message
  - [ ] Add confirmation dialog (JavaScript modal)
  - [ ] On confirmation, call API to delete source
  - [ ] Show success message
  - [ ] Refresh source list
- [ ] Task 7: Create source detail page (AC: 5, 6)
  - [ ] Create `admin-ui/templates/pages/sources/detail.html`
  - [ ] Display source information:
    - [ ] Country, visa_type, URL, fetch_type, check_frequency
  - [ ] Display source status:
    - [ ] Last checked timestamp
    - [ ] Last change detected timestamp
    - [ ] Error count (if any)
    - [ ] Status indicator (active, error, never checked)
  - [ ] Display recent changes (last 5-10, link to change detail)
  - [ ] Add edit and delete buttons
  - [ ] Add "Trigger Fetch" button (for Story 4.7)
- [ ] Task 8: Add status calculation logic (AC: 1, 6)
  - [ ] Create or update `api/services/source.py`
  - [ ] Implement `get_source_status(source)` function:
    - [ ] Check if source has been checked (has PolicyVersion records)
    - [ ] Check for recent errors (from error tracking)
    - [ ] Check if last check is beyond expected frequency
    - [ ] Return status: "active", "error", "never_checked", "stale"
  - [ ] Use in source list and detail pages
- [ ] Task 9: Add error handling (AC: 2, 3, 4)
  - [ ] Display API errors in form:
    - [ ] Show error message above form
    - [ ] Highlight invalid fields
    - [ ] Show field-specific errors if available
  - [ ] Handle network errors gracefully
  - [ ] Show user-friendly error messages
- [ ] Task 10: Add search/filter functionality (AC: 1)
  - [ ] Add search input to source list page
  - [ ] Implement client-side filtering (JavaScript):
    - [ ] Filter by country, visa_type, fetch_type, status
    - [ ] Real-time filtering as user types
  - [ ] Or implement server-side filtering (API call with query params)
- [ ] Task 11: Add sorting functionality (AC: 1)
  - [ ] Add sortable column headers to table
  - [ ] Implement client-side sorting (JavaScript):
    - [ ] Click column header to sort
    - [ ] Toggle ascending/descending
    - [ ] Show sort indicator
  - [ ] Or implement server-side sorting (API call with sort params)
- [ ] Task 12: Manual testing (AC: 7)
  - [ ] Test create source form
  - [ ] Test edit source form
  - [ ] Test delete source (with warning if has versions)
  - [ ] Test source list display
  - [ ] Test status indicators
  - [ ] Test source detail page
  - [ ] Test search/filter
  - [ ] Test sorting

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation
- Story 4.3 created route management UI (similar pattern)
- Story 1.7 created Source API endpoints
- Story 2.5 created PolicyVersion storage
- Story 2.8 created PolicyChange records
- Story 3.7 created error tracking

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/sources             → Sources list
/sources/new         → Create source form
/sources/{id}         → Source detail/edit
/sources/{id}/delete  → Delete source (POST)
```

**API Client:**
- `api.getSources(filters)` - Get all sources
- `api.createSource(data)` - Create source
- `api.updateSource(id, data)` - Update source
- `api.deleteSource(id)` - Delete source

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `admin-ui/templates/pages/sources/list.html` - Source list page
- `admin-ui/templates/pages/sources/form.html` - Source create/edit form
- `admin-ui/templates/pages/sources/detail.html` - Source detail page
- `api/routes/web.py` - Add source web routes
- `api/services/source.py` - Source status calculation (if not exists)
- `admin-ui/static/js/forms.js` - Update form handling

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Error Handling:** Display errors to users appropriately.

**Form Validation:** Validate on both client-side and server-side.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test source list page
- Test source form submission
- Test delete functionality
- Test status calculation

**Manual Testing:**
- Test all CRUD operations via UI
- Test status indicators
- Test error handling

### Technical Constraints
- Must use API endpoints (not direct database access)
- Must validate forms client-side and server-side
- Must handle errors gracefully
- Must be responsive
- Must show status indicators correctly

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_web/test_sources.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test source list page rendering
- Test source form rendering (create and edit)
- Test form submission (create and update)
- Test delete functionality (with warning)
- Test status calculation logic
- Test error handling
- Manual test: full CRUD operations via UI

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



