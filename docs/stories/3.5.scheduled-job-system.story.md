# Story 3.5: Scheduled Job System

## Status
Ready for Review

## Story
**As a** developer,  
**I want** a scheduled job system that runs the fetch pipeline daily,  
**so that** the system monitors sources automatically without manual intervention.

## Acceptance Criteria

1. Scheduled job function: `run_daily_fetch_job()`
2. Job orchestrates:
   - Get all active sources from database
   - For each source, run fetch pipeline
   - If change detected, trigger alert engine
3. Job handles errors gracefully: one source failure doesn't stop others
4. Job logs start/end time, sources processed, changes detected, errors
5. Job can be triggered manually via API endpoint for testing
6. Job respects source.check_frequency (daily for MVP, but extensible)
7. Integration test: run job with test sources, verify full flow
8. Unit tests for job orchestration logic

## Tasks / Subtasks

- [x] Task 1: Create scheduled job service (AC: 1, 2)
  - [x] Create `api/services/scheduler.py` or `scripts/run_daily_fetch_job.py`
  - [x] Implement `run_daily_fetch_job() -> JobResult` function
  - [x] Job orchestration:
    - [x] Get all active sources from database (use Source repository)
    - [x] Filter sources by check_frequency (daily for MVP)
    - [x] For each source:
      - [x] Run fetch pipeline (use fetcher_manager from Story 2.9)
      - [x] If change detected (from PipelineResult):
        - [x] Get PolicyChange ID from pipeline result
        - [x] Trigger alert engine (use alert_engine from Story 3.4)
    - [x] Collect results from all sources
- [x] Task 2: Create JobResult model (AC: 4)
  - [x] Create dataclass or Pydantic model:
    - [x] `started_at: datetime`
    - [x] `completed_at: datetime`
    - [x] `sources_processed: int`
    - [x] `sources_succeeded: int`
    - [x] `sources_failed: int`
    - [x] `changes_detected: int`
    - [x] `alerts_sent: int`
    - [x] `errors: List[str]`
- [x] Task 3: Implement error handling (AC: 3)
  - [x] Wrap each source fetch in try-except
  - [x] If source fetch fails, log error and continue with next source
  - [x] Track failed sources in JobResult
  - [x] Do not stop job on single source failure
  - [x] Collect all errors for summary
- [x] Task 4: Add comprehensive logging (AC: 4)
  - [x] Log job start: "Starting daily fetch job at {timestamp}"
  - [x] Log for each source:
    - [x] "Processing source {source_id}: {source_name}"
    - [x] "Source {source_id} processed: {success/failure}"
    - [x] "Change detected for source {source_id}" (if applicable)
  - [x] Log job summary:
    - [x] "Daily fetch job completed: {sources_processed} processed, {changes_detected} changes, {errors} errors"
  - [x] Use appropriate log levels (INFO for normal, ERROR for failures)
- [x] Task 5: Respect check_frequency (AC: 6)
  - [x] Filter sources by check_frequency before processing
  - [x] For MVP: only process sources with check_frequency="daily"
  - [x] Log skipped sources (if check_frequency != "daily")
  - [x] Design extensible for future frequencies (weekly, custom)
- [x] Task 6: Create API endpoint for manual trigger (AC: 5)
  - [x] Create or update `api/routes/api.py`
  - [x] Implement `POST /api/jobs/daily-fetch` endpoint
    - [x] Call `run_daily_fetch_job()`
    - [x] Return JobResult as JSON
    - [x] Require authentication
  - [x] Add to OpenAPI documentation
- [x] Task 7: Create unit tests (AC: 8)
  - [x] Create `tests/unit/test_services/test_scheduler.py`
  - [x] Test job orchestration:
    - [x] Gets all active sources
    - [x] Runs fetch pipeline for each source
    - [x] Triggers alert engine when change detected
  - [x] Test error handling:
    - [x] Source failure doesn't stop job
    - [x] Errors collected in JobResult
  - [x] Test check_frequency filtering
- [x] Task 8: Create integration test (AC: 7)
  - [x] Create `tests/integration/test_jobs/test_daily_fetch_job.py`
  - [x] Test: run job with test sources
    - [x] Create test sources
    - [x] Run daily fetch job
    - [x] Verify sources processed
    - [x] Verify changes detected (if applicable)
    - [x] Verify alerts sent (if changes detected)
  - [x] Test error handling with failing sources

## Dev Notes

### Previous Story Insights
- Story 2.9 created end-to-end fetch pipeline
- Story 3.4 created alert engine
- Story 1.3 created Source repository
- Story 1.2 created Source model with check_frequency field

### Components Architecture
[Source: architecture/components.md]

**Scheduler/Background Jobs:**
- Triggers daily fetch pipeline execution
- Runs as GitHub Actions cron job (Story 3.6)
- Provides scheduled automation for source monitoring

**Key Interfaces:**
- GitHub Actions workflow (`.github/workflows/daily-fetch.yml`)
  - Scheduled: daily at configured time (e.g., 2 AM UTC)
  - Executes: fetch pipeline for all active sources
  - Handles: errors, logging, notifications

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/scheduler.py` - Scheduled job service (or `scripts/run_daily_fetch_job.py`)
- `api/routes/api.py` - Add manual trigger endpoint
- `tests/unit/test_services/test_scheduler.py` - Unit tests
- `tests/integration/test_jobs/test_daily_fetch_job.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Error Handling:** Job should handle errors gracefully, not raise exceptions.

**Logging:** Use Python's `logging` module with appropriate log levels.

**Type Hints:** All Python functions must have type hints.

**Async/Await:** Use `async def` and `await` for all database operations.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test job orchestration
- Test error handling
- Test check_frequency filtering

**Integration Tests:**
- Test full job execution
- Test with multiple sources
- Test error scenarios

### Technical Constraints
- Job must handle errors gracefully (one failure doesn't stop others)
- Job must log comprehensive information
- Job must respect check_frequency
- Job must be callable via API endpoint

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_scheduler.py` and `tests/integration/test_jobs/test_daily_fetch_job.py`

**Test Standards:**
- Use pytest framework
- Use async test fixtures for database operations
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- pytest-asyncio for async test support

**Specific Testing Requirements:**
- Test job orchestration (get sources, run pipeline, trigger alerts)
- Test error handling (source failures don't stop job)
- Test check_frequency filtering
- Test integration: full job execution with test sources

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Created `api/services/scheduler.py` with `run_daily_fetch_job()` function that orchestrates daily fetch operations
- Implemented `JobResult` dataclass to track job execution results
- Added comprehensive error handling: individual source failures don't stop the job
- Implemented check_frequency filtering: only processes sources with `check_frequency="daily"`
- Added comprehensive logging at job start, per-source processing, and job completion
- Created `POST /api/jobs/daily-fetch` API endpoint for manual job triggering (requires authentication)
- Registered jobs_router in `api/main.py`
- Created comprehensive unit tests in `tests/unit/test_services/test_scheduler.py` covering:
  - Job orchestration with no changes
  - Job orchestration with changes detected and alerts sent
  - check_frequency filtering
  - Error handling (source failures, exceptions, alert failures)
  - Multiple sources processing
  - Edge cases (no sources, no daily sources)
- Created integration tests in `tests/integration/test_jobs/test_daily_fetch_job.py` covering:
  - Full job execution with test sources
  - Changes detected and alerts sent flow
  - Error handling with failing sources
  - Edge cases (no sources, only weekly sources)

### File List
**Created:**
- `api/services/scheduler.py` - Scheduled job service with `run_daily_fetch_job()` function
- `tests/unit/test_services/test_scheduler.py` - Unit tests for scheduler service
- `tests/integration/test_jobs/test_daily_fetch_job.py` - Integration tests for daily fetch job
- `tests/integration/test_jobs/__init__.py` - Package init file

**Modified:**
- `api/routes/api.py` - Added jobs_router and `POST /api/jobs/daily-fetch` endpoint
- `api/main.py` - Registered jobs_router

## QA Results
_To be populated by QA Agent_

