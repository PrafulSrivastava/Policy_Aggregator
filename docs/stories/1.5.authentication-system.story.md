# Story 1.5: Authentication System

## Status
Ready for Review

## Story
**As an** admin user,  
**I want** simple password-based authentication,  
**so that** I can securely access the admin interface and API endpoints.

## Acceptance Criteria

1. User model/table for admin users (username, hashed_password, created_at)
2. Password hashing using secure method (bcrypt or similar)
3. Login endpoint (`POST /auth/login`) that:
   - Accepts username and password
   - Validates credentials
   - Returns session token or sets session cookie
4. Authentication middleware/dependency for protecting routes
5. Logout functionality
6. Session management (JWT tokens or server-side sessions)
7. At least one admin user can be created (via script or migration)
8. Protected endpoints require authentication (test with health check remaining public)

## Tasks / Subtasks

- [x] Task 1: Create User repository (AC: 1)
  - [x] Create `api/repositories/user_repository.py`
  - [x] Implement `create(user_data: dict) -> User`
  - [x] Implement `get_by_id(user_id: UUID) -> Optional[User]`
  - [x] Implement `get_by_username(username: str) -> Optional[User]`
  - [x] Implement `update(user_id: UUID, update_data: dict) -> User`
- [x] Task 2: Create Pydantic schemas for authentication (AC: 3)
  - [x] Create `api/models/schemas/user.py`
  - [x] Create `LoginRequest` schema (username, password)
  - [x] Create `LoginResponse` schema (access_token, token_type)
  - [x] Create `UserResponse` schema (id, username, created_at)
- [x] Task 3: Implement password hashing utilities (AC: 2)
  - [x] Create or update `api/auth/auth.py`
  - [x] Install bcrypt dependency (passlib[bcrypt])
  - [x] Implement `get_password_hash(password: str) -> str` using bcrypt
  - [x] Implement `verify_password(plain_password: str, hashed_password: str) -> bool`
  - [x] Add unit tests for password hashing
- [x] Task 4: Implement JWT token generation (AC: 3, 6)
  - [x] Install python-jose dependency
  - [x] Add JWT configuration to `api/config.py` (SECRET_KEY, ALGORITHM, EXPIRE_HOURS)
  - [x] Implement `create_access_token(data: dict, expires_delta: Optional[timedelta]) -> str`
  - [x] Implement `decode_access_token(token: str) -> dict`
  - [x] Add unit tests for JWT token operations
- [x] Task 5: Create authentication routes (AC: 3, 5)
  - [x] Create `api/routes/auth.py`
  - [x] Implement `POST /auth/login` endpoint
    - [x] Accept LoginRequest
    - [x] Validate username and password
    - [x] Return LoginResponse with JWT token
    - [x] Set session cookie (optional, for web requests)
  - [x] Implement `POST /auth/logout` endpoint (optional, token-based auth doesn't require server-side logout)
  - [x] Add proper error handling (401 for invalid credentials)
- [x] Task 6: Create authentication dependency/middleware (AC: 4, 8)
  - [x] Create `api/middleware/auth.py`
  - [x] Implement `get_current_user` dependency function
    - [x] Extract token from Authorization header (Bearer token)
    - [x] Extract token from cookie (for web requests)
    - [x] Decode and validate JWT token
    - [x] Retrieve user from database
    - [x] Return User object or raise HTTPException
  - [x] Handle token expiration
  - [x] Handle invalid tokens
- [x] Task 7: Protect routes with authentication (AC: 8)
  - [x] Update health check route to remain public (no auth required)
  - [x] Add authentication dependency to protected routes (will be used in Stories 1.6, 1.7)
  - [x] Test that protected routes return 401 without token
  - [x] Test that protected routes work with valid token
- [x] Task 8: Create admin user script (AC: 7)
  - [x] Create `scripts/create_admin_user.py`
  - [x] Script accepts username and password as arguments or prompts
  - [x] Hash password using bcrypt
  - [x] Create user in database
  - [x] Handle duplicate username errors
  - [x] Add script to README documentation
- [x] Task 9: Add authentication tests (AC: 3, 4, 8)
  - [x] Create `tests/integration/test_api/test_auth.py`
  - [x] Test login with valid credentials
  - [x] Test login with invalid credentials
  - [x] Test protected route access without token (401)
  - [x] Test protected route access with valid token (200)
  - [x] Test protected route access with expired token (401)
  - [x] Test protected route access with invalid token (401)
- [x] Task 10: Update database migration if needed (AC: 1)
  - [x] Verify User model matches requirements
  - [x] Create migration if User table doesn't exist (should exist from Story 1.2)
  - [x] Test migration

## Dev Notes

### Previous Story Insights
- Story 1.2 created User database model
- Story 1.4 set up FastAPI application and configuration
- Database connection and repositories are available

### Backend Architecture
[Source: architecture/backend-architecture.md]

**Authentication Flow:**
1. User sends username/password to `/auth/login`
2. Server validates credentials
3. Server generates JWT token with user info
4. Server returns token to client
5. Client includes token in Authorization header for protected routes
6. Middleware validates token and retrieves user

**JWT Token Structure:**
- Payload: `{"sub": username, "exp": expiration_timestamp}`
- Algorithm: HS256
- Expiration: 24 hours (configurable)

### Tech Stack
[Source: architecture/tech-stack.md]

**Authentication:**
- bcrypt for password hashing
- python-jose for JWT token handling
- FastAPI Security for Bearer token extraction

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/repositories/user_repository.py` - User repository
- `api/models/schemas/user.py` - User Pydantic schemas
- `api/auth/auth.py` - Authentication utilities (password hashing, JWT)
- `api/routes/auth.py` - Authentication routes
- `api/middleware/auth.py` - Authentication middleware/dependency
- `scripts/create_admin_user.py` - Admin user creation script

### Coding Standards
[Source: architecture/coding-standards.md]

**Authentication:** All protected routes must use the `get_current_user` dependency. Never manually parse JWT tokens in route handlers.

**Environment Variables:** Access JWT_SECRET_KEY through config module, never directly.

**Error Handling:** Raise HTTPException with status 401 for authentication failures.

**Password Security:** Never store plain text passwords. Always use bcrypt hashing.

### API Specification
[Source: architecture/api-specification.md]

**Login Endpoint:**
```
POST /auth/login
Request: {
  "username": "admin",
  "password": "password"
}
Response: {
  "access_token": "eyJ...",
  "token_type": "bearer"
}
```

**Authentication:**
- Bearer token in Authorization header: `Authorization: Bearer <token>`
- Token expires after 24 hours
- All endpoints except `/health` and `/auth/login` require authentication

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test login endpoint
- Test protected route access
- Test token validation
- Test error cases (invalid credentials, expired token)

### Technical Constraints
- bcrypt for password hashing (industry standard)
- JWT tokens for stateless authentication
- Token expiration: 24 hours (configurable)
- HS256 algorithm for JWT signing
- Single admin user for MVP (can extend later)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_auth.py` and `tests/unit/test_auth/`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient for API testing
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test password hashing and verification
- Test JWT token creation and decoding
- Test login endpoint with valid/invalid credentials
- Test protected route access (with/without token)
- Test token expiration handling
- Test invalid token handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Created UserRepository following the same pattern as other repositories
- Implemented password hashing using bcrypt via passlib
- JWT token generation and validation using python-jose
- Authentication routes support both Bearer token (API) and cookie (web) authentication
- Health check endpoint remains public as required
- Admin user creation script supports interactive and command-line modes
- All tests created for password hashing, JWT tokens, and authentication endpoints
- User table already exists in migration from Story 1.2, no migration update needed

### File List
**Created:**
- `api/repositories/user_repository.py` - User repository implementation
- `api/models/schemas/user.py` - User Pydantic schemas (LoginRequest, LoginResponse, UserResponse)
- `api/auth/__init__.py` - Auth package init
- `api/auth/auth.py` - Password hashing and JWT token utilities
- `api/routes/auth.py` - Authentication routes (login, logout)
- `api/middleware/auth.py` - Authentication middleware/dependency (get_current_user)
- `scripts/create_admin_user.py` - Admin user creation script
- `tests/unit/test_repositories/test_user_repository.py` - User repository unit tests
- `tests/unit/test_auth/test_password_hashing.py` - Password hashing unit tests
- `tests/unit/test_auth/test_jwt_tokens.py` - JWT token unit tests
- `tests/integration/test_api/test_auth.py` - Authentication integration tests

**Modified:**
- `api/repositories/__init__.py` - Added UserRepository export
- `api/models/schemas/__init__.py` - Added user schema exports
- `api/main.py` - Registered auth router
- `README.md` - Added admin user creation documentation

## QA Results
_To be populated by QA Agent_

