# Story 8.1: Multi-Route Subscription Management

## Status
Draft

## Story
**As an** admin user,  
**I want** to subscribe to multiple routes in a single subscription,  
**so that** I can monitor all relevant routes for my business.

## Acceptance Criteria

1. Multi-route subscription model:
   - Customers can subscribe to multiple routes
   - Route bundle pricing options (discount for multiple routes)
   - Per-route pricing option (pay per route)
2. Subscription management:
   - Add routes to existing subscription
   - Remove routes from subscription
   - View all subscribed routes
   - Route-specific billing
3. Unified dashboard:
   - View all routes in single dashboard
   - Filter by route
   - Route comparison view
   - Aggregated statistics across routes
4. Route-specific alert preferences:
   - Configure alerts per route
   - Different email addresses per route (optional)
   - Route-specific alert frequency
5. Subscription limits:
   - Maximum routes per subscription (if applicable)
   - Upgrade path for additional routes
6. Billing integration:
   - Track usage per route
   - Invoice breakdown by route
   - Route-specific pricing display
7. Admin UI updates:
   - Multi-route subscription interface
   - Route selection and management
   - Subscription overview
8. Manual test: Create multi-route subscription, verify all routes monitored correctly

## Tasks / Subtasks

- [ ] Task 1: Create subscription model (AC: 1, 2)
  - [ ] Create Alembic migration for `subscriptions` table:
    - [ ] `id`: UUID (primary key)
    - [ ] `user_id`: UUID (foreign key to users)
    - [ ] `subscription_type`: VARCHAR(50) ('single_route', 'multi_route', 'bundle')
    - [ ] `status`: VARCHAR(20) ('active', 'cancelled', 'expired')
    - [ ] `created_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `updated_at`: TIMESTAMP WITH TIME ZONE
  - [ ] Create Alembic migration for `subscription_routes` table (many-to-many):
    - [ ] `id`: UUID (primary key)
    - [ ] `subscription_id`: UUID (foreign key to subscriptions)
    - [ ] `route_subscription_id`: UUID (foreign key to route_subscriptions)
    - [ ] `added_at`: TIMESTAMP WITH TIME ZONE
    - [ ] `is_active`: BOOLEAN
  - [ ] Create SQLAlchemy models: `api/models/db/subscription.py`, `api/models/db/subscription_route.py`
- [ ] Task 2: Create subscription repository (AC: 2)
  - [ ] Create `api/repositories/subscription_repository.py`
  - [ ] Implement CRUD operations:
    - [ ] `create(subscription_data)` - Create subscription
    - [ ] `get_by_id(subscription_id)` - Get subscription
    - [ ] `get_by_user(user_id)` - Get user's subscriptions
    - [ ] `add_route(subscription_id, route_subscription_id)` - Add route to subscription
    - [ ] `remove_route(subscription_id, route_subscription_id)` - Remove route from subscription
    - [ ] `update(subscription_id, updates)` - Update subscription
- [ ] Task 3: Create subscription API endpoints (AC: 2)
  - [ ] Create `GET /api/subscriptions` - List user's subscriptions
  - [ ] Create `POST /api/subscriptions` - Create subscription
  - [ ] Create `GET /api/subscriptions/{id}` - Get subscription details
  - [ ] Create `PUT /api/subscriptions/{id}` - Update subscription
  - [ ] Create `POST /api/subscriptions/{id}/routes` - Add route to subscription
  - [ ] Create `DELETE /api/subscriptions/{id}/routes/{route_id}` - Remove route from subscription
  - [ ] Require authentication
- [ ] Task 4: Implement pricing logic (AC: 1, 6)
  - [ ] Create `api/services/pricing.py`
  - [ ] Implement pricing calculation:
    - [ ] Single route pricing
    - [ ] Multi-route bundle pricing (discount)
    - [ ] Per-route pricing
  - [ ] Store pricing configuration (database or config)
  - [ ] Calculate subscription cost
- [ ] Task 5: Create subscription management UI (AC: 7)
  - [ ] Create `admin-ui/templates/pages/subscriptions/list.html` - Subscription list
  - [ ] Create `admin-ui/templates/pages/subscriptions/detail.html` - Subscription detail
  - [ ] Create `admin-ui/templates/pages/subscriptions/form.html` - Create/edit subscription
  - [ ] Create web routes: `GET /subscriptions`, `GET /subscriptions/{id}`, `GET /subscriptions/new`
  - [ ] Display subscription overview:
    - [ ] List of subscribed routes
    - [ ] Subscription status
    - [ ] Pricing information
    - [ ] Add/remove routes interface
- [ ] Task 6: Update unified dashboard (AC: 3)
  - [ ] Update `admin-ui/templates/pages/dashboard.html`
  - [ ] Add multi-route view:
    - [ ] Display all routes in subscription
    - [ ] Filter by route dropdown
    - [ ] Route comparison view (optional)
    - [ ] Aggregated statistics across routes
  - [ ] Add route selection UI
- [ ] Task 7: Implement route-specific alert preferences (AC: 4)
  - [ ] Update RouteSubscription model or create alert preferences:
    - [ ] `alert_email`: VARCHAR(255) (route-specific email, optional)
    - [ ] `alert_frequency`: VARCHAR(20) ('immediate', 'daily', 'weekly')
  - [ ] Update alert engine to use route-specific preferences
  - [ ] Create UI for configuring alert preferences per route
- [ ] Task 8: Implement subscription limits (AC: 5)
  - [ ] Add subscription tier configuration:
    - [ ] Maximum routes per tier
    - [ ] Upgrade path logic
  - [ ] Add validation when adding routes:
    - [ ] Check if subscription has capacity
    - [ ] Suggest upgrade if limit reached
  - [ ] Create upgrade UI
- [ ] Task 9: Implement billing tracking (AC: 6)
  - [ ] Create `api/models/db/billing_usage.py` - Usage tracking model
  - [ ] Track usage per route:
    - [ ] Changes detected per route
    - [ ] Alerts sent per route
    - [ ] API calls per route (if applicable)
  - [ ] Create billing report generation
  - [ ] Display billing information in subscription detail
- [ ] Task 10: Manual testing (AC: 8)
  - [ ] Test: Create multi-route subscription
  - [ ] Test: Add routes to subscription
  - [ ] Test: Remove routes from subscription
  - [ ] Test: Verify all routes monitored correctly
  - [ ] Test: Verify route-specific alert preferences
  - [ ] Test: Verify billing tracking

## Dev Notes

### Previous Story Insights
- Story 1.6 created RouteSubscription model (single route per subscription)
- Story 5.5 added multi-route support to admin UI
- Story 1.5 created User model
- Story 3.4 created alert engine

### RouteSubscription Model
[Source: docs/architecture/data-models.md]

**Current Model:**
- One RouteSubscription = one route
- Each has its own email and preferences

**Enhancement Needed:**
- Group RouteSubscriptions into Subscriptions
- Support multiple routes per subscription
- Route-specific preferences within subscription

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to create:
- `api/models/db/subscription.py` - Subscription model
- `api/models/db/subscription_route.py` - Subscription-route junction model
- `api/models/db/billing_usage.py` - Billing usage model
- `api/repositories/subscription_repository.py` - Subscription repository
- `api/services/pricing.py` - Pricing service
- `admin-ui/templates/pages/subscriptions/` - Subscription UI templates
- `alembic/versions/XXX_add_subscriptions.py` - Migration

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Database Access:**
- Always use Repository pattern
- Use async/await for all database operations

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Integration Tests:**
- Test subscription creation and management
- Test route addition/removal
- Test billing tracking

**Manual Testing:**
- Create multi-route subscription
- Verify all routes monitored
- Test route-specific preferences

## Testing

**Integration Tests:**
- Test subscription creation
- Test route addition/removal
- Test billing tracking

**Manual Testing:**
- Create multi-route subscription
- Add/remove routes
- Verify monitoring works
- Test route-specific preferences

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |


