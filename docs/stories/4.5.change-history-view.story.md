# Story 4.5: Change History View

## Status
Draft

## Story
**As an** admin user,  
**I want** a page showing all detected policy changes,  
**so that** I can review the history of changes and verify the system is working.

## Acceptance Criteria

1. Change history page: displays all PolicyChange records in a table
   - Columns: detected_at, route (origin → destination, visa_type), source name, change summary
   - Sortable by date (newest first by default)
   - Filterable by: route, source, date range
   - Pagination for large result sets
2. Each change is clickable (link to change detail page)
3. Change summary: shows first line of diff or "Content changed" if diff is large
4. Visual indicators: new changes highlighted
5. Date range filter: last 7 days, last 30 days, custom range
6. Export functionality (optional): export filtered results to CSV
7. Page loads efficiently even with many changes
8. Manual test: view change history, test filters

## Tasks / Subtasks

- [ ] Task 1: Create change history API endpoint (AC: 1, 7)
  - [ ] Create or update `api/routes/api.py`
  - [ ] Implement `GET /api/changes` endpoint
  - [ ] Support query parameters:
    - [ ] `route_id` - Filter by route
    - [ ] `source_id` - Filter by source
    - [ ] `start_date` - Filter by date range start
    - [ ] `end_date` - Filter by date range end
    - [ ] `page` - Pagination page number
    - [ ] `page_size` - Items per page (default 50)
  - [ ] Return paginated results
  - [ ] Include route and source information in response
  - [ ] Require authentication
- [ ] Task 2: Create change history service (AC: 1, 3)
  - [ ] Create or update `api/services/change.py`
  - [ ] Implement `get_changes(filters, page, page_size)` function
  - [ ] Query PolicyChange repository with filters
  - [ ] Join with RouteSubscription and Source for display data
  - [ ] Generate change summary:
    - [ ] Extract first line of diff
    - [ ] If diff is large, show "Content changed"
    - [ ] Limit summary length (e.g., 100 characters)
  - [ ] Return paginated results
- [ ] Task 3: Create change history template (AC: 1, 2, 3, 4)
  - [ ] Create `admin-ui/templates/pages/changes/list.html`
  - [ ] Create table displaying changes:
    - [ ] Columns: detected_at, route, source name, change summary
    - [ ] Format route as "origin → destination, visa_type"
    - [ ] Format date/time nicely
    - [ ] Truncate change summary if long
  - [ ] Make each row clickable (link to change detail)
  - [ ] Highlight new changes (e.g., changes from last 24 hours)
  - [ ] Use Tailwind CSS for styling
- [ ] Task 4: Create change history web route (AC: 1)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /changes` route
    - [ ] Accept query parameters for filtering
    - [ ] Fetch changes from API (`/api/changes`)
    - [ ] Render change history template
    - [ ] Require authentication
- [ ] Task 5: Add filtering UI (AC: 1, 5)
  - [ ] Add filter section to change history template:
    - [ ] Route filter (dropdown/select)
    - [ ] Source filter (dropdown/select)
    - [ ] Date range filter:
      - [ ] Quick options: "Last 7 days", "Last 30 days", "All"
      - [ ] Custom date range (start date, end date inputs)
  - [ ] Add "Apply Filters" button
  - [ ] Add "Clear Filters" button
  - [ ] Update URL with filter parameters (for bookmarking)
- [ ] Task 6: Add pagination UI (AC: 1)
  - [ ] Add pagination controls to change history template:
    - [ ] Previous/Next buttons
    - [ ] Page number display
    - [ ] Total pages display
    - [ ] Items per page selector (optional)
  - [ ] Update URL with page parameter
  - [ ] Handle edge cases (first page, last page)
- [ ] Task 7: Add sorting functionality (AC: 1)
  - [ ] Add sortable column headers to table
  - [ ] Default sort: detected_at descending (newest first)
  - [ ] Click column header to sort
  - [ ] Toggle ascending/descending
  - [ ] Show sort indicator
  - [ ] Update URL with sort parameters
- [ ] Task 8: Add change summary generation (AC: 3)
  - [ ] In change service, generate summary from diff:
    - [ ] Extract first line of diff (if available)
    - [ ] If diff is too large or empty, show "Content changed"
    - [ ] Truncate to reasonable length (100 characters)
  - [ ] Display summary in table
- [ ] Task 9: Add visual indicators for new changes (AC: 4)
  - [ ] In change history template, highlight changes from last 24 hours:
    - [ ] Use different background color or border
    - [ ] Add "New" badge
  - [ ] Calculate "new" based on detected_at timestamp
- [ ] Task 10: Add export functionality (optional, AC: 6)
  - [ ] Add "Export to CSV" button to change history page
  - [ ] Create `GET /api/changes/export` endpoint:
    - [ ] Accept same filters as list endpoint
    - [ ] Return CSV file
    - [ ] Include all change data
  - [ ] Generate CSV with change data
  - [ ] Trigger download in browser
- [ ] Task 11: Optimize performance (AC: 7)
  - [ ] Ensure API endpoint is efficient:
    - [ ] Use database indexes for date range queries
    - [ ] Limit query results (pagination)
    - [ ] Use efficient joins
  - [ ] Test with large datasets (1000+ changes)
  - [ ] Ensure page loads quickly (< 2 seconds)
- [ ] Task 12: Manual testing (AC: 8)
  - [ ] Test change history display
  - [ ] Test filtering by route
  - [ ] Test filtering by source
  - [ ] Test date range filtering
  - [ ] Test pagination
  - [ ] Test sorting
  - [ ] Test clicking change to view detail
  - [ ] Test export functionality (if implemented)

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation
- Story 4.2 created dashboard (similar pattern)
- Story 2.8 created PolicyChange records
- Story 1.3 created PolicyChange repository
- Story 3.1 created route-to-source mapping

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/changes             → Change history list
/changes/{id}        → Change detail (Story 4.6)
```

**API Client:**
- `api.getChanges(filters)` - Get filtered changes
- `api.getChange(id)` - Get single change (for Story 4.6)

### API Specification
[Source: architecture/api-specification.md]

**Changes Endpoint:**
```
GET /api/changes?route_id={id}&source_id={id}&start_date={date}&end_date={date}&page={n}&page_size={n}
Response: {
  "items": [PolicyChange],
  "total": int,
  "page": int,
  "page_size": int,
  "pages": int
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/change.py` - Change history service
- `api/routes/api.py` - Add changes endpoint (or create separate file)
- `api/routes/web.py` - Add changes web route
- `admin-ui/templates/pages/changes/list.html` - Change history template

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern.

**Pagination:** Use standard pagination pattern (page, page_size, total, pages).

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test change history API endpoint
- Test filtering
- Test pagination
- Test sorting

**Manual Testing:**
- Test change history display
- Test all filters
- Test pagination
- Test performance

### Technical Constraints
- Must handle large datasets efficiently
- Must support pagination
- Must support filtering
- Must be responsive

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_changes.py` and `tests/integration/test_web/test_changes.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test change history API endpoint
- Test filtering by route, source, date range
- Test pagination
- Test sorting
- Test change summary generation
- Manual test: full UI functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



