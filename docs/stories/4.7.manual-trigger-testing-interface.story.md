# Story 4.7: Manual Trigger/Testing Interface

## Status
Draft

## Story
**As an** admin user,  
**I want** a way to manually trigger source fetches,  
**so that** I can test fetchers and verify the system is working.

## Acceptance Criteria

1. Manual trigger page: list of all sources with "Fetch Now" button for each
2. Trigger action:
   - Calls API endpoint to trigger fetch for specific source
   - Shows loading indicator
   - Displays results: success/failure, change detected yes/no, error messages
3. Results display:
   - Fetch status (success/failure)
   - Change detected (yes/no)
   - If changed: link to PolicyChange record
   - Error messages if fetch failed
4. Can trigger multiple sources (one at a time or batch)
5. Trigger logs visible (last trigger timestamp, result)
6. Useful for: testing new sources, debugging fetch issues, demo purposes
7. Manual test: trigger fetch, verify results displayed

## Tasks / Subtasks

- [ ] Task 1: Create manual trigger API endpoint (AC: 2)
  - [ ] Create or update `api/routes/api.py`
  - [ ] Implement `POST /api/sources/{id}/trigger` endpoint
  - [ ] Accept source ID
  - [ ] Trigger fetch pipeline for source:
    - [ ] Call fetcher manager to fetch source
    - [ ] Run normalization
    - [ ] Run change detection
    - [ ] Store PolicyVersion if changed
    - [ ] Create PolicyChange if changed
  - [ ] Return trigger result:
    - [ ] Success/failure status
    - [ ] Change detected (yes/no)
    - [ ] PolicyChange ID (if changed)
    - [ ] Error message (if failed)
  - [ ] Require authentication
- [ ] Task 2: Create trigger service (AC: 2)
  - [ ] Create or update `api/services/trigger.py`
  - [ ] Implement `trigger_source_fetch(source_id)` function
  - [ ] Load source configuration
  - [ ] Select appropriate fetcher
  - [ ] Execute fetch pipeline (from Story 2.9)
  - [ ] Return trigger result with status
  - [ ] Handle errors gracefully
- [ ] Task 3: Create manual trigger page template (AC: 1, 3, 5)
  - [ ] Create `admin-ui/templates/pages/trigger.html`
  - [ ] Display list of all sources:
    - [ ] Source name, URL, fetch_type
    - [ ] "Fetch Now" button for each source
    - [ ] Last trigger timestamp (if available)
    - [ ] Last trigger result (if available)
  - [ ] Use Tailwind CSS for styling
  - [ ] Make page responsive
- [ ] Task 4: Create manual trigger web route (AC: 1)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /trigger` route
    - [ ] Fetch all sources from API
    - [ ] Render trigger template
    - [ ] Require authentication
- [ ] Task 5: Add trigger button functionality (AC: 2, 3)
  - [ ] Create or update `admin-ui/static/js/trigger.js`
  - [ ] Add click handler for "Fetch Now" buttons:
    - [ ] Disable button (show loading state)
    - [ ] Show loading indicator
    - [ ] Call API endpoint (`POST /api/sources/{id}/trigger`)
    - [ ] Display results:
      - [ ] Success/failure status
      - [ ] Change detected (yes/no)
      - [ ] Link to PolicyChange (if changed)
      - [ ] Error message (if failed)
    - [ ] Re-enable button
    - [ ] Update last trigger timestamp and result
  - [ ] Use API client from `api.js`
- [ ] Task 6: Add batch trigger functionality (optional, AC: 4)
  - [ ] Add "Trigger All" button to trigger page
  - [ ] Add checkbox to select multiple sources
  - [ ] Implement batch trigger:
    - [ ] Trigger sources one at a time (sequential)
    - [ ] Show progress indicator
    - [ ] Display results for each source
  - [ ] Or implement parallel triggering (with rate limiting)
- [ ] Task 7: Store trigger logs (AC: 5)
  - [ ] Option 1: Store in database (create TriggerLog table)
    - [ ] Store source_id, triggered_at, status, result
    - [ ] Query last trigger for each source
  - [ ] Option 2: Store in memory/cache (simpler for MVP)
    - [ ] Use in-memory dictionary or cache
    - [ ] Store last trigger per source
  - [ ] Display last trigger info in trigger page
- [ ] Task 8: Add result display formatting (AC: 3)
  - [ ] Format trigger results nicely:
    - [ ] Success: green badge/indicator
    - [ ] Failure: red badge/indicator
    - [ ] Change detected: show "Yes" with link to change
    - [ ] No change: show "No"
    - [ ] Error: show error message in red
  - [ ] Use Tailwind CSS for styling
- [ ] Task 9: Add error handling (AC: 2, 3)
  - [ ] Handle API errors gracefully:
    - [ ] Network errors
    - [ ] Server errors
    - [ ] Timeout errors
  - [ ] Display user-friendly error messages
  - [ ] Log errors for debugging
- [ ] Task 10: Manual testing (AC: 7)
  - [ ] Test trigger single source
  - [ ] Test trigger with source that has changes
  - [ ] Test trigger with source that has no changes
  - [ ] Test trigger with source that fails
  - [ ] Test batch trigger (if implemented)
  - [ ] Test result display
  - [ ] Test error handling

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation
- Story 2.9 created end-to-end fetch pipeline
- Story 2.1 created fetcher plugin architecture
- Story 1.7 created Source API endpoints

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Route Structure:**
```
/trigger             â†’ Manual trigger page
```

**API Client:**
- `api.triggerSource(id)` - Trigger fetch for source

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/trigger.py` - Trigger service
- `api/routes/api.py` - Add trigger endpoint
- `api/routes/web.py` - Add trigger web route
- `admin-ui/templates/pages/trigger.html` - Trigger page template
- `admin-ui/static/js/trigger.js` - Trigger functionality

### Coding Standards
[Source: architecture/coding-standards.md]

**Error Handling:** Display errors to users appropriately.

**Async/Await:** Use `async def` and `await` for all database operations and API calls.

**Logging:** Log trigger actions for debugging.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test trigger API endpoint
- Test trigger service
- Test fetch pipeline execution

**Manual Testing:**
- Test trigger functionality
- Test result display
- Test error handling

### Technical Constraints
- Must trigger actual fetch pipeline (not mock)
- Must handle long-running fetches (may take time)
- Must display results clearly
- Must handle errors gracefully

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_api/test_trigger.py` and `tests/integration/test_web/test_trigger.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test trigger API endpoint
- Test trigger service
- Test fetch pipeline execution
- Test result display
- Test error handling
- Manual test: full trigger functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



