# Story 3.4: Alert Engine - Change Detection to Email Flow

## Status
Ready for Review

## Story
**As a** developer,  
**I want** an alert engine that sends emails when policy changes are detected,  
**so that** users are proactively notified of relevant changes.

## Acceptance Criteria

1. Alert function: `send_alerts_for_change(policy_change_id)`
2. Flow:
   - Get PolicyChange record
   - Get Source from PolicyChange
   - Find all RouteSubscriptions that match this source (via mapping logic)
   - For each route subscription, send email alert
3. Email includes: route info, source info, timestamp, diff preview, link to full diff
4. Each route subscription gets one email (even if multiple sources changed)
5. If no routes match the source, log but don't send emails
6. Error handling: if email fails for one route, continue with others
7. Logging: all alert sends logged (route, email, success/failure)
8. Integration test: create change, verify emails sent to matching routes
9. Unit tests for alert logic

## Tasks / Subtasks

- [x] Task 1: Create alert engine service (AC: 1, 2)
  - [x] Create `api/services/alert_engine.py`
  - [x] Implement `send_alerts_for_change(policy_change_id: UUID) -> AlertResult` function
  - [x] Flow implementation:
    - [x] Get PolicyChange record (use PolicyChange repository)
    - [x] Get Source from PolicyChange (use Source repository)
    - [x] Find matching RouteSubscriptions (use route mapper from Story 3.1)
    - [x] For each route subscription:
      - [x] Format email content (use email template from Story 3.2)
      - [x] Send email (use email service from Story 3.3)
      - [x] Create EmailAlert record (use EmailAlert repository)
- [x] Task 2: Create AlertResult model (AC: 1)
  - [x] Create dataclass or Pydantic model:
    - [x] `policy_change_id: UUID`
    - [x] `routes_notified: int`
    - [x] `emails_sent: int`
    - [x] `emails_failed: int`
    - [x] `errors: List[str]`
- [x] Task 3: Integrate email template and sending (AC: 3)
  - [x] Use email template service to render email content
  - [x] Generate email subject line
  - [x] Generate diff preview
  - [x] Include admin UI URL for full diff link
  - [x] Send email via email service
- [x] Task 4: Handle multiple routes per source (AC: 4)
  - [x] Ensure each route subscription gets exactly one email
  - [x] Even if multiple sources changed, each route gets one email per change
  - [x] Track which routes have been notified
- [x] Task 5: Handle no matching routes (AC: 5)
  - [x] If no routes match source, log info message
  - [x] Do not send emails
  - [x] Return AlertResult with routes_notified=0
- [x] Task 6: Implement error handling (AC: 6)
  - [x] If email fails for one route, catch error and continue with others
  - [x] Log error for failed email
  - [x] Track failed emails in AlertResult
  - [x] Do not stop processing other routes on single failure
- [x] Task 7: Add comprehensive logging (AC: 7)
  - [x] Log alert engine start: "Sending alerts for policy change {policy_change_id}"
  - [x] Log for each route:
    - [x] "Sending alert to route {route_id}, email {email}"
    - [x] "Alert sent successfully to {email}" or "Alert failed for {email}: {error}"
  - [x] Log summary: "Sent {count} alerts for policy change {policy_change_id}"
  - [x] Use appropriate log levels (INFO for success, ERROR for failures)
- [x] Task 8: Create EmailAlert records (AC: 2)
  - [x] After sending email, create EmailAlert record:
    - [x] policy_change_id
    - [x] route_subscription_id
    - [x] sent_at (timestamp)
    - [x] email_provider ("resend")
    - [x] email_provider_id (message ID from Resend)
    - [x] status ("sent" or "failed")
    - [x] error_message (if failed)
  - [x] Use EmailAlert repository (from Story 1.3, may need to create)
- [x] Task 9: Create unit tests (AC: 9)
  - [x] Create `tests/unit/test_services/test_alert_engine.py`
  - [x] Test alert flow:
    - [x] Get PolicyChange
    - [x] Find matching routes
    - [x] Send emails
    - [x] Create EmailAlert records
  - [x] Test error handling:
    - [x] Email failure for one route
    - [x] Continue with other routes
  - [x] Test edge cases:
    - [x] No matching routes
    - [x] Multiple routes match
- [x] Task 10: Create integration test (AC: 8)
  - [x] Create `tests/integration/test_services/test_alert_engine.py`
  - [x] Test: create change, verify emails sent
    - [x] Create PolicyChange
    - [x] Create matching RouteSubscription
    - [x] Call `send_alerts_for_change()`
    - [x] Verify email sent (mock or real)
    - [x] Verify EmailAlert record created
  - [x] Test: multiple routes match one source
  - [x] Test: no routes match source

## Dev Notes

### Previous Story Insights
- Story 3.1 created route-to-source mapping logic
- Story 3.2 created email template system
- Story 3.3 created email sending service integration
- Story 2.8 created PolicyChange records
- Story 1.3 created repositories (may need EmailAlert repository)

### Components Architecture
[Source: architecture/components.md]

**Alert Engine:**
- Sends email alerts when policy changes are detected
- Matches policy changes to route subscriptions
- Formats email content
- Sends via Resend API
- Records EmailAlert record

**Key Interfaces:**
- `send_change_alert(policy_change_id)` - Sends alert for a specific policy change
  - Finds matching route subscriptions
  - Formats email with route, source, timestamp, diff preview
  - Sends via Resend API
  - Records EmailAlert record

### Data Models
[Source: architecture/data-models.md]

**EmailAlert Model:**
- `id`: UUID (primary key)
- `policyChangeId`: UUID (foreign key to PolicyChange)
- `routeSubscriptionId`: UUID (foreign key to RouteSubscription)
- `sentAt`: Date
- `emailProvider`: string (e.g., "resend")
- `emailProviderId`: string | null (provider's message ID)
- `status`: "sent" | "failed" | "bounced"
- `errorMessage`: string | null
- `createdAt`: Date

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/alert_engine.py` - Alert sending logic
- `api/repositories/email_alert_repository.py` - EmailAlert repository (if not created in Story 1.3)
- `tests/unit/test_services/test_alert_engine.py` - Unit tests
- `tests/integration/test_services/test_alert_engine.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Email Sending:** Always use the `AlertEngine` service for sending emails. Never call Resend API directly from route handlers or services.

**Error Handling:** Handle email sending errors gracefully, continue with other routes.

**Logging:** Use Python's `logging` module with appropriate log levels.

**Type Hints:** All Python functions must have type hints.

**Async/Await:** Use `async def` and `await` for all database operations.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test alert flow
- Test error handling
- Test edge cases

**Integration Tests:**
- Test full flow: change → alert → email sent
- Test with multiple routes

### Technical Constraints
- Each route subscription gets exactly one email per change
- Must handle email failures gracefully
- Must log all alert operations
- Must create EmailAlert records for auditability

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_alert_engine.py` and `tests/integration/test_services/test_alert_engine.py`

**Test Standards:**
- Use pytest framework
- Use async test fixtures for database operations
- Mock email service for unit tests
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- pytest-asyncio for async test support

**Specific Testing Requirements:**
- Test alert flow (get change → find routes → send emails)
- Test error handling (email failure for one route)
- Test edge cases (no matching routes, multiple routes)
- Test EmailAlert record creation
- Test integration: full flow with real/mock email service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A

### Completion Notes List
1. Created `api/models/db/email_alert.py` - EmailAlert database model with all required fields
2. Created `api/repositories/email_alert_repository.py` - EmailAlertRepository with CRUD operations
3. Added EmailAlert relationships to PolicyChange and RouteSubscription models
4. Created `api/services/alert_engine.py` with AlertEngine class:
   - `send_alerts_for_change()` - Main function to send alerts for a policy change
   - Complete flow: Get PolicyChange → Get Source → Find matching routes → Send emails → Create EmailAlert records
5. Created AlertResult dataclass to track alert sending results (routes_notified, emails_sent, emails_failed, errors)
6. Integrated with existing services:
   - RouteMapper (Story 3.1) - to find matching routes
   - EmailTemplateService (Story 3.2) - to render email content
   - EmailService (Story 3.3) - to send emails
7. Error handling:
   - If email fails for one route, continues with other routes
   - Creates EmailAlert record even for failed attempts
   - Tracks all errors in AlertResult
8. Comprehensive logging:
   - Logs alert engine start
   - Logs for each route (sending, success/failure)
   - Logs summary with counts
   - Appropriate log levels (INFO/ERROR)
9. Handles edge cases:
   - No matching routes (logs info, returns early)
   - Multiple routes per source (each gets one email)
   - Email failures (continues processing, tracks errors)
10. Created comprehensive unit tests in `tests/unit/test_services/test_alert_engine.py`:
    - Successful alert sending
    - Multiple routes
    - Email failures
    - Exception handling
    - Edge cases (no routes, policy change not found)
11. Created integration tests in `tests/integration/test_services/test_alert_engine.py`:
    - Full flow with database records
    - Multiple routes matching one source
    - No routes matching source
    - Email failure handling
12. All code follows coding standards: type hints, async/await, error handling, logging, repository pattern

### File List
- `api/models/db/email_alert.py` (new)
- `api/models/db/__init__.py` (modified - added EmailAlert import)
- `api/models/db/policy_change.py` (modified - added email_alerts relationship)
- `api/models/db/route_subscription.py` (modified - added email_alerts relationship)
- `api/repositories/email_alert_repository.py` (new)
- `api/repositories/__init__.py` (modified - added EmailAlertRepository import)
- `api/services/alert_engine.py` (new)
- `tests/unit/test_services/test_alert_engine.py` (new)
- `tests/integration/test_services/test_alert_engine.py` (new)

## QA Results
_To be populated by QA Agent_

