# Story 4.15: AI Summary for Route Changes

## Status
Draft

## Story
**As a** user,  
**I want** an AI-generated summary explaining what changed in a route,  
**so that** I can quickly understand policy updates without reading the full diff.

## Acceptance Criteria

1. Calls `POST /api/routes/{route_id}/summary` endpoint (NOTE: May not exist yet, needs backend implementation)
2. Shows loading state during AI summary generation
3. Supports partial/streaming results (if backend supports)
4. Summary must reflect actual diffs, not static text
5. Displays summary in readable format
6. Error state if API call fails or AI service unavailable
7. Can regenerate summary
8. Summary includes key changes, impact, and context

## Tasks / Subtasks

- [x] Task 1: Verify backend API endpoint exists
  - [x] Check if `POST /api/routes/{route_id}/summary` exists
  - [x] If not, document as dependency/blocker
  - [x] Check if streaming is supported
- [x] Task 2: Create AI summary service (AC: 1)
  - [x] Add `generateRouteSummary(routeId)` to `src/services/ai.js` or `src/services/routes.js`
  - [x] Call `POST /api/routes/{route_id}/summary`
  - [x] Handle streaming response if supported
  - [x] Handle error responses
- [x] Task 3: Create AI summary component (AC: 4, 5)
  - [x] Create `src/components/ai/SummaryView.js`
  - [x] Display summary text
  - [x] Format with clear sections (Key Changes, Impact, Context)
  - [x] Apply design system styling
- [x] Task 4: Integrate with route changes view (AC: 2, 3, 6, 7)
  - [x] Add "Generate AI Summary" button to route changes page
  - [x] Show loading state during generation
  - [x] Display summary when ready
  - [x] Handle streaming updates (if supported)
  - [x] Show error message if generation fails
  - [x] Add "Regenerate" button
- [x] Task 5: Create unit tests (AC: All)
  - [x] Test summary generation
  - [x] Test loading state
  - [x] Test error handling
  - [x] Test streaming (if supported)
- [ ] Task 6: Manual testing (AC: All)
  - [ ] Test generating summary
  - [ ] Test loading state
  - [ ] Test error handling
  - [ ] Test summary quality (reflects actual changes)

## Dev Notes

### API Specifications
[Source: architecture/api-specification.md]

**NOTE:** This endpoint may not exist yet. This story depends on backend implementation.

**Expected Endpoint:**
- `POST /api/routes/{route_id}/summary` - Generate AI summary for route changes
- Request body: `{}` (may include options like `model`, `style`)
- Response: `{summary: string, generated_at: timestamp}` or streaming response
- May return 501 Not Implemented if AI service not available

### Technical Constraints
- **BLOCKER:** Backend endpoint must be implemented first
- Must handle AI service unavailability gracefully
- Must show that summary is AI-generated (disclaimer)
- Must reflect actual diffs, not generic text

### Dependencies
- Backend AI summary endpoint implementation
- AI service integration (OpenRouter or similar)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/components/ai/SummaryView.test.js`

**Note:** Tests may be limited until backend endpoint is available.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes

**Frontend Implementation Complete:**
- Created AI summary service (`frontend/src/services/ai.ts`) with error handling for 501 Not Implemented, 404 Not Found, and 401 Unauthorized
- Created SummaryView component (`frontend/src/components/ai/SummaryView.tsx`) that parses and displays summary with Key Changes, Impact, and Context sections
- Integrated AI summary into route changes page (`frontend/src/pages/routes/Changes.tsx`) with:
  - "Generate AI Summary" button
  - Loading state during generation
  - Error handling with user-friendly messages
  - Regenerate functionality
  - AI disclaimer displayed
- Created comprehensive unit tests:
  - `frontend/src/__tests__/services/ai.test.ts` - 6 tests covering success and error cases
  - `frontend/src/__tests__/components/ai/SummaryView.test.tsx` - 11 tests covering component rendering and parsing
- All tests passing (17/17)

**BLOCKER - Backend Endpoint Missing:**
- Verified that `POST /api/routes/{route_id}/summary` endpoint does NOT exist in `api/routes/api.py`
- Frontend implementation handles this gracefully by:
  - Catching 501 Not Implemented errors
  - Displaying user-friendly error message: "AI summary service is not available. The backend endpoint may not be implemented yet."
- Frontend is ready and will work once backend endpoint is implemented

**Streaming Support:**
- Not implemented in frontend (backend endpoint doesn't exist to test)
- Frontend service structure supports adding streaming later if backend provides it

**File List:**
- Created: `frontend/src/services/ai.ts`
- Created: `frontend/src/components/ai/SummaryView.tsx`
- Modified: `frontend/src/pages/routes/Changes.tsx`
- Created: `frontend/src/__tests__/services/ai.test.ts`
- Created: `frontend/src/__tests__/components/ai/SummaryView.test.tsx`

### Debug Log References
None - implementation completed without issues

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-27 | 1.1 | Frontend implementation completed | Dev Agent |

## QA Results
_To be populated by QA Agent_

