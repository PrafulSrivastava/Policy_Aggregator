# Story 4.2: Dashboard/Home Screen

## Status
Draft

## Story
**As an** admin user,  
**I want** a dashboard showing system overview and recent activity,  
**so that** I can quickly see system health and recent changes.

## Acceptance Criteria

1. Dashboard displays:
   - Total active route subscriptions
   - Total active sources
   - Changes detected in last 7 days
   - Recent changes list (last 5-10, with route, source, timestamp)
   - System health: last successful fetch timestamp per source
2. Quick stats cards/sections
3. Recent changes are clickable (link to change detail page)
4. Sources with recent errors highlighted
5. Sources not checked recently (beyond expected frequency) highlighted
6. Page loads quickly (< 2 seconds)
7. Data fetched via API calls (not direct database access from UI)
8. Manual test: verify all data displays correctly

## Tasks / Subtasks

- [ ] Task 1: Create dashboard API endpoint (AC: 1, 7)
  - [ ] Create or update `api/routes/api.py`
  - [ ] Implement `GET /api/dashboard` endpoint
  - [ ] Fetch dashboard statistics:
    - [ ] Total active route subscriptions (use RouteSubscription repository)
    - [ ] Total active sources (use Source repository)
    - [ ] Changes detected in last 7 days (use PolicyChange repository)
    - [ ] Recent changes (last 5-10, use PolicyChange repository)
    - [ ] System health per source (last successful fetch timestamp)
  - [ ] Return dashboard data as JSON
  - [ ] Require authentication
- [ ] Task 2: Create dashboard service (AC: 1)
  - [ ] Create `api/services/dashboard.py`
  - [ ] Implement `get_dashboard_stats() -> DashboardStats` function
  - [ ] Aggregate statistics from repositories
  - [ ] Calculate changes in last 7 days
  - [ ] Get recent changes with route and source information
  - [ ] Get source health information
- [ ] Task 3: Create dashboard template (AC: 1, 2, 3, 4, 5)
  - [ ] Create `admin-ui/templates/pages/dashboard.html`
  - [ ] Extend base template
  - [ ] Create stats cards section:
    - [ ] Total active routes card
    - [ ] Total active sources card
    - [ ] Changes in last 7 days card
  - [ ] Create recent changes list:
    - [ ] Table or list showing last 5-10 changes
    - [ ] Columns: route, source, timestamp
    - [ ] Each change is clickable (link to change detail)
  - [ ] Create system health section:
    - [ ] List of sources with last checked timestamp
    - [ ] Highlight sources with errors (red)
    - [ ] Highlight sources not checked recently (yellow)
  - [ ] Use Tailwind CSS for styling
- [ ] Task 4: Create dashboard web route (AC: 1, 7)
  - [ ] Create or update `api/routes/web.py`
  - [ ] Implement `GET /` route (dashboard)
    - [ ] Fetch dashboard data via API or service
    - [ ] Render dashboard template with data
    - [ ] Require authentication
- [ ] Task 5: Add highlighting for error sources (AC: 4)
  - [ ] In dashboard template, highlight sources with recent errors
    - [ ] Use red background or border
    - [ ] Show error indicator icon
  - [ ] Determine "recent errors" (e.g., errors in last 24 hours or 3+ consecutive failures)
- [ ] Task 6: Add highlighting for stale sources (AC: 5)
  - [ ] In dashboard template, highlight sources not checked recently
    - [ ] Use yellow background or border
    - [ ] Show warning indicator
  - [ ] Determine "not checked recently" (e.g., beyond check_frequency + 1 day)
- [ ] Task 7: Optimize dashboard performance (AC: 6)
  - [ ] Ensure API endpoint is fast:
    - [ ] Use efficient database queries
    - [ ] Limit recent changes query (LIMIT 10)
    - [ ] Use indexes for date range queries
  - [ ] Cache dashboard stats if needed (optional, for MVP can skip)
  - [ ] Test page load time (< 2 seconds)
- [ ] Task 8: Add JavaScript for interactivity (AC: 3)
  - [ ] Create or update `admin-ui/static/js/main.js`
  - [ ] Add click handlers for recent changes (navigate to detail page)
  - [ ] Add any interactive elements (if needed)
- [ ] Task 9: Manual testing (AC: 8)
  - [ ] Test dashboard displays all statistics correctly
  - [ ] Test recent changes list
  - [ ] Test source health display
  - [ ] Test error highlighting
  - [ ] Test stale source highlighting
  - [ ] Test page load performance
  - [ ] Test clickable links to change detail

## Dev Notes

### Previous Story Insights
- Story 4.1 created admin UI foundation and authentication
- Story 1.3 created repositories for all entities
- Story 1.6 and 1.7 created API endpoints
- Story 2.8 created PolicyChange records
- Story 3.7 created error tracking (for error highlighting)

### Components Architecture
[Source: architecture/components.md]

**Admin UI Component:**
- Renders Jinja2 templates with data from API endpoints
- Displays dashboard statistics, route lists, source configurations, and change history

**Dashboard Service:**
- Aggregates statistics for dashboard display
- Provides system health information

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Dashboard Route:**
- `GET /` - Dashboard page
- Renders `pages/dashboard.html` template
- Fetches data from `/api/dashboard` endpoint

### API Specification
[Source: architecture/api-specification.md]

**Dashboard Endpoint:**
```
GET /api/dashboard
Response: {
  "totalRoutes": int,
  "totalSources": int,
  "activeSources": int,
  "changesLast7Days": int,
  "changesLast30Days": int,
  "recentChanges": [PolicyChange],
  "sourceHealth": [
    {
      "sourceId": UUID,
      "sourceName": string,
      "lastCheckedAt": datetime | null,
      "status": "healthy" | "stale" | "error"
    }
  ]
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/dashboard.py` - Dashboard statistics service
- `api/routes/api.py` - Add dashboard endpoint (or create separate file)
- `api/routes/web.py` - Add dashboard web route
- `admin-ui/templates/pages/dashboard.html` - Dashboard template
- `admin-ui/static/js/main.js` - Add dashboard interactivity

### Coding Standards
[Source: architecture/coding-standards.md]

**Database Access:** Always use the Repository pattern. Never write raw SQL queries.

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency.

**Type Hints:** All Python functions must have type hints.

**Async/Await:** Use `async def` and `await` for all database operations.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test dashboard API endpoint
- Test dashboard web route
- Test data aggregation

**Manual Testing:**
- Test dashboard display
- Test performance
- Test highlighting

### Technical Constraints
- Dashboard must load quickly (< 2 seconds)
- Data must come from API (not direct database access)
- Must highlight error and stale sources
- Must be responsive (desktop and tablet)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_web/test_dashboard.py` and `tests/integration/test_api/test_dashboard.py`

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient

**Specific Testing Requirements:**
- Test dashboard API endpoint returns correct data
- Test dashboard web route renders template
- Test statistics aggregation
- Test source health calculation
- Test error/stale highlighting logic
- Manual test: verify display and performance

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_



