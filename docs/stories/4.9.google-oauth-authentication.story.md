# Story 4.9: Google OAuth Authentication

## Status
Draft

## Story
**As an** admin user,  
**I want** to authenticate using my Google account,  
**so that** I can log in without managing a separate password and use a more secure authentication method.

## Acceptance Criteria

1. Google OAuth 2.0 integration implemented
2. "Sign in with Google" button on login page
3. OAuth flow: redirect to Google, user authorizes, redirect back with code
4. Exchange authorization code for Google user info
5. Create or link user account based on Google email
6. Generate JWT token after successful OAuth authentication (same as password auth)
7. User can choose between password login or Google OAuth on login page
8. Existing password authentication continues to work
9. Google OAuth credentials stored in environment variables
10. Error handling for OAuth failures (user denies access, network errors, etc.)
11. Unit tests for OAuth flow
12. Manual test: complete OAuth login flow

## Tasks / Subtasks

- [x] Task 1: Install OAuth dependencies (AC: 1)
  - [x] Install `authlib` or `python-social-auth` library for OAuth
  - [x] Add dependency to `requirements.txt`
  - [x] Verify compatibility with FastAPI and async support
- [x] Task 2: Configure Google OAuth credentials (AC: 9)
  - [x] Create Google Cloud Console project (or document setup steps)
  - [x] Create OAuth 2.0 credentials (Client ID and Client Secret)
  - [x] Configure authorized redirect URIs (e.g., `https://yourdomain.com/auth/google/callback`)
  - [x] Add environment variables to `.env.example`:
    - [x] `GOOGLE_OAUTH_CLIENT_ID`
    - [x] `GOOGLE_OAUTH_CLIENT_SECRET`
    - [x] `GOOGLE_OAUTH_REDIRECT_URI`
  - [x] Update `api/config.py` to load Google OAuth config
- [x] Task 3: Create OAuth service (AC: 1, 4, 5)
  - [x] Create `api/services/oauth_service.py`
  - [x] Implement `get_google_authorization_url(state: str) -> str`:
    - [x] Generate OAuth authorization URL with client ID, redirect URI, scope, state
    - [x] Include state parameter for CSRF protection
  - [x] Implement `exchange_google_code(code: str, state: str) -> dict`:
    - [x] Verify state parameter matches (CSRF protection)
    - [x] Exchange authorization code for access token
    - [x] Fetch user info from Google API
    - [x] Return user info (email, name, etc.)
  - [x] Implement `get_or_create_user_from_google(google_user_info: dict) -> User`:
    - [x] Check if user exists by email
    - [x] If exists, return existing user
    - [x] If not exists, create new user with Google email as username
    - [x] Store Google user ID in user metadata (optional, for future linking)
- [x] Task 4: Create OAuth routes (AC: 1, 3, 6)
  - [x] Update `api/routes/auth.py`
  - [x] Implement `GET /auth/google` route:
    - [x] Generate state token (store in session or signed cookie)
    - [x] Redirect to Google authorization URL
  - [x] Implement `GET /auth/google/callback` route:
    - [x] Extract authorization code and state from query parameters
    - [x] Verify state token
    - [x] Exchange code for user info via OAuth service
    - [x] Get or create user from Google info
    - [x] Generate JWT token (same as password login)
    - [x] Set JWT token in cookie (for web requests)
    - [x] Redirect to dashboard on success
    - [x] Handle errors (redirect to login with error message)
- [x] Task 5: Update login page UI (AC: 2, 7)
  - [x] Update `admin-ui/templates/pages/login.html`
  - [x] Add "Sign in with Google" button
  - [x] Style button with Google branding (optional)
  - [x] Link button to `/auth/google` route
  - [x] Keep existing username/password form
  - [x] Add visual separator between OAuth and password login
  - [x] Make layout responsive
- [x] Task 6: Update User model for OAuth support (AC: 5)
  - [x] Review `api/models/db/user.py`
  - [x] Add optional fields if needed:
    - [x] `google_id` (VARCHAR, nullable) - Google user ID
    - [x] `auth_provider` (VARCHAR, default 'password') - 'password' or 'google'
  - [x] Create database migration for new fields
  - [x] Update User repository to handle OAuth fields
- [x] Task 7: Update authentication middleware (AC: 6, 8)
  - [x] Review `api/middleware/auth.py`
  - [x] Ensure `get_current_user` works with OAuth-generated JWT tokens
  - [x] Verify JWT token structure is consistent (password vs OAuth)
  - [x] No changes needed if JWT format is the same
- [x] Task 8: Add state token management (AC: 3)
  - [x] Implement state token generation and validation
  - [x] Options:
    - [x] Store state in signed cookie (recommended for stateless)
    - [x] Store state in server-side session (requires session storage)
  - [x] Generate random state token for each OAuth request
  - [x] Verify state token on callback to prevent CSRF
- [x] Task 9: Add error handling (AC: 10)
  - [x] Handle OAuth errors in callback route:
    - [x] User denies access (error parameter in callback)
    - [x] Invalid state token
    - [x] Network errors when exchanging code
    - [x] Invalid authorization code
  - [x] Display user-friendly error messages
  - [x] Log OAuth errors for debugging
  - [x] Redirect to login page with error message
- [x] Task 10: Update environment configuration (AC: 9)
  - [x] Update `.env.example` with Google OAuth variables
  - [x] Document Google Cloud Console setup steps in README
  - [x] Add OAuth redirect URI to deployment documentation
- [x] Task 11: Create unit tests (AC: 11)
  - [x] Create `tests/unit/test_oauth/test_oauth_service.py`
  - [x] Test `get_google_authorization_url`:
    - [x] Returns valid Google OAuth URL
    - [x] Includes correct parameters (client_id, redirect_uri, scope, state)
  - [x] Test `exchange_google_code`:
    - [x] Valid code exchange returns user info
    - [x] Invalid code raises exception
    - [x] State verification works
  - [x] Test `get_or_create_user_from_google`:
    - [x] Creates new user if email doesn't exist
    - [x] Returns existing user if email exists
    - [x] Handles duplicate email gracefully
- [x] Task 12: Create integration tests (AC: 11)
  - [x] Create `tests/integration/test_api/test_oauth.py`
  - [x] Test OAuth flow (mocked Google API):
    - [x] GET /auth/google redirects to Google
    - [x] GET /auth/google/callback with valid code creates/authenticates user
    - [x] GET /auth/google/callback with invalid code returns error
    - [x] GET /auth/google/callback with denied access returns error
  - [x] Test JWT token generation after OAuth login
  - [x] Test protected routes work with OAuth-generated tokens
- [ ] Task 13: Manual testing (AC: 12)
  - [ ] Test complete OAuth flow in browser:
    - [ ] Click "Sign in with Google" button
    - [ ] Redirect to Google login
    - [ ] Authorize application
    - [ ] Redirect back to application
    - [ ] User is logged in and redirected to dashboard
  - [ ] Test error cases:
    - [ ] User denies access
    - [ ] Network error during OAuth
  - [ ] Test password login still works
  - [ ] Test user can switch between OAuth and password login

## Dev Notes

### Previous Story Insights
- Story 1.5 created password-based authentication system with JWT tokens
- Story 4.1 created login page UI and web authentication routes
- Authentication uses JWT tokens with 24-hour expiration
- JWT tokens stored in HTTP-only cookies for web requests
- User model exists with username, hashed_password, created_at fields
- `get_current_user` dependency validates JWT tokens and retrieves users

### Backend Architecture
[Source: architecture/backend-architecture.md]

**Authentication Flow (Current):**
1. User sends username/password to `/auth/login`
2. Server validates credentials
3. Server generates JWT token with user info
4. Server returns token to client
5. Client includes token in Authorization header for protected routes
6. Middleware validates token and retrieves user

**JWT Token Structure:**
- Payload: `{"sub": username, "exp": expiration_timestamp}`
- Algorithm: HS256
- Expiration: 24 hours (configurable)

**OAuth Flow (To Implement):**
1. User clicks "Sign in with Google" button
2. Redirect to `/auth/google` route
3. Server generates state token and redirects to Google OAuth URL
4. User authorizes on Google
5. Google redirects to `/auth/google/callback` with authorization code
6. Server exchanges code for user info
7. Server gets or creates user based on Google email
8. Server generates JWT token (same format as password auth)
9. Server sets JWT token in cookie and redirects to dashboard

### Tech Stack
[Source: architecture/tech-stack.md]

**Authentication (Current):**
- bcrypt for password hashing
- python-jose for JWT token handling
- FastAPI Security for Bearer token extraction

**OAuth Library Options:**
- `authlib` - Modern OAuth library with async support, recommended for FastAPI
- `python-social-auth` - Alternative, but less modern
- Recommendation: Use `authlib` for OAuth 2.0 support

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/services/oauth_service.py` - OAuth service for Google integration
- `api/routes/auth.py` - Add OAuth routes (update existing file)
- `api/models/db/user.py` - Add OAuth fields (update existing file)
- `alembic/versions/XXX_add_oauth_fields.py` - Database migration for OAuth fields
- `admin-ui/templates/pages/login.html` - Add Google OAuth button (update existing file)
- `tests/unit/test_oauth/test_oauth_service.py` - Unit tests for OAuth service
- `tests/integration/test_api/test_oauth.py` - Integration tests for OAuth flow

### Coding Standards
[Source: architecture/coding-standards.md]

**Authentication:** All protected routes must use the `get_current_user` dependency. Never manually parse JWT tokens in route handlers.

**Environment Variables:** Access OAuth credentials through config module, never directly.

**Error Handling:** Raise HTTPException with status 401 for authentication failures. Handle OAuth errors gracefully with user-friendly messages.

**Security:** 
- Always use state parameter for CSRF protection in OAuth flow
- Store OAuth credentials in environment variables
- Never log OAuth tokens or user credentials

### API Specification
[Source: architecture/api-specification.md]

**OAuth Endpoints:**

```
GET /auth/google
- Redirects to Google OAuth authorization URL
- Generates state token for CSRF protection
- No request body required

GET /auth/google/callback?code={code}&state={state}
- Handles Google OAuth callback
- Exchanges authorization code for user info
- Creates/authenticates user
- Sets JWT token in cookie
- Redirects to dashboard on success
- Redirects to login with error on failure
```

**JWT Token Format (Same as Password Auth):**
- Payload: `{"sub": username, "exp": expiration_timestamp}`
- Algorithm: HS256
- Expiration: 24 hours

### Security Considerations
[Source: architecture/security-and-performance.md]

**OAuth Security:**
- State parameter must be used for CSRF protection
- Verify state token on callback matches the one sent
- Store OAuth credentials securely in environment variables
- Use HTTPS in production (Railway automatic)
- Validate Google user info before creating/authenticating user
- Handle OAuth errors gracefully without exposing system details

**Token Storage:**
- JWT tokens in HTTP-only cookies (same as password auth)
- Cookie settings: HttpOnly, Secure, SameSite=Strict
- Token expiration: 24 hours (same as password auth)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test OAuth service functions (authorization URL generation, code exchange, user creation)
- Mock Google OAuth API responses
- Test error handling (invalid codes, network errors)

**Integration Tests:**
- Test complete OAuth flow with mocked Google API
- Test JWT token generation after OAuth login
- Test protected routes work with OAuth-generated tokens
- Use FastAPI TestClient for route testing

**Manual Testing:**
- Test complete OAuth flow in browser
- Test error cases (user denies access, network errors)
- Verify password login still works
- Verify user can switch between authentication methods

### Technical Constraints
- Must use OAuth 2.0 standard (Google's supported protocol)
- Must maintain compatibility with existing password authentication
- JWT tokens must use same format as password auth (for middleware compatibility)
- OAuth credentials must be stored in environment variables
- State parameter required for CSRF protection
- Must handle OAuth errors gracefully
- Must work with existing `get_current_user` dependency

### Google OAuth Setup Requirements
- Google Cloud Console project required
- OAuth 2.0 Client ID and Client Secret required
- Authorized redirect URI must be configured (e.g., `https://yourdomain.com/auth/google/callback`)
- OAuth consent screen must be configured
- Scopes required: `openid`, `email`, `profile` (for user info)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** 
- `tests/unit/test_oauth/test_oauth_service.py` - Unit tests
- `tests/integration/test_api/test_oauth.py` - Integration tests

**Test Standards:**
- Use pytest framework
- Use FastAPI TestClient for API testing
- Mock Google OAuth API for unit tests
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- FastAPI TestClient
- `responses` or `httpx` for mocking HTTP requests to Google API

**Specific Testing Requirements:**
- Test Google authorization URL generation
- Test authorization code exchange
- Test user creation/linking from Google info
- Test OAuth callback route with valid/invalid codes
- Test state token verification (CSRF protection)
- Test error handling (user denies access, network errors)
- Test JWT token generation after OAuth login
- Test protected routes work with OAuth-generated tokens
- Manual test: complete OAuth flow in browser

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes

**Backend Implementation Complete:**
- Installed `authlib>=1.2.0` for OAuth 2.0 support
- Created OAuth service (`api/services/oauth_service.py`) with:
  - State token generation for CSRF protection
  - Google authorization URL generation
  - Authorization code exchange with Google API
  - User creation/linking from Google user info
- Added OAuth routes to `api/routes/auth.py`:
  - `GET /auth/google` - Initiates OAuth flow, redirects to Google
  - `GET /auth/google/callback` - Handles OAuth callback, creates/authenticates user
- Updated User model (`api/models/db/user.py`) with:
  - `google_id` field (nullable, unique) for Google user ID
  - `auth_provider` field (default 'password') to track auth method
  - Made `hashed_password` nullable for OAuth-only users
- Created database migration (`alembic/versions/003_add_oauth_fields.py`)
- Updated User repository with `get_by_google_id()` method
- Updated login routes to handle OAuth-only users (no password)
- Updated login page UI (`admin-ui/templates/pages/login.html`) with:
  - "Sign in with Google" button with Google branding
  - Visual separator between OAuth and password login
  - Conditional display based on OAuth configuration
- Implemented state token management using signed JWT cookies for CSRF protection
- Added comprehensive error handling for OAuth failures
- Updated `api/config.py` with Google OAuth environment variables
- Updated README.md with Google OAuth setup instructions

**Testing:**
- Created unit tests (`tests/unit/test_oauth/test_oauth_service.py`):
  - State token generation
  - Authorization URL generation
  - Code exchange (success and error cases)
  - User creation/linking from Google info
- Created integration tests (`tests/integration/test_api/test_oauth.py`):
  - OAuth flow endpoints
  - JWT token generation after OAuth login
  - Protected routes with OAuth tokens
  - Error handling scenarios

**Security:**
- State parameter used for CSRF protection (stored in signed JWT cookie)
- OAuth credentials stored in environment variables
- JWT tokens use same format as password auth (compatible with existing middleware)
- OAuth errors handled gracefully without exposing system details

**Configuration:**
- OAuth is optional - login page shows Google button only if credentials are configured
- Existing password authentication continues to work
- Users can switch between OAuth and password login

**Manual Testing:**
- Pending: Requires Google Cloud Console setup and OAuth credentials
- Frontend ready and will work once OAuth credentials are configured

### Debug Log References
None - implementation completed without issues

### File List
- Modified: `requirements.txt` - Added authlib dependency
- Modified: `api/config.py` - Added Google OAuth configuration
- Created: `api/services/oauth_service.py` - OAuth service implementation
- Modified: `api/routes/auth.py` - Added OAuth routes
- Modified: `api/routes/web.py` - Updated login page route to handle OAuth errors
- Modified: `api/models/db/user.py` - Added OAuth fields
- Created: `alembic/versions/003_add_oauth_fields.py` - Database migration
- Modified: `api/repositories/user_repository.py` - Added get_by_google_id method
- Modified: `admin-ui/templates/pages/login.html` - Added Google OAuth button
- Modified: `README.md` - Added Google OAuth setup instructions
- Created: `tests/unit/test_oauth/test_oauth_service.py` - Unit tests
- Created: `tests/unit/test_oauth/__init__.py` - Test package init
- Created: `tests/integration/test_api/test_oauth.py` - Integration tests

## QA Results
_To be populated by QA Agent_

