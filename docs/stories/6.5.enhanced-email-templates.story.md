# Story 6.5: Enhanced Email Templates

## Status
Draft

## Story
**As an** admin user,  
**I want** improved email alert formatting based on user feedback,  
**so that** alerts are more readable and actionable.

## Acceptance Criteria

1. Enhanced email template design:
   - Better typography and spacing
   - Improved color scheme (professional, readable)
   - Better mobile email client compatibility
   - Clearer visual hierarchy
2. Improved diff preview in emails:
   - Better formatting of diff text
   - Truncation with "View Full Diff" link for long diffs
   - Line numbers if helpful
   - Context preserved
3. More actionable call-to-actions:
   - Prominent "View Full Diff" button
   - "Forward to Team" button (from Story 6.2)
   - "View in Dashboard" link
4. Email structure improvements:
   - Clear subject line format
   - Route and source prominently displayed
   - Timestamp clearly visible
   - Source attribution emphasized
5. Email personalization:
   - Greeting with organization/route name
   - Route-specific content
6. Email testing:
   - Test across email clients (Gmail, Outlook, Apple Mail)
   - Test on mobile devices
   - Verify HTML and plain text versions
7. Template versioning:
   - Ability to update templates without code changes
   - A/B testing capability (optional, future)
8. User feedback integration:
   - Collect feedback on email format (optional survey link)
   - Iterate based on feedback
9. Manual test: Receive email alert, verify formatting and links work correctly

## Tasks / Subtasks

- [ ] Task 1: Enhance email template design (AC: 1)
  - [ ] Update `admin-ui/templates/emails/change_alert.html`
  - [ ] Improve typography:
    - [ ] Use web-safe fonts (Arial, Helvetica, sans-serif)
    - [ ] Increase font sizes for readability
    - [ ] Improve line spacing
    - [ ] Better heading hierarchy
  - [ ] Improve color scheme:
    - [ ] Professional color palette
    - [ ] High contrast for readability
    - [ ] Accessible colors (WCAG AA compliance)
  - [ ] Improve mobile compatibility:
    - [ ] Use responsive email design techniques
    - [ ] Test on mobile email clients
    - [ ] Use media queries for mobile styling
    - [ ] Ensure buttons are touch-friendly
  - [ ] Improve visual hierarchy:
    - [ ] Clear section separation
    - [ ] Prominent headings
    - [ ] Visual emphasis on important information
- [ ] Task 2: Improve diff preview formatting (AC: 2)
  - [ ] Update diff preview section in email template
  - [ ] Better formatting of diff text:
    - [ ] Use monospace font for diff content
    - [ ] Add line numbers (if helpful)
    - [ ] Preserve context lines
    - [ ] Highlight additions and deletions (if possible in email)
  - [ ] Implement truncation:
    - [ ] Show first N lines or characters
    - [ ] Add "..." indicator when truncated
    - [ ] Link to "View Full Diff" for complete diff
  - [ ] Ensure diff is readable in email format
- [ ] Task 3: Add actionable call-to-actions (AC: 3)
  - [ ] Update email template with prominent buttons:
    - [ ] "View Full Diff" button (primary CTA)
    - [ ] "Forward to Team" button (from Story 6.2)
    - [ ] "View in Dashboard" link (secondary)
  - [ ] Style buttons for email clients:
    - [ ] Use table-based button design (email-safe)
    - [ ] Large, touch-friendly buttons
    - [ ] Clear button text
  - [ ] Ensure buttons work in all email clients
- [ ] Task 4: Improve email structure (AC: 4)
  - [ ] Update email template structure:
    - [ ] Clear header section with route and source
    - [ ] Prominent route display (origin → destination, visa_type)
    - [ ] Prominent source name and URL
    - [ ] Clearly visible timestamp
    - [ ] Emphasized source attribution
  - [ ] Update subject line format:
    - [ ] Consistent format: "Policy Change: {route} - {source}"
    - [ ] Clear and descriptive
  - [ ] Improve information hierarchy
- [ ] Task 5: Add email personalization (AC: 5)
  - [ ] Update email template to include:
    - [ ] Greeting with route name or organization
    - [ ] Route-specific content
    - [ ] Personalized messaging (if user data available)
  - [ ] Use Jinja2 template variables for personalization
- [ ] Task 6: Test email across clients (AC: 6)
  - [ ] Test in Gmail (web and mobile)
  - [ ] Test in Outlook (desktop and web)
  - [ ] Test in Apple Mail (desktop and mobile)
  - [ ] Test in other common clients (Yahoo, etc.)
  - [ ] Verify HTML version renders correctly
  - [ ] Verify plain text version is readable
  - [ ] Test on mobile devices (iOS and Android)
  - [ ] Document any client-specific issues
- [ ] Task 7: Implement template versioning (AC: 7)
  - [ ] Add version tracking to email templates:
    - [ ] Template version number in template file
    - [ ] Version in email metadata (optional)
  - [ ] Design for A/B testing (optional, future):
    - [ ] Support multiple template versions
    - [ ] Track which version sent to which user
  - [ ] Document template update process
- [ ] Task 8: Add user feedback mechanism (AC: 8)
  - [ ] Add optional survey link to email template:
    - [ ] "How helpful was this email?" link
    - [ ] Link to feedback form or survey
  - [ ] Create feedback collection mechanism:
    - [ ] Simple feedback form (optional)
    - [ ] Track feedback for analysis
  - [ ] Document feedback collection process
- [ ] Task 9: Update plain text version (AC: 6)
  - [ ] Update `admin-ui/templates/emails/change_alert.txt`
  - [ ] Ensure plain text version includes all information
  - [ ] Format plain text for readability
  - [ ] Include all links as URLs
  - [ ] Test plain text version
- [ ] Task 10: Manual testing (AC: 9)
  - [ ] Send test email alert
  - [ ] Verify formatting in multiple email clients
  - [ ] Verify all links work correctly
  - [ ] Verify buttons are clickable
  - [ ] Test on mobile devices
  - [ ] Verify plain text version

## Dev Notes

### Previous Story Insights
- Story 3.2 created initial email template system
- Story 6.2 added "Forward to Team" functionality
- Story 6.4 created weekly summary email templates
- Current email templates use Jinja2 and basic HTML

### Email Template System
[Source: docs/stories/3.2.email-template-system.story.md]

**Current Templates:**
- `change_alert.html` - HTML email template
- `change_alert.txt` - Plain text email template
- EmailTemplateService for rendering
- Templates use Jinja2 with placeholders

**Current Features:**
- Route information (origin → destination, visa_type)
- Source name and URL
- Detected timestamp
- Diff preview (first 500 characters or 20 lines)
- Link to full diff
- Disclaimer

### Email Sending Service
[Source: docs/stories/3.3.email-sending-service-integration.story.md]

**Email Service:**
- Resend API for sending emails
- Supports HTML and plain text versions
- Error handling and retry logic

### Email Client Compatibility
[Source: docs/architecture/external-apis.md]

**Resend API:**
- Supports HTML and plain text email
- Email clients handle rendering
- Need to test across clients for compatibility

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to update:
- `admin-ui/templates/emails/change_alert.html` - HTML email template
- `admin-ui/templates/emails/change_alert.txt` - Plain text email template
- `api/services/email_template.py` - Email template service (if updates needed)

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Email Templates:**
- Use table-based layouts for email compatibility
- Inline CSS styles (email clients strip `<style>` tags)
- Test across multiple email clients
- Ensure plain text version is readable

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Manual Testing:**
- Test in multiple email clients
- Test on mobile devices
- Verify all links and buttons work
- Verify formatting is correct

### Technical Constraints
- Email clients have limited CSS support
- Must use table-based layouts for compatibility
- Inline styles required (no external CSS)
- Plain text version must be readable
- Buttons must work in all clients

## Testing

**Email Client Testing:**
- Test in Gmail (web and mobile)
- Test in Outlook (desktop and web)
- Test in Apple Mail (desktop and mobile)
- Test in other common clients

**Mobile Testing:**
- Test on iOS devices
- Test on Android devices
- Verify responsive design works

**Functional Testing:**
- Verify all links work correctly
- Verify buttons are clickable
- Verify plain text version is readable
- Verify formatting is correct

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

