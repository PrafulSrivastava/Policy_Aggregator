# Story 3.2: Email Template System

## Status
Ready for Review

## Story
**As a** developer,  
**I want** email templates for policy change alerts,  
**so that** users receive clear, actionable notifications with all necessary information.

## Acceptance Criteria

1. Email template with placeholders for:
   - Route (origin → destination, visa_type)
   - Source name and URL
   - Detected timestamp
   - Diff preview (first 500 characters or first 20 lines)
   - Link to full diff (admin UI URL)
2. Template is HTML format (with plain text fallback)
3. Email subject line: "Policy Change Detected: [Route] - [Source Name]"
4. Email includes clear call-to-action: "View Full Diff" button/link
5. Template includes source attribution prominently (builds trust)
6. Template includes disclaimer: "This is information, not legal advice"
7. Template is configurable (can be updated without code changes)
8. Unit tests: template rendering with sample data
9. Manual test: render template and verify formatting

## Tasks / Subtasks

- [x] Task 1: Create email template structure (AC: 1, 2, 4, 5, 6)
  - [x] Create `admin-ui/templates/emails/change_alert.html` (Jinja2 template)
  - [x] Create HTML email template with:
    - [x] Header with route information (origin → destination, visa_type)
    - [x] Source attribution section (source name, URL link)
    - [x] Detected timestamp
    - [x] Diff preview section (first 500 characters or 20 lines)
    - [x] "View Full Diff" button/link (call-to-action)
    - [x] Disclaimer: "This is information, not legal advice"
  - [x] Use professional, clean design (Tailwind CSS or inline styles)
  - [x] Make template responsive (mobile-friendly)
- [x] Task 2: Create plain text fallback (AC: 2)
  - [x] Create `admin-ui/templates/emails/change_alert.txt` (plain text version)
  - [x] Include same information as HTML version
  - [x] Format for plain text email clients
  - [x] Include link to full diff (as URL)
- [x] Task 3: Create template rendering service (AC: 1, 7)
  - [x] Create `api/services/email_template.py` or add to alert engine
  - [x] Implement `render_change_alert_template(change: PolicyChange, route: RouteSubscription, source: Source, diff_preview: str, admin_ui_url: str) -> EmailContent` function
  - [x] Use Jinja2 to render HTML template
  - [x] Use Jinja2 to render plain text template
  - [x] Return both HTML and plain text versions
  - [x] Make template path configurable (from environment or default)
- [x] Task 4: Generate email subject line (AC: 3)
  - [x] Implement `generate_email_subject(route: RouteSubscription, source: Source) -> str` function
  - [x] Format: "Policy Change Detected: {origin} → {destination}, {visa_type} - {source_name}"
  - [x] Example: "Policy Change Detected: India → Germany, Student Visa - Germany BMI"
- [x] Task 5: Generate diff preview (AC: 1)
  - [x] Implement `generate_diff_preview(diff: str, max_chars: int = 500, max_lines: int = 20) -> str` function
  - [x] Extract first 500 characters or first 20 lines (whichever comes first)
  - [x] Add ellipsis ("...") if diff is truncated
  - [x] Preserve diff format (unified diff format)
- [x] Task 6: Add template configuration (AC: 7)
  - [x] Store template path in configuration
  - [x] Allow template customization via environment variables (optional)
  - [x] Document how to update templates
  - [x] Ensure templates can be updated without code changes
- [x] Task 7: Create unit tests (AC: 8)
  - [x] Create `tests/unit/test_services/test_email_template.py`
  - [x] Test template rendering:
    - [x] Renders HTML template with all placeholders
    - [x] Renders plain text template
    - [x] Includes all required information
    - [x] Handles missing data gracefully
  - [x] Test subject line generation:
    - [x] Formats correctly with route and source
    - [x] Handles special characters
  - [x] Test diff preview generation:
    - [x] Truncates at character limit
    - [x] Truncates at line limit
    - [x] Preserves diff format
- [ ] Task 8: Manual template verification (AC: 9)
  - [ ] Render template with sample data
  - [ ] Verify HTML formatting in email client
  - [ ] Verify plain text formatting
  - [ ] Verify all links work
  - [ ] Verify responsive design (mobile view)
  - [ ] Document template structure and customization

## Dev Notes

### Previous Story Insights
- Story 3.1 created route-to-source mapping logic
- Story 2.8 created PolicyChange records with diff
- Story 1.3 created repositories for PolicyChange, RouteSubscription, Source
- Admin UI URL will be configured in environment variables

### Components Architecture
[Source: architecture/components.md]

**Alert Engine:**
- Formats email with route, source, timestamp, diff preview
- Uses Jinja2 for email templates

**Key Interfaces:**
- `format_email_content(change, route)` - Formats email HTML/text content

**Technology Stack:** Jinja2 for email templates

### External APIs
[Source: architecture/external-apis.md]

**Resend API:**
- Accepts HTML and plain text email body
- Email templates use Jinja2 for rendering

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `admin-ui/templates/emails/change_alert.html` - HTML email template
- `admin-ui/templates/emails/change_alert.txt` - Plain text email template
- `api/services/email_template.py` - Template rendering service (or add to alert_engine.py)
- `tests/unit/test_services/test_email_template.py` - Unit tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Template Rendering:** All Jinja2 templates must be rendered through FastAPI's `templates` dependency or Jinja2 environment.

**Type Hints:** All Python functions must have type hints.

**Configuration:** Template paths must be configurable via environment variables.

### Tech Stack
[Source: architecture/tech-stack.md]

**Email Templates:**
- Jinja2 for template rendering
- HTML and plain text versions required

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test template rendering with sample data
- Test subject line generation
- Test diff preview generation

**Manual Testing:**
- Render template and verify in email client
- Test responsive design

### Technical Constraints
- Templates must be HTML and plain text
- Templates must be configurable (not hardcoded)
- Diff preview must be limited (500 chars or 20 lines)
- Admin UI URL must be configurable
- Template must include disclaimer

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_email_template.py`

**Test Standards:**
- Use pytest framework
- Test files follow `test_*.py` naming convention
- Use Jinja2 environment for testing

**Testing Frameworks:**
- pytest 7.4+ with async support

**Specific Testing Requirements:**
- Test HTML template rendering with all placeholders
- Test plain text template rendering
- Test subject line generation
- Test diff preview generation (truncation)
- Test with missing data (graceful handling)
- Manual test: render and verify in email client

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A

### Completion Notes List
1. Created HTML email template (`admin-ui/templates/emails/change_alert.html`) with professional design using inline CSS for email client compatibility
2. Created plain text email template (`admin-ui/templates/emails/change_alert.txt`) with all required information
3. Created `api/services/email_template.py` with EmailTemplateService class:
   - `render_change_alert_template()` - Renders both HTML and plain text templates using Jinja2
   - `generate_email_subject()` - Generates formatted subject line
   - `generate_diff_preview()` - Truncates diff to 500 chars or 20 lines (whichever comes first)
4. Added configuration to `api/config.py`:
   - `EMAIL_TEMPLATE_DIR` - Configurable template directory path (defaults to "admin-ui/templates/emails")
   - `ADMIN_UI_URL` - Configurable admin UI URL (defaults to "http://localhost:8000")
5. Templates include all required elements:
   - Route information (origin → destination, visa_type)
   - Source attribution (name, URL)
   - Detected timestamp
   - Diff preview (truncated)
   - "View Full Diff" call-to-action button/link
   - Disclaimer: "This is information, not legal advice"
6. HTML template uses inline styles for email client compatibility and includes responsive design (mobile-friendly)
7. Created comprehensive unit tests in `tests/unit/test_services/test_email_template.py`:
   - Template rendering tests (HTML and plain text)
   - Subject line generation tests
   - Diff preview generation tests (character limit, line limit, special characters)
   - Edge case handling tests
8. Templates are configurable via environment variables and can be updated without code changes
9. All code follows coding standards: type hints, async/await where appropriate, proper error handling, logging

### File List
- `admin-ui/templates/emails/change_alert.html` (new)
- `admin-ui/templates/emails/change_alert.txt` (new)
- `api/services/email_template.py` (new)
- `api/config.py` (modified - added EMAIL_TEMPLATE_DIR and ADMIN_UI_URL)
- `tests/unit/test_services/test_email_template.py` (new)

## QA Results
_To be populated by QA Agent_

