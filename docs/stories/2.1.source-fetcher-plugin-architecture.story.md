# Story 2.1: Source Fetcher Plugin Architecture

## Status
Draft

## Story
**As a** developer,  
**I want** a plugin-based architecture for source fetchers,  
**so that** I can add new sources by creating new files without modifying core pipeline code.

## Acceptance Criteria

1. Base fetcher interface/abstract class defined with standard method signature:
   - Input: source URL and metadata
   - Output: raw text content and fetch metadata (timestamp, content_type, etc.)
2. Fetcher registry system that can discover and load fetcher modules from `fetchers/` directory
3. Fetcher naming convention: `{country}_{agency}_{visa_type}.py` (e.g., `de_bmi_workvisa.py`)
4. Each fetcher is a standalone Python module with a `fetch()` function
5. Error handling: fetchers return success/failure status with error messages
6. Fetcher metadata: each fetcher can specify its source type (HTML, PDF, API)
7. Unit tests for fetcher registry and loading mechanism
8. Documentation: example fetcher template and guidelines for creating new fetchers

## Tasks / Subtasks

- [x] Task 1: Create base fetcher interface (AC: 1, 5, 6)
  - [x] Create `fetchers/base.py`
  - [x] Define `FetchResult` dataclass or Pydantic model:
    - [x] `raw_text: str` - Extracted text content
    - [x] `content_type: str` - "html", "pdf", or "text"
    - [x] `fetched_at: datetime` - Timestamp of fetch
    - [x] `metadata: dict` - Additional fetch metadata (page title, last modified, etc.)
    - [x] `success: bool` - Whether fetch succeeded
    - [x] `error_message: Optional[str]` - Error message if failed
  - [x] Define abstract base class or protocol for fetchers
  - [x] Define standard `fetch(url: str, metadata: dict) -> FetchResult` signature
- [x] Task 2: Create fetcher registry system (AC: 2, 3, 4)
  - [x] Create `api/services/fetcher_manager.py`
  - [x] Implement `load_fetchers()` function:
    - [x] Scan `fetchers/` directory for Python modules
    - [x] Filter files matching naming convention: `{country}_{agency}_{visa_type}.py`
    - [x] Dynamically import each fetcher module
    - [x] Verify each module has `fetch()` function
    - [x] Register fetchers in a registry dictionary
  - [x] Implement `get_fetcher_for_source(source)` function:
    - [x] Match source by country, visa_type, and fetch_type
    - [x] Return appropriate fetcher function
  - [x] Handle import errors gracefully
- [x] Task 3: Implement fetcher discovery and loading (AC: 2, 4)
  - [x] Use Python's `importlib` for dynamic module loading
  - [x] Scan `fetchers/` directory using `os.listdir()` or `pathlib`
  - [x] Filter Python files (`.py` extension, exclude `__init__.py` and `base.py`)
  - [x] Import modules dynamically: `importlib.import_module()`
  - [x] Extract `fetch` function from each module
  - [x] Store in registry: `{fetcher_name: fetch_function}`
- [x] Task 4: Add error handling to fetcher interface (AC: 5)
  - [x] Ensure `FetchResult` includes `success` and `error_message` fields
  - [x] Define standard error types (NetworkError, ParseError, etc.)
  - [x] Document error handling patterns for fetcher developers
  - [x] Ensure fetchers can return failure status without raising exceptions
- [x] Task 5: Add fetcher metadata support (AC: 6)
  - [x] Allow fetchers to specify source type via metadata or function attribute
  - [x] Support source types: "html", "pdf", "api"
  - [x] Store metadata in fetcher registry
  - [x] Use metadata for fetcher selection in `get_fetcher_for_source()`
- [x] Task 6: Create example fetcher template (AC: 8)
  - [x] Create `fetchers/example_template.py` or `fetchers/README.md`
  - [x] Document fetcher structure:
    - [x] Required `fetch()` function signature
    - [x] Return type: `FetchResult`
    - [x] Error handling approach
    - [x] Metadata requirements
  - [x] Include complete example fetcher code
  - [x] Document naming convention rules
- [x] Task 7: Create unit tests (AC: 7)
  - [x] Create `tests/unit/test_services/test_fetcher_manager.py`
  - [x] Test `load_fetchers()`:
    - [x] Discovers fetchers in `fetchers/` directory
    - [x] Loads fetcher modules correctly
    - [x] Handles missing `fetch()` function gracefully
    - [x] Handles import errors gracefully
  - [x] Test `get_fetcher_for_source()`:
    - [x] Returns correct fetcher for source
    - [x] Handles missing fetcher gracefully
    - [x] Matches by country, visa_type, fetch_type
  - [x] Test fetcher registry:
    - [x] Stores fetchers correctly
    - [x] Handles duplicate names
- [x] Task 8: Create fetcher documentation (AC: 8)
  - [x] Create `docs/fetchers/README.md` or add to main README
  - [x] Document plugin architecture overview
  - [x] Document naming convention: `{country}_{agency}_{visa_type}.py`
  - [x] Document `fetch()` function signature and return type
  - [x] Document error handling patterns
  - [x] Include example fetcher code
  - [x] Document how to add new fetchers

## Dev Notes

### Previous Story Insights
- Story 1.1 established `fetchers/` directory structure
- Story 1.3 created repositories including Source repository
- Story 1.7 created Source API endpoints for managing sources
- Database models and repositories are available

### Components Architecture
[Source: architecture/components.md]

**Fetcher Manager:**
- Orchestrates source fetching operations
- Discovers and loads source fetcher plugins
- Manages concurrent fetching
- Provides plugin registry and execution environment

**Key Interfaces:**
- `load_fetchers()` - Discovers and loads all fetcher plugins from `fetchers/` directory
- `fetch_source(source_id)` - Executes fetcher for a specific source
- `get_fetcher_for_source(source)` - Returns appropriate fetcher plugin for a source
- `register_fetcher(name, fetcher_function)` - Registers a new fetcher plugin

**Source Fetchers (Plugin System):**
- Individual plugin modules for specific government sources
- Standard interface: `fetch(url, metadata) -> FetchResult`
- Output: `FetchResult` with raw text, content type, fetch timestamp, and metadata

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `fetchers/base.py` - Base fetcher interface and common utilities
- `api/services/fetcher_manager.py` - Fetcher manager implementation
- `fetchers/example_template.py` or `fetchers/README.md` - Example fetcher template
- `docs/fetchers/README.md` - Fetcher documentation (optional, can be in main README)

### Coding Standards
[Source: architecture/coding-standards.md]

**Fetcher Interface:** All source fetchers must implement the `SourceFetcher` interface. Never bypass the fetcher manager.

**Type Hints:** All Python functions must have type hints.

**Error Handling:** Fetchers should return error status in `FetchResult`, not raise exceptions (allows graceful handling).

**Logging:** Use Python's `logging` module for fetcher operations.

### Tech Stack
[Source: architecture/tech-stack.md]

**Fetcher Technology:**
- Python 3.10+
- `importlib` for dynamic module loading
- `asyncio` for concurrent fetching (future use)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test fetcher discovery and loading
- Test registry functionality
- Test error handling
- Use mock fetcher modules for testing

### Technical Constraints
- Fetchers must be standalone Python modules
- Naming convention: `{country}_{agency}_{visa_type}.py`
- All fetchers must implement `fetch(url: str, metadata: dict) -> FetchResult`
- Fetchers should not raise exceptions (return error in FetchResult)
- Dynamic loading must handle import errors gracefully

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_services/test_fetcher_manager.py`

**Test Standards:**
- Use pytest framework
- Test files follow `test_*.py` naming convention
- Use mock fetcher modules for testing

**Testing Frameworks:**
- pytest 7.4+ with async support

**Specific Testing Requirements:**
- Test fetcher discovery (scanning directory, filtering files)
- Test dynamic module loading
- Test fetcher registry storage and retrieval
- Test `get_fetcher_for_source()` matching logic
- Test error handling (missing fetch function, import errors)
- Test with mock fetcher modules

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Auto)

### Debug Log References
None - No debug issues encountered during implementation.

### Completion Notes List
- Created base fetcher interface with `FetchResult` Pydantic model and `SourceFetcher` Protocol
- Implemented `FetcherManager` service with dynamic module loading using `importlib`
- Fetcher discovery uses regex pattern matching for naming convention: `{country}_{agency}_{visa_type}.py`
- Matching logic in `get_fetcher_for_source()` matches by country, visa_type, and fetch_type
- Error handling implemented via `FetchResult` with `success` flag and `error_message` field
- Standard error types defined in `FetchErrorType` enum
- Fetcher metadata support via `SOURCE_TYPE` module constant or function attribute
- Comprehensive unit tests created covering discovery, loading, matching, and error handling
- Example template and full documentation provided for developers

### File List
**Created:**
- `fetchers/base.py` - Base fetcher interface, FetchResult model, and error types
- `api/services/__init__.py` - Services package init
- `api/services/fetcher_manager.py` - Fetcher manager with discovery, loading, and registry
- `fetchers/example_template.py` - Example fetcher template with documentation
- `tests/unit/test_services/__init__.py` - Test services package init
- `tests/unit/test_services/test_fetcher_manager.py` - Comprehensive unit tests
- `docs/fetchers/README.md` - Complete fetcher documentation

**Modified:**
- None

## QA Results
_To be populated by QA Agent_

