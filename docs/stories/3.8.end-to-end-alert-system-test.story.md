# Story 3.8: End-to-End Alert System Test

## Status
Ready for Review

## Story
**As a** developer,  
**I want** comprehensive testing of the complete alert system,  
**so that** I can verify the entire flow from source change to email delivery works correctly.

## Acceptance Criteria

1. End-to-end test scenario:
   - Create route subscription
   - Create source
   - Manually trigger fetch (simulate change)
   - Verify PolicyChange created
   - Verify email sent to route subscription email
   - Verify email content is correct
2. Test with multiple routes matching one source (verify all get emails)
3. Test with route that has no matching sources (verify no false alerts)
4. Test error scenarios: email service failure, source fetch failure
5. Test scheduled job runs successfully
6. Manual verification: run full pipeline, check email inbox
7. Documentation: how to test alert system manually

## Tasks / Subtasks

- [x] Task 1: Create end-to-end test scenario (AC: 1)
  - [x] Create `tests/integration/test_e2e/test_alert_system.py`
  - [x] Implement test: `test_full_alert_flow()`
  - [x] Test steps:
    - [x] Create RouteSubscription (via API or directly)
    - [x] Create Source (via API or directly)
    - [x] Manually trigger fetch for source (via API endpoint from Story 2.9)
    - [x] Simulate content change (or use test source that changes)
    - [x] Verify PolicyChange created in database
    - [x] Verify email sent (mock or real email service)
    - [x] Verify email content includes:
      - [x] Route information
      - [x] Source information
      - [x] Timestamp
      - [x] Diff preview
      - [x] Link to full diff
- [x] Task 2: Test multiple routes per source (AC: 2)
  - [x] Create test: `test_multiple_routes_one_source()`
  - [x] Create one source
  - [x] Create multiple RouteSubscriptions matching the source
  - [x] Trigger fetch with change
  - [x] Verify all matching routes receive emails
  - [x] Verify each route gets exactly one email
- [x] Task 3: Test route with no matching sources (AC: 3)
  - [x] Create test: `test_route_no_matching_sources()`
  - [x] Create RouteSubscription with no matching sources
  - [x] Trigger fetch for unrelated source
  - [x] Verify no email sent to route
  - [x] Verify no false alerts
- [x] Task 4: Test error scenarios (AC: 4)
  - [x] Create test: `test_email_service_failure()`
    - [x] Mock email service to fail
    - [x] Trigger alert
    - [x] Verify error handled gracefully
    - [x] Verify other routes still get emails (if applicable)
  - [x] Create test: `test_source_fetch_failure()`
    - [x] Mock source fetch to fail
    - [x] Trigger fetch
    - [x] Verify error handled gracefully
    - [x] Verify no false alerts sent
- [x] Task 5: Test scheduled job (AC: 5)
  - [x] Create test: `test_scheduled_job_execution()`
  - [x] Run scheduled job function directly
  - [x] Verify job processes all active sources
  - [x] Verify job handles errors gracefully
  - [x] Verify job logs appropriately
  - [x] Verify job triggers alerts when changes detected
- [x] Task 6: Create manual test procedure (AC: 6, 7)
  - [x] Create `docs/testing/manual-alert-test.md` or add to README
  - [x] Document manual test procedure:
    - [x] How to set up test route and source
    - [x] How to trigger fetch manually
    - [x] How to verify email received
    - [x] How to check email content
    - [x] How to verify PolicyChange created
  - [x] Include test email address setup
  - [x] Include troubleshooting steps
- [x] Task 7: Create test fixtures (AC: 1, 2, 3, 4)
  - [x] Create test fixtures in `tests/fixtures/`:
    - [x] `create_test_route()` - Helper to create test route subscription
    - [x] `create_test_source()` - Helper to create test source
    - [x] `create_test_policy_change()` - Helper to create test policy change
  - [x] Use fixtures in integration tests
- [x] Task 8: Verify email content accuracy (AC: 1)
  - [x] Test email content includes all required fields:
    - [x] Route (origin → destination, visa_type)
    - [x] Source name and URL
    - [x] Detected timestamp
    - [x] Diff preview
    - [x] Link to full diff
    - [x] Disclaimer
  - [x] Test email formatting (HTML and plain text)
  - [x] Test email subject line

## Dev Notes

### Previous Story Insights
- Story 3.1 created route-to-source mapping
- Story 3.2 created email templates
- Story 3.3 created email sending service
- Story 3.4 created alert engine
- Story 3.5 created scheduled job system
- Story 2.9 created fetch pipeline
- All components are ready for end-to-end testing

### Components Architecture
[Source: architecture/components.md]

**Complete Alert Flow:**
1. Fetch source → Normalize → Detect change
2. Create PolicyChange record
3. Find matching RouteSubscriptions
4. Format and send email alerts
5. Create EmailAlert records

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `tests/integration/test_e2e/test_alert_system.py` - End-to-end tests
- `tests/fixtures/alert_fixtures.py` - Test fixtures for alerts
- `docs/testing/manual-alert-test.md` - Manual testing documentation

### Coding Standards
[Source: architecture/coding-standards.md]

**Testing:** All new features must include integration tests for critical flows.

**Documentation:** Document manual testing procedures.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Integration Tests:**
- Test complete alert flow end-to-end
- Test error scenarios
- Test edge cases

**Manual Testing:**
- Verify email delivery
- Verify email content
- Test with real email service

### Technical Constraints
- Tests should use mock email service for automated tests
- Manual tests should use real email service
- Tests should be repeatable and isolated

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/integration/test_e2e/test_alert_system.py`

**Test Standards:**
- Use pytest framework
- Use async test fixtures for database operations
- Mock email service for automated tests
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support
- pytest-asyncio for async test support

**Specific Testing Requirements:**
- Test full alert flow end-to-end
- Test multiple routes per source
- Test route with no matching sources
- Test error scenarios (email failure, fetch failure)
- Test scheduled job execution
- Manual test: verify email delivery and content

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Created comprehensive end-to-end test suite `tests/integration/test_e2e/test_alert_system.py` with 8 test scenarios:
  - `test_full_alert_flow()`: Complete flow from route/source creation → fetch → change detection → email delivery
  - `test_multiple_routes_one_source()`: Verifies all matching routes receive emails when one source changes
  - `test_route_no_matching_sources()`: Verifies no false alerts sent when route doesn't match source
  - `test_email_service_failure()`: Tests graceful error handling when email service fails
  - `test_source_fetch_failure()`: Tests graceful error handling when source fetch fails
  - `test_scheduled_job_execution()`: Tests scheduled job processes sources and triggers alerts
  - `test_email_content_accuracy()`: Verifies email content includes all required fields
- Created test fixtures in `tests/fixtures/alert_fixtures.py`:
  - `create_test_source()`: Helper to create test sources with configurable parameters
  - `create_test_route()`: Helper to create test route subscriptions
  - `create_test_policy_change()`: Helper to create test policy changes
  - `create_test_policy_version()`: Helper to create test policy versions
- Created comprehensive manual testing documentation `docs/testing/manual-alert-test.md`:
  - Step-by-step instructions for manual testing
  - Prerequisites and environment setup
  - Test procedures for all scenarios (single route, multiple routes, error scenarios)
  - Troubleshooting guide
  - Test checklist
- Test coverage includes:
  - Full alert flow: route creation → source creation → fetch → change detection → email delivery
  - Email content verification: route info, source info, timestamp, diff preview, link to full diff, disclaimer
  - Multiple routes per source: all routes receive emails
  - Route with no matching sources: no false alerts
  - Error scenarios: email service failure, source fetch failure
  - Scheduled job execution: processes sources, triggers alerts
- All tests use mock email service for automated testing
- Tests verify database records (PolicyChange, EmailAlert) are created correctly
- Tests verify email content includes all required fields in both HTML and plain text formats

### File List
**Created:**
- `tests/integration/test_e2e/test_alert_system.py` - Comprehensive end-to-end tests for alert system
- `tests/integration/test_e2e/__init__.py` - Package init file
- `tests/fixtures/alert_fixtures.py` - Test fixtures for creating test data
- `docs/testing/manual-alert-test.md` - Manual testing documentation and procedures

## QA Results
_To be populated by QA Agent_

