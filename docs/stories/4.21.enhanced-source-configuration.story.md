# Story 4.21: Enhanced Source Configuration with Status Indicators

## Status
Draft

## Story
**As a** user,  
**I want** to manage sources with visual status indicators and management actions,  
**so that** I can monitor source health and trigger manual operations.

## Acceptance Criteria

1. Source list displays: Name, Target URL, Region, Visa Type, Fetch Method (HTML/PDF), Frequency, Health Status
2. Color-coded status badges: "Healthy" (green), "Stale" (yellow), "Error" (red)
3. "Add Node" button opens configuration modal
4. Modal fields: Region, Type (Visa Type), Endpoint URL, Fetch Method, Frequency
5. Row actions: "Play" button (simulates manual run) and "Edit" button
6. "Play" button triggers visual feedback (loading state)
7. Status indicators update based on source health from API
8. Design system styling applied

## Tasks / Subtasks

- [x] Task 1: Enhance source list display (AC: 1)
  - [x] Update Sources table to show all required columns
  - [x] Format URL display (truncate if long)
  - [x] Display Fetch Method as badge (HTML/PDF)
  - [x] Display Frequency as badge
- [x] Task 2: Create status indicator component (AC: 2, 7)
  - [x] Create `src/components/sources/StatusBadge.tsx`
  - [x] Implement color-coded badges:
    - [x] "Healthy" - green/black styling
    - [x] "Stale" - yellow/amber styling
    - [x] "Error" - red styling
  - [x] Determine status from source data (last_checked_at, consecutive_failures)
  - [x] Apply design system styling
- [x] Task 3: Create source modal component (AC: 3, 4, 8)
  - [x] Create `src/components/sources/SourceModal.tsx`
  - [x] Implement modal with form fields:
    - [x] Region dropdown (country selection)
    - [x] Type dropdown (visa type selection)
    - [x] Endpoint URL input
    - [x] Fetch Method radio buttons (HTML/PDF)
    - [x] Frequency dropdown (daily, weekly, custom)
  - [x] Support both "create" and "edit" modes
  - [x] Apply design system styling
- [x] Task 4: Implement row actions (AC: 5, 6)
  - [x] Add "Play" button to each source row
  - [x] Add "Edit" button to each source row
  - [x] Implement "Play" button handler:
    - [x] Call `POST /api/sources/{id}/trigger` endpoint
    - [x] Show loading state during trigger
    - [x] Display result (success/error)
  - [x] Implement "Edit" button handler:
    - [x] Open modal with source data pre-filled
- [x] Task 5: Fetch source health data (AC: 7)
  - [x] Update sources service to fetch health status
  - [x] Use `/api/status` endpoint or source metadata
  - [x] Calculate status: Healthy, Stale, or Error
  - [x] Update source list with status
- [x] Task 6: Create unit tests (AC: All)
  - [x] Test status badge component
  - [x] Test source modal component
  - [x] Test "Play" button functionality
  - [x] Test "Edit" button functionality
  - [x] Test status calculation logic
- [ ] Task 7: Manual testing (AC: All)
  - [ ] Test source list display
  - [ ] Test status indicators
  - [ ] Test "Add Node" modal
  - [ ] Test "Play" button
  - [ ] Test "Edit" button

## Dev Notes

### Previous Story Insights
- Story 4.13 created source management
- Sources API endpoints exist
- Need to add status indicators and actions

### API Specifications
[Source: architecture/api-specification.md]

**Sources Endpoint:**
- `GET /api/sources` - List sources
- `POST /api/sources` - Create source
- `PUT /api/sources/{id}` - Update source
- `POST /api/sources/{id}/trigger` - Manual trigger fetch

**Status Endpoint:**
- `GET /api/status` - Get system status with source health

### Design System
[Source: .ignore/design_prompt.md]

**Badge Styling:**
- Sharp corners
- Color coding: green (healthy), yellow (stale), red (error)
- Text labels, not just color

### File Locations
- `frontend/src/pages/Sources.tsx` - Update sources list
- `frontend/src/components/sources/StatusBadge.tsx` - Create status badge
- `frontend/src/components/sources/SourceModal.tsx` - Create source modal
- `frontend/src/services/sources.ts` - Update with trigger function

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `frontend/src/__tests__/components/sources/StatusBadge.test.tsx`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### File List
**New Files:**
- `frontend/src/components/sources/StatusBadge.tsx` - Status badge component with color-coded indicators
- `frontend/src/components/sources/SourceModal.tsx` - Modal component for creating/editing sources
- `frontend/src/__tests__/components/sources/StatusBadge.test.tsx` - Unit tests for StatusBadge component
- `frontend/src/__tests__/components/sources/SourceModal.test.tsx` - Unit tests for SourceModal component

**Modified Files:**
- `frontend/src/pages/Sources.tsx` - Enhanced sources list page with table, status indicators, and actions
- `frontend/src/services/sources.ts` - Added `updateSource`, `triggerSourceFetch`, and `getSystemStatus` functions; extended Source interface with status fields
- `frontend/src/__tests__/services/sources.test.ts` - Added tests for new service functions

### Completion Notes
1. **StatusBadge Component**: Created reusable status badge component with color-coded indicators (green for healthy, yellow for stale, red for error, gray for never checked). Uses design system styling with sharp corners and text labels.

2. **SourceModal Component**: Created modal component supporting both create and edit modes. Includes all required form fields: Region (country dropdown), Type (visa type dropdown), Endpoint URL, Fetch Method (radio buttons), and Frequency (dropdown). Form validation included.

3. **Sources Page Enhancement**: Updated Sources page to display full table with all required columns (Name, Target URL, Region, Visa Type, Fetch Method, Frequency, Health Status, Actions). URL truncation implemented. Fetch Method and Frequency displayed as badges.

4. **Row Actions**: Implemented "Play" button (â–¶) for triggering manual fetches and "Edit" button for editing sources. Play button shows loading state and displays result message. Edit button opens modal with pre-filled data.

5. **Source Health Data**: Integrated with `/api/status` endpoint to fetch sources with health status. Status is calculated server-side and displayed using StatusBadge component.

6. **Service Functions**: Added `updateSource` for updating sources, `triggerSourceFetch` for manual fetch triggers, and `getSystemStatus` for fetching sources with health information.

7. **Unit Tests**: Created comprehensive unit tests for StatusBadge component (6 tests) and SourceModal component. Added tests for new service functions (updateSource, triggerSourceFetch, getSystemStatus). All tests passing.

### Debug Log References
None - No blocking issues encountered during implementation.

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-27 | 1.1 | Implementation completed - All tasks except manual testing | Dev Agent |

## QA Results
_To be populated by QA Agent_

