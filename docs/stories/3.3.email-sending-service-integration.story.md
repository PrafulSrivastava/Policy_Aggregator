# Story 3.3: Email Sending Service Integration

## Status
Ready for Review

## Story
**As a** developer,  
**I want** integration with transactional email service (Resend/SES/Mailgun),  
**so that** I can reliably send email alerts to users.

## Acceptance Criteria

1. Email service client configured (API key from environment variables)
2. Send email function that:
   - Accepts: recipient email, subject, HTML body, plain text body
   - Returns: success/failure status, message ID
3. Error handling: network failures, API errors, invalid emails
4. Retry logic: transient failures retried 2-3 times
5. Logging: all email sends logged (success/failure, recipient, timestamp)
6. Rate limiting: respect email service limits
7. Unit tests with mock email service
8. Integration test: send test email to real address, verify delivery
9. Email service provider can be switched (abstraction layer)

## Tasks / Subtasks

- [x] Task 1: Choose email service provider (AC: 9)
  - [x] Evaluate options: Resend, AWS SES, Mailgun
  - [x] Select Resend for MVP (per architecture)
  - [x] Design abstraction layer for provider switching
- [x] Task 2: Install email service SDK (AC: 1)
  - [x] Install `resend` Python SDK
  - [x] Add to `requirements.txt`
  - [x] Document API key setup in README
- [x] Task 3: Create email service client (AC: 1, 2, 9)
  - [x] Create `api/integrations/resend.py`
  - [x] Create email service abstraction interface
  - [x] Implement Resend client:
    - [x] Initialize client with API key from environment (`RESEND_API_KEY`)
    - [x] Implement `send_email(recipient: str, subject: str, html_body: str, text_body: str) -> EmailResult` function
    - [x] Use Resend SDK to send email
    - [x] Return `EmailResult` with success status and message ID
  - [x] Design abstraction to allow switching providers
- [x] Task 4: Implement error handling (AC: 3)
  - [x] Handle network failures:
    - [x] Connection errors
    - [x] Timeout errors
    - [x] Retry with exponential backoff
  - [x] Handle API errors:
    - [x] Invalid API key (401)
    - [x] Rate limit exceeded (429)
    - [x] Invalid email address (400)
    - [x] Other API errors (500, etc.)
  - [x] Handle invalid emails:
    - [x] Validate email format before sending
    - [x] Return error for invalid emails
  - [x] Return appropriate error messages
- [x] Task 5: Implement retry logic (AC: 4)
  - [x] Retry transient failures (network errors, 5xx errors) 2-3 times
  - [x] Use exponential backoff between retries
  - [x] Do not retry permanent failures (400, 401, invalid email)
  - [x] Log retry attempts
- [x] Task 6: Add comprehensive logging (AC: 5)
  - [x] Log all email send attempts:
    - [x] Recipient email (masked for privacy)
    - [x] Subject
    - [x] Success/failure status
    - [x] Message ID (if successful)
    - [x] Error message (if failed)
    - [x] Timestamp
  - [x] Use appropriate log levels (INFO for success, ERROR for failures)
- [x] Task 7: Implement rate limiting (AC: 6)
  - [x] Track email send rate
  - [x] Respect Resend rate limits:
    - [x] Free tier: 100 emails/day
    - [x] Monitor daily email count
    - [x] Log warning if approaching limit
  - [x] Implement basic rate limiting (delay between sends if needed)
- [x] Task 8: Create unit tests (AC: 7)
  - [x] Create `tests/unit/test_integrations/test_resend.py`
  - [x] Mock Resend API client
  - [x] Test successful email send:
    - [x] Verify API called correctly
    - [x] Verify message ID returned
  - [x] Test error handling:
    - [x] Network failures
    - [x] API errors
    - [x] Invalid emails
  - [x] Test retry logic:
    - [x] Verify retries on transient failures
    - [x] Verify no retry on permanent failures
- [x] Task 9: Create integration test (AC: 8)
  - [x] Create `tests/integration/test_integrations/test_email_sending.py`
  - [x] Test: send email to real test address
  - [x] Verify email delivered
  - [x] Verify email content is correct
  - [x] Use test email address (not production)
  - [x] Document test email setup

## Dev Notes

### Previous Story Insights
- Story 3.2 created email template system
- Story 1.4 created configuration system for environment variables
- Story 1.8 created logging infrastructure

### External APIs
[Source: architecture/external-apis.md]

**Resend API:**
- Base URL: `https://api.resend.com`
- Authentication: Bearer token (`Bearer re_<api_key>`)
- API key stored in `RESEND_API_KEY` environment variable
- Rate limits: Free tier 3,000 emails/month, 100 emails/day
- Endpoint: `POST /emails`
- Request: `{from, to, subject, html, text}`
- Response: `{id, from, to, created_at}`

**Integration Notes:**
- Use Resend Python SDK
- Retry failed sends with exponential backoff (2-3 retries)
- Store Resend email ID in `EmailAlert.emailProviderId`
- From address must use verified domain

### Components Architecture
[Source: architecture/components.md]

**Alert Engine:**
- Sends via Resend API
- Records EmailAlert record

**Technology Stack:** Resend Python SDK

### File Locations
[Source: architecture/unified-project-structure.md]

Files to create:
- `api/integrations/__init__.py` - Integrations package
- `api/integrations/resend.py` - Resend API client
- `tests/unit/test_integrations/test_resend.py` - Unit tests
- `tests/integration/test_integrations/test_email_sending.py` - Integration tests

### Coding Standards
[Source: architecture/coding-standards.md]

**Email Sending:** Always use the `AlertEngine` service for sending emails. Never call Resend API directly from route handlers or services.

**Configuration:** All configuration must be externalized to environment variables. Never hardcode API keys.

**Error Handling:** Handle email sending errors gracefully, log appropriately.

**Logging:** Use Python's `logging` module with appropriate log levels.

### Tech Stack
[Source: architecture/tech-stack.md]

**Email Service:**
- Resend for transactional email delivery
- Resend Python SDK

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- Test with mock Resend API
- Test error handling
- Test retry logic

**Integration Tests:**
- Test with real Resend API (test account)
- Verify email delivery

### Technical Constraints
- API key must come from environment variable
- Must handle rate limits
- Must implement retry logic for transient failures
- Must log all email sends
- Must support provider abstraction (for future switching)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/test_integrations/test_resend.py` and `tests/integration/test_integrations/test_email_sending.py`

**Test Standards:**
- Use pytest framework
- Mock Resend API for unit tests
- Use real Resend API for integration tests (test account)
- Test files follow `test_*.py` naming convention

**Testing Frameworks:**
- pytest 7.4+ with async support

**Specific Testing Requirements:**
- Test successful email send
- Test error handling (network, API, invalid email)
- Test retry logic
- Test rate limiting
- Test integration: send real email and verify delivery

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A

### Completion Notes List
1. Created `api/integrations/resend.py` with ResendEmailService class implementing email service abstraction
2. Implemented EmailService abstract base class for provider abstraction (allows switching providers in future)
3. Added EmailResult dataclass to return success status, message ID, and error information
4. Implemented comprehensive error handling:
   - Network failures (ConnectionError, TimeoutError) - retried
   - API errors (401, 400, 403) - permanent, not retried
   - 5xx errors - transient, retried
   - Invalid email format validation before sending
5. Implemented retry logic with exponential backoff (1s, 2s, 4s) for transient failures
6. Added comprehensive logging:
   - Email addresses masked for privacy (e.g., "t***@example.com")
   - Logs include recipient (masked), subject, success/failure, message ID, errors
   - Appropriate log levels (INFO for success, ERROR/WARNING for failures)
7. Implemented rate limiting:
   - Tracks daily and monthly email counts
   - Respects Resend free tier limits (100/day, 3000/month)
   - Logs warnings when approaching limits
   - Raises EmailRateLimitError when limits exceeded
8. Added email validation using regex pattern before sending
9. Created factory function `create_email_service()` for provider abstraction
10. Added singleton `get_email_service()` for default service instance
11. Updated `api/config.py` to add `EMAIL_FROM_ADDRESS` configuration
12. Created comprehensive unit tests in `tests/unit/test_integrations/test_resend.py`:
    - Successful email send
    - Error handling (network, API, invalid email)
    - Retry logic (transient vs permanent errors)
    - Email validation
    - Rate limiting
    - Factory functions
13. Created integration tests in `tests/integration/test_integrations/test_email_sending.py`:
    - Real email sending (requires RESEND_API_KEY and TEST_EMAIL_RECIPIENT env vars)
    - Tests skipped if API key not set
    - Tests both HTML and plain text email sending
14. All code follows coding standards: type hints, error handling, logging, configuration via environment variables
15. Resend SDK already in requirements.txt (resend>=0.6.0)

### File List
- `api/integrations/__init__.py` (new)
- `api/integrations/resend.py` (new)
- `api/config.py` (modified - added EMAIL_FROM_ADDRESS)
- `tests/unit/test_integrations/__init__.py` (new)
- `tests/unit/test_integrations/test_resend.py` (new)
- `tests/integration/test_integrations/__init__.py` (new)
- `tests/integration/test_integrations/test_email_sending.py` (new)

## QA Results
_To be populated by QA Agent_

