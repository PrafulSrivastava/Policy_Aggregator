# Story 6.1: Improved Diff Rendering

## Status
Draft

## Story
**As an** admin user,  
**I want** enhanced diff rendering with better formatting and readability,  
**so that** I can more easily understand what changed in policy documents.

## Acceptance Criteria

1. Enhanced diff display with improved formatting:
   - Better line spacing and typography
   - Color coding for additions (green) and deletions (red)
   - Line numbers for reference
   - Context lines clearly marked
2. Diff view options:
   - Unified diff view (default)
   - Side-by-side view option (if space allows)
   - Toggle between views
3. Better handling of large diffs:
   - Pagination or "load more" for very large diffs
   - Collapsible sections for unchanged content
   - Jump to next/previous change buttons
4. Syntax highlighting (if applicable):
   - Basic syntax highlighting for structured content
   - Preserve formatting from source documents
5. Diff export options:
   - Download diff as text file
   - Copy diff to clipboard
6. Still text-based (no AI interpretation or summarization)
7. Performance: Large diffs render efficiently (< 2 seconds)
8. Responsive design: Works on desktop and tablet
9. Manual test: View various diff sizes, verify formatting and usability

## Tasks / Subtasks

- [ ] Task 1: Enhance diff formatting and styling (AC: 1)
  - [ ] Update `admin-ui/static/css/diff.css` or add inline styles
  - [ ] Improve line spacing and typography:
    - [ ] Use monospace font for diff content
    - [ ] Increase line height for readability
    - [ ] Add padding between lines
  - [ ] Add color coding:
    - [ ] Green background for additions (lines starting with '+')
    - [ ] Red background for deletions (lines starting with '-')
    - [ ] Gray background for context lines
  - [ ] Add line numbers:
    - [ ] Display line numbers for each line
    - [ ] Style line numbers (gray, right-aligned or left-aligned)
    - [ ] Make line numbers clickable for reference
  - [ ] Mark context lines clearly:
    - [ ] Visual distinction for context vs changes
    - [ ] Optional: collapse context lines by default
- [ ] Task 2: Add diff view options (AC: 2)
  - [ ] Update `admin-ui/templates/pages/changes/detail.html`
  - [ ] Add view toggle buttons:
    - [ ] "Unified View" button (default)
    - [ ] "Side-by-Side View" button
  - [ ] Implement unified diff view (current implementation):
    - [ ] Keep existing unified diff format
    - [ ] Enhance with improved styling
  - [ ] Implement side-by-side view:
    - [ ] Split screen layout (old version left, new version right)
    - [ ] Highlight corresponding changes
    - [ ] Sync scrolling between sides (optional)
  - [ ] Add JavaScript to toggle between views
  - [ ] Store view preference (localStorage or cookie)
- [ ] Task 3: Improve large diff handling (AC: 3)
  - [ ] Update `admin-ui/static/js/diff.js`
  - [ ] Implement pagination or "load more":
    - [ ] Display first N lines (e.g., 100 lines)
    - [ ] Add "Load More" button to load next N lines
    - [ ] Track loaded lines to avoid duplicates
  - [ ] Add collapsible sections for unchanged content:
    - [ ] Detect blocks of unchanged lines
    - [ ] Collapse unchanged blocks (show "... N lines unchanged ...")
    - [ ] Add expand/collapse button for each block
  - [ ] Add jump to next/previous change buttons:
    - [ ] Find all change blocks (added/deleted lines)
    - [ ] Add "Next Change" button (jump to next change block)
    - [ ] Add "Previous Change" button (jump to previous change block)
    - [ ] Highlight current change block
- [ ] Task 4: Add syntax highlighting (AC: 4)
  - [ ] Evaluate syntax highlighting library (e.g., Prism.js, Highlight.js)
  - [ ] Add syntax highlighting for structured content:
    - [ ] Detect content type (if possible)
    - [ ] Apply appropriate syntax highlighting
    - [ ] Preserve diff format (+, -, context markers)
  - [ ] Preserve formatting from source documents:
    - [ ] Maintain whitespace and indentation
    - [ ] Preserve special characters
  - [ ] Make syntax highlighting optional (toggle)
- [ ] Task 5: Add diff export options (AC: 5)
  - [ ] Add "Download Diff" button to change detail page
  - [ ] Create `GET /api/changes/{id}/download` endpoint (if not exists):
    - [ ] Return diff as plain text file
    - [ ] Set Content-Type: text/plain
    - [ ] Set Content-Disposition: attachment; filename="diff-{change_id}.txt"
  - [ ] Add "Copy to Clipboard" button:
    - [ ] Use JavaScript Clipboard API
    - [ ] Copy diff text to clipboard
    - [ ] Show success message on copy
    - [ ] Handle clipboard API errors gracefully
- [ ] Task 6: Ensure text-based approach (AC: 6)
  - [ ] Verify no AI interpretation or summarization
  - [ ] Keep diff as raw text output
  - [ ] No automatic change descriptions
  - [ ] Document that diff is text-based only
- [ ] Task 7: Optimize performance (AC: 7)
  - [ ] Profile diff rendering with large diffs (10,000+ lines)
  - [ ] Optimize JavaScript diff formatting:
    - [ ] Use efficient DOM manipulation
    - [ ] Consider virtual scrolling for very large diffs
    - [ ] Lazy load diff content if needed
  - [ ] Ensure rendering completes in < 2 seconds
  - [ ] Test with various diff sizes
- [ ] Task 8: Ensure responsive design (AC: 8)
  - [ ] Test diff view on desktop (1920x1080, 1366x768)
  - [ ] Test diff view on tablet (768x1024, 1024x768)
  - [ ] Adjust layout for smaller screens:
    - [ ] Stack side-by-side view vertically on mobile
    - [ ] Adjust font sizes for readability
    - [ ] Ensure buttons are touch-friendly
  - [ ] Use Tailwind CSS responsive classes
- [ ] Task 9: Manual testing (AC: 9)
  - [ ] Test with small diffs (< 100 lines)
  - [ ] Test with medium diffs (100-1000 lines)
  - [ ] Test with large diffs (1000-10000 lines)
  - [ ] Test with very large diffs (10000+ lines)
  - [ ] Verify formatting is readable and usable
  - [ ] Test all view options and features

## Dev Notes

### Previous Story Insights
- Story 4.6 created the initial change detail/diff view page
- Current diff rendering uses JavaScript to format unified diff
- Diff is stored in `PolicyChange.diff` field (from Story 2.7)
- Current implementation has basic formatting (added/removed/context lines)

### Current Diff Implementation
[Source: admin-ui/templates/pages/changes/detail.html]

**Current Features:**
- JavaScript-based diff formatting (`formatDiff()` function)
- Basic line type detection (added, removed, context)
- Line numbers displayed
- Truncation for very large diffs (first 1000 lines)
- Collapsible version display (old/new versions)

**Current Styling:**
- CSS classes: `.added`, `.removed`, `.context`
- Basic color coding (needs enhancement)
- Monospace font for diff content

### Frontend Architecture
[Source: docs/architecture/frontend-architecture.md]

**Template Structure:**
- Jinja2 templates in `admin-ui/templates/`
- Tailwind CSS for styling
- Vanilla JavaScript for client-side interactions
- FastAPI web routes for server-side rendering

**File Locations:**
- `admin-ui/templates/pages/changes/detail.html` - Change detail page
- `admin-ui/static/js/diff.js` - Diff formatting JavaScript (if exists)
- `admin-ui/static/css/diff.css` - Diff styling CSS (to create or update)

### Diff Format
[Source: docs/stories/2.7.text-diff-generation.story.md]

**Unified Diff Format:**
- Generated using Python's `difflib.unified_diff()`
- Format: lines starting with '+', '-', or ' ' (context)
- Includes header lines (+++, ---)
- Stored in `PolicyChange.diff` field as text

### Change Detail API
[Source: docs/stories/4.6.change-detail-diff-view.story.md]

**API Endpoint:**
- `GET /api/changes/{id}` - Returns change detail with diff
- `GET /changes/{id}` - Web route for change detail page
- Diff is included in change detail response

### File Locations
[Source: docs/architecture/unified-project-structure.md]

Files to update:
- `admin-ui/templates/pages/changes/detail.html` - Change detail page template
- `admin-ui/static/js/diff.js` - Diff formatting JavaScript (create or update)
- `admin-ui/static/css/diff.css` - Diff styling CSS (create or update)

Files to create:
- `api/routes/api.py` - Update with download endpoint (if not exists)

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Frontend:**
- Use Jinja2 templates for server-side rendering
- Use Tailwind CSS for styling
- Use vanilla JavaScript for client-side interactions
- Follow existing UI patterns

**Performance:**
- Optimize for large diffs (10,000+ lines)
- Use efficient DOM manipulation
- Consider virtual scrolling if needed

### Tech Stack
[Source: docs/architecture/tech-stack.md]

**Frontend Technology:**
- Jinja2 templates
- Tailwind CSS
- Vanilla JavaScript
- Optional: Prism.js or Highlight.js for syntax highlighting

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Manual Testing:**
- Test with various diff sizes
- Test all view options and features
- Test on desktop and tablet
- Verify performance with large diffs

### Technical Constraints
- Must remain text-based (no AI interpretation)
- Performance target: < 2 seconds for large diffs
- Responsive design required (desktop and tablet)
- Must work with existing diff format (unified diff)

## Testing

**Manual Testing:**
- Test with small diffs (< 100 lines)
- Test with medium diffs (100-1000 lines)
- Test with large diffs (1000-10000 lines)
- Test with very large diffs (10000+ lines)
- Test all view options (unified, side-by-side)
- Test all features (pagination, collapsible sections, jump to changes)
- Test export options (download, copy to clipboard)
- Test responsive design (desktop and tablet)
- Verify performance (< 2 seconds for large diffs)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

