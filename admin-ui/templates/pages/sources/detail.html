{% extends "base.html" %}

{% block title %}Source Details - Policy Aggregator Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Actions -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Source Details</h1>
        <div class="flex space-x-3">
            <a href="/sources/{{ source.id }}/edit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                Edit
            </a>
            <a href="/sources" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Back to List
            </a>
            <button onclick="deleteSource('{{ source.id }}', '{{ source.country }} - {{ source.visa_type }}')" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                Delete
            </button>
        </div>
    </div>

    <!-- Source Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Source Information</h2>
        <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
                <dt class="text-sm font-medium text-gray-500">Country</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ source.country }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Visa Type</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ source.visa_type }}</dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">URL</dt>
                <dd class="mt-1 text-sm text-gray-900">
                    <a href="{{ source.url }}" target="_blank" class="text-indigo-600 hover:text-indigo-900">
                        {{ source.url }}
                    </a>
                </dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Name</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ source.name }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Fetch Type</dt>
                <dd class="mt-1 text-sm text-gray-900 uppercase">{{ source.fetch_type }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Check Frequency</dt>
                <dd class="mt-1 text-sm text-gray-900 capitalize">{{ source.check_frequency }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Status</dt>
                <dd class="mt-1">
                    {% if source.status == 'active' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                    {% elif source.status == 'error' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Error</span>
                    {% elif source.status == 'never_checked' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Never Checked</span>
                    {% elif source.status == 'stale' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Stale</span>
                    {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>
                    {% endif %}
                </dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Active</dt>
                <dd class="mt-1">
                    {% if source.is_active %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yes</span>
                    {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">No</span>
                    {% endif %}
                </dd>
            </div>
        </dl>
    </div>

    <!-- Source Status -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Status Information</h2>
        <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
                <dt class="text-sm font-medium text-gray-500">Last Checked</dt>
                <dd class="mt-1 text-sm text-gray-900">
                    {% if source.last_checked_at %}
                        {{ source.last_checked_at[:19]|replace('T', ' ') }}
                    {% else %}
                        Never
                    {% endif %}
                </dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Last Change Detected</dt>
                <dd class="mt-1 text-sm text-gray-900">
                    {% if source.last_change_detected_at %}
                        {{ source.last_change_detected_at[:19]|replace('T', ' ') }}
                    {% else %}
                        Never
                    {% endif %}
                </dd>
            </div>
            {% if source.status == 'error' %}
            <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Error Count</dt>
                <dd class="mt-1 text-sm text-red-600">
                    {% if source.consecutive_fetch_failures %}
                        {{ source.consecutive_fetch_failures }} consecutive failure(s)
                    {% else %}
                        No errors
                    {% endif %}
                </dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Recent Changes -->
    {% if recent_changes %}
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Changes</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detected At</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for change in recent_changes %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ change.detected_at[:19]|replace('T', ' ') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="/changes/{{ change.id }}" class="text-indigo-600 hover:text-indigo-900">View Details</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Changes</h2>
        <p class="text-sm text-gray-500">No changes detected yet for this source.</p>
    </div>
    {% endif %}

    <!-- Trigger Fetch Button (for Story 4.7) -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions</h2>
        <button id="triggerFetchBtn" onclick="triggerSourceFetch('{{ source.id }}')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            Trigger Fetch
        </button>
    </div>
</div>

<!-- Error/Success Messages -->
<div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

<script src="/static/js/sources.js"></script>
<script>
// Trigger source fetch (placeholder for Story 4.7)
function triggerSourceFetch(sourceId) {
    alert('Trigger fetch functionality will be implemented in Story 4.7');
}
</script>
{% endblock %}

