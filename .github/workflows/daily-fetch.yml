name: Daily Fetch Job

on:
  schedule:
    # Run daily at 2 AM UTC
    # Cron syntax: minute hour day month day-of-week
    # This runs at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  daily-fetch:
    name: Run Daily Fetch Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout after 30 minutes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run daily fetch job
      env:
        # Required environment variables from GitHub Secrets
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        JWT_ALGORITHM: HS256
        JWT_EXPIRE_HOURS: 24
        
        # Optional environment variables
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        EMAIL_FROM_ADDRESS: ${{ secrets.EMAIL_FROM_ADDRESS || 'alerts@policyaggregator.com' }}
        ADMIN_UI_URL: ${{ secrets.ADMIN_UI_URL || 'http://localhost:9000' }}
        
        # Application configuration
        ENVIRONMENT: production
        LOG_LEVEL: INFO
        
        # CORS configuration (not needed for script execution, but set for consistency)
        CORS_ORIGINS: ${{ secrets.CORS_ORIGINS || 'http://localhost:8000' }}
        CORS_ALLOW_CREDENTIALS: true
      run: |
        echo "=========================================="
        echo "Starting Daily Fetch Job"
        echo "=========================================="
        echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        
        # Run the daily fetch job script
        python scripts/run_daily_fetch_job.py
        
        EXIT_CODE=$?
        
        echo ""
        echo "=========================================="
        echo "Daily Fetch Job Completed"
        echo "Exit Code: $EXIT_CODE"
        echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "=========================================="
        
        # Exit with the script's exit code
        exit $EXIT_CODE
    
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const workflowRunUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          const workflowRunName = '${{ github.workflow }}';
          const commitSha = '${{ github.sha }}';
          const commitMessage = '${{ github.event.head_commit.message }}' || 'N/A';
          
          // Create issue comment or log notification
          core.error(`‚ùå Daily Fetch Job Failed`);
          core.error(`Workflow: ${workflowRunName}`);
          core.error(`Run URL: ${workflowRunUrl}`);
          core.error(`Commit: ${commitSha.substring(0, 7)} - ${commitMessage}`);
          core.error(`Please check the workflow logs for details.`);
          
          // Note: For email/Slack notifications, configure them in repository settings
          // GitHub Actions will send email notifications to repository admins on failure
          // if email notifications are enabled in repository settings.

